{% extends "admin_base.html" %}

{% block title %}Job Tracking & Payment Management - SPANKKS Construction{% endblock %}

{% block extra_css %}
<style>
.tracking-container {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 1.5rem;
    height: calc(100vh - 140px);
}

.tracking-main {
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.tracking-sidebar {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    overflow-y: auto;
}

.tracking-tabs {
    display: flex;
    border-bottom: 2px solid #e9ecef;
    margin-bottom: 1.5rem;
}

.tracking-tab {
    padding: 1rem 1.5rem;
    background: none;
    border: none;
    cursor: pointer;
    color: #6c757d;
    font-weight: 500;
    transition: all 0.2s ease;
    border-bottom: 2px solid transparent;
}

.tracking-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
}

.tracking-content {
    flex: 1;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    overflow-y: auto;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.stat-card.secondary {
    background: linear-gradient(135deg, #28a745, #1e7e34);
}

.stat-card.warning {
    background: linear-gradient(135deg, #ffc107, #e0a800);
    color: #000;
}

.stat-card.danger {
    background: linear-gradient(135deg, #dc3545, #c82333);
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    opacity: 0.9;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
}

.data-table th,
.data-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.data-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.data-table tr:hover {
    background: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: bold;
    text-transform: uppercase;
}

.status-estimate { background: #ffc107; color: #000; }
.status-in_progress { background: #fd7e14; color: white; }
.status-completed { background: #28a745; color: white; }
.status-paid { background: #20c997; color: white; }
.status-sent { background: #17a2b8; color: white; }
.status-accepted { background: #007bff; color: white; }
.status-declined { background: #dc3545; color: white; }

.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.form-section {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.form-section h5 {
    color: #495057;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
}

.quick-action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.quick-action-card {
    background: white;
    border: 2px solid #007bff;
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.quick-action-card:hover {
    background: #007bff;
    color: white;
    transform: translateY(-2px);
}

.job-details-panel {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.payment-method-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.payment-method-btn {
    padding: 0.5rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
    font-size: 0.875rem;
}

.payment-method-btn.active {
    border-color: #007bff;
    background: #007bff;
    color: white;
}

.materials-list {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 1rem;
}

.material-item {
    display: flex;
    justify-content: between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.material-item:last-child {
    border-bottom: none;
}

.progress-indicator {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-bar {
    height: 100%;
    background: #007bff;
    transition: width 0.3s ease;
}

.filter-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.search-box {
    flex: 1;
    min-width: 200px;
}

.date-range {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.outstanding-balance {
    color: #dc3545;
    font-weight: bold;
}

.profit-positive {
    color: #28a745;
    font-weight: bold;
}

.profit-negative {
    color: #dc3545;
    font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">
            <i class="fas fa-clipboard-list me-2"></i>Job Tracking & Payment Management
        </h1>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-success" onclick="showNewJobForm()">
                <i class="fas fa-plus me-1"></i>New Job Record
            </button>
            <button type="button" class="btn btn-primary" onclick="showNewQuoteForm()">
                <i class="fas fa-file-invoice me-1"></i>New Quote
            </button>
            <button type="button" class="btn btn-warning" onclick="showPaymentForm()">
                <i class="fas fa-money-bill me-1"></i>Log Payment
            </button>
        </div>
    </div>

    <!-- Statistics Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ reporting_data.total_jobs or 0 }}</div>
            <div class="stat-label">Total Jobs</div>
        </div>
        <div class="stat-card secondary">
            <div class="stat-number">${{ "%.0f"|format(reporting_data.total_actual_revenue or 0) }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-number">${{ "%.0f"|format(reporting_data.outstanding_balances or 0) }}</div>
            <div class="stat-label">Outstanding Balance</div>
        </div>
        <div class="stat-card {% if reporting_data.profit_margin > 0 %}secondary{% else %}danger{% endif %}">
            <div class="stat-number">{{ "%.1f"|format(reporting_data.profit_margin or 0) }}%</div>
            <div class="stat-label">Profit Margin</div>
        </div>
    </div>

    <!-- Main Tracking Container -->
    <div class="tracking-container">
        <div class="tracking-main">
            <!-- Tab Navigation -->
            <div class="tracking-tabs">
                <button class="tracking-tab active" data-tab="jobs">Job Records</button>
                <button class="tracking-tab" data-tab="quotes">Quote History</button>
                <button class="tracking-tab" data-tab="payments">Payment Logs</button>
                <button class="tracking-tab" data-tab="materials">Materials & Labor</button>
                <button class="tracking-tab" data-tab="reports">Reports</button>
            </div>

            <!-- Tab Content -->
            <div class="tracking-content">
                <!-- Job Records Tab -->
                <div id="jobs-tab" class="tab-content active">
                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <input type="text" class="form-control search-box" placeholder="Search jobs..." id="job-search">
                        <select class="form-select" id="job-status-filter" style="width: auto;">
                            <option value="">All Statuses</option>
                            <option value="estimate">Estimate</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="paid">Paid</option>
                        </select>
                        <div class="date-range">
                            <input type="date" class="form-control" id="job-start-date">
                            <span>to</span>
                            <input type="date" class="form-control" id="job-end-date">
                        </div>
                    </div>

                    <!-- Jobs Table -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Client</th>
                                <th>Service Type</th>
                                <th>Estimated Cost</th>
                                <th>Actual Cost</th>
                                <th>Outstanding</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="jobs-table-body">
                            {% for job in job_records %}
                            <tr>
                                <td><strong>{{ job.job_id }}</strong></td>
                                <td>
                                    <div>{{ job.client_name }}</div>
                                    <small class="text-muted">{{ job.client_phone }}</small>
                                </td>
                                <td>{{ job.service_type }}</td>
                                <td>${{ "%.2f"|format(job.estimated_cost) }}</td>
                                <td>${{ "%.2f"|format(job.actual_cost) }}</td>
                                <td class="{% if job.outstanding_balance > 0 %}outstanding-balance{% endif %}">
                                    ${{ "%.2f"|format(job.outstanding_balance) }}
                                </td>
                                <td>
                                    <span class="status-badge status-{{ job.status }}">{{ job.status }}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewJobDetails('{{ job.job_id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" onclick="logPaymentForJob('{{ job.job_id }}')">
                                            <i class="fas fa-dollar-sign"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" onclick="logMaterialsForJob('{{ job.job_id }}')">
                                            <i class="fas fa-boxes"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Quote History Tab -->
                <div id="quotes-tab" class="tab-content" style="display: none;">
                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <input type="text" class="form-control search-box" placeholder="Search quotes..." id="quote-search">
                        <select class="form-select" id="quote-status-filter" style="width: auto;">
                            <option value="">All Statuses</option>
                            <option value="sent">Sent</option>
                            <option value="pending">Pending</option>
                            <option value="accepted">Accepted</option>
                            <option value="declined">Declined</option>
                        </select>
                    </div>

                    <!-- Quotes Table -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Quote ID</th>
                                <th>Job ID</th>
                                <th>Client</th>
                                <th>Service Type</th>
                                <th>Total Amount</th>
                                <th>Date Sent</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for quote in quote_history %}
                            <tr>
                                <td><strong>{{ quote.quote_id }}</strong></td>
                                <td>{{ quote.job_id }}</td>
                                <td>
                                    <div>{{ quote.client_name }}</div>
                                    <small class="text-muted">{{ quote.client_phone }}</small>
                                </td>
                                <td>{{ quote.service_type }}</td>
                                <td>${{ "%.2f"|format(quote.total_amount) }}</td>
                                <td>{{ quote.date_sent[:10] }}</td>
                                <td>
                                    <span class="status-badge status-{{ quote.quote_status }}">{{ quote.quote_status }}</span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewQuoteDetails('{{ quote.quote_id }}')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if quote.quote_status == 'sent' %}
                                        <button class="btn btn-sm btn-outline-success" onclick="acceptQuote('{{ quote.quote_id }}')">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Payment Logs Tab -->
                <div id="payments-tab" class="tab-content" style="display: none;">
                    <!-- Filter Controls -->
                    <div class="filter-controls">
                        <input type="text" class="form-control search-box" placeholder="Search payments..." id="payment-search">
                        <select class="form-select" id="payment-method-filter" style="width: auto;">
                            <option value="">All Methods</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="venmo">Venmo</option>
                            <option value="zelle">Zelle</option>
                        </select>
                    </div>

                    <!-- Payments Table -->
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Payment ID</th>
                                <th>Job ID</th>
                                <th>Client</th>
                                <th>Amount</th>
                                <th>Method</th>
                                <th>Date Received</th>
                                <th>Reference</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for payment in payment_logs %}
                            <tr>
                                <td><strong>{{ payment.payment_id }}</strong></td>
                                <td>{{ payment.job_id }}</td>
                                <td>{{ payment.client_name }}</td>
                                <td class="text-success"><strong>${{ "%.2f"|format(payment.payment_amount) }}</strong></td>
                                <td>
                                    <span class="badge bg-secondary">{{ payment.payment_method }}</span>
                                </td>
                                <td>{{ payment.date_received[:10] }}</td>
                                <td>{{ payment.reference_number or '-' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewPaymentDetails('{{ payment.payment_id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Materials & Labor Tab -->
                <div id="materials-tab" class="tab-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Recent Materials</h5>
                            <div class="materials-list">
                                <div class="text-center text-muted">
                                    <i class="fas fa-boxes fa-2x mb-3"></i>
                                    <p>Materials tracking will be displayed here</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Labor Logs</h5>
                            <div class="materials-list">
                                <div class="text-center text-muted">
                                    <i class="fas fa-hard-hat fa-2x mb-3"></i>
                                    <p>Labor tracking will be displayed here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-content" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-section">
                                <h5>Job Status Breakdown</h5>
                                <div id="status-chart">
                                    {% for status, count in reporting_data.status_breakdown.items() %}
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>{{ status.title().replace('_', ' ') }}</span>
                                        <strong>{{ count }}</strong>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-section">
                                <h5>Payment Methods</h5>
                                <div id="payment-method-chart">
                                    {% for method, count in reporting_data.payment_method_breakdown.items() %}
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>{{ method.title() }}</span>
                                        <strong>{{ count }}</strong>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <h5>Key Metrics</h5>
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4">{{ "%.1f"|format(reporting_data.completion_rate or 0) }}%</div>
                                    <small class="text-muted">Completion Rate</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4">${{ "%.0f"|format(reporting_data.average_job_value or 0) }}</div>
                                    <small class="text-muted">Average Job Value</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4">{{ "%.1f"|format(reporting_data.quote_conversion_rate or 0) }}%</div>
                                    <small class="text-muted">Quote Conversion</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h4 {% if reporting_data.profit_margin > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        {{ "%.1f"|format(reporting_data.profit_margin or 0) }}%
                                    </div>
                                    <small class="text-muted">Profit Margin</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar - Quick Actions -->
        <div class="tracking-sidebar">
            <h5 class="mb-3">
                <i class="fas fa-bolt me-2"></i>Quick Actions
            </h5>
            
            <div class="quick-action-grid">
                <div class="quick-action-card" onclick="showNewJobForm()">
                    <i class="fas fa-plus fa-2x mb-2"></i>
                    <div>New Job</div>
                </div>
                <div class="quick-action-card" onclick="showNewQuoteForm()">
                    <i class="fas fa-file-invoice fa-2x mb-2"></i>
                    <div>New Quote</div>
                </div>
                <div class="quick-action-card" onclick="showPaymentForm()">
                    <i class="fas fa-money-bill fa-2x mb-2"></i>
                    <div>Log Payment</div>
                </div>
                <div class="quick-action-card" onclick="showMaterialsForm()">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <div>Log Materials</div>
                </div>
                <div class="quick-action-card" onclick="showLaborForm()">
                    <i class="fas fa-hard-hat fa-2x mb-2"></i>
                    <div>Log Labor</div>
                </div>
                <div class="quick-action-card" onclick="exportReports()">
                    <i class="fas fa-download fa-2x mb-2"></i>
                    <div>Export Data</div>
                </div>
            </div>

            <div class="mt-4">
                <h6>Today's Summary</h6>
                <div class="small text-muted">
                    <div>Jobs: {{ job_records|length }}</div>
                    <div>Quotes: {{ quote_history|length }}</div>
                    <div>Payments: {{ payment_logs|length }}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Forms -->
{% include 'admin/modals/new_job_modal.html' %}
{% include 'admin/modals/new_quote_modal.html' %}
{% include 'admin/modals/payment_modal.html' %}
{% include 'admin/modals/materials_modal.html' %}
{% include 'admin/modals/labor_modal.html' %}

<script>
// Tab functionality
document.querySelectorAll('.tracking-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const targetTab = this.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tracking-tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
        });
        document.getElementById(targetTab + '-tab').style.display = 'block';
    });
});

// Filter functionality
document.getElementById('job-search').addEventListener('input', filterJobs);
document.getElementById('job-status-filter').addEventListener('change', filterJobs);

function filterJobs() {
    const searchTerm = document.getElementById('job-search').value.toLowerCase();
    const statusFilter = document.getElementById('job-status-filter').value;
    const rows = document.querySelectorAll('#jobs-table-body tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const status = row.querySelector('.status-badge').textContent.trim();
        
        const matchesSearch = text.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// Quick action functions
function showNewJobForm() {
    const modal = new bootstrap.Modal(document.getElementById('newJobModal'));
    modal.show();
}

function showNewQuoteForm() {
    const modal = new bootstrap.Modal(document.getElementById('newQuoteModal'));
    modal.show();
}

function showPaymentForm() {
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function showMaterialsForm() {
    const modal = new bootstrap.Modal(document.getElementById('materialsModal'));
    modal.show();
}

function showLaborForm() {
    const modal = new bootstrap.Modal(document.getElementById('laborModal'));
    modal.show();
}

function viewJobDetails(jobId) {
    fetch(`/api/job-tracking/job-summary/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showJobDetailsModal(data);
            } else {
                alert('Error loading job details: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading job details');
        });
}

function logPaymentForJob(jobId) {
    document.getElementById('payment-job-id').value = jobId;
    showPaymentForm();
}

function logMaterialsForJob(jobId) {
    document.getElementById('materials-job-id').value = jobId;
    showMaterialsForm();
}

function showJobDetailsModal(data) {
    // Create and show job details modal
    const modalHtml = `
        <div class="modal fade" id="jobDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Job Details - ${data.job.job_id}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Client Information</h6>
                                <p><strong>Name:</strong> ${data.job.client_name}</p>
                                <p><strong>Phone:</strong> ${data.job.client_phone}</p>
                                <p><strong>Email:</strong> ${data.job.client_email}</p>
                                <p><strong>Address:</strong> ${data.job.client_address}</p>
                            </div>
                            <div class="col-md-6">
                                <h6>Job Information</h6>
                                <p><strong>Service:</strong> ${data.job.service_type}</p>
                                <p><strong>Status:</strong> <span class="status-badge status-${data.job.status}">${data.job.status}</span></p>
                                <p><strong>Estimated Cost:</strong> $${data.job.estimated_cost.toFixed(2)}</p>
                                <p><strong>Actual Cost:</strong> $${data.job.actual_cost.toFixed(2)}</p>
                                <p><strong>Outstanding:</strong> $${data.job.outstanding_balance.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <h6>Payments (${data.payments.length})</h6>
                                ${data.payments.map(p => `
                                    <div class="small border-bottom py-1">
                                        $${p.payment_amount.toFixed(2)} - ${p.payment_method} - ${p.date_received.split('T')[0]}
                                    </div>
                                `).join('')}
                            </div>
                            <div class="col-md-6">
                                <h6>Summary</h6>
                                <p><strong>Profit Margin:</strong> ${data.job.profit_margin.toFixed(1)}%</p>
                                <p><strong>Material Costs:</strong> $${data.summary.material_costs.toFixed(2)}</p>
                                <p><strong>Labor Costs:</strong> $${data.summary.labor_costs.toFixed(2)}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('jobDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
    modal.show();
}

function exportReports() {
    window.open('/api/job-tracking/reporting?format=export', '_blank');
}

// Auto-refresh data every 5 minutes
setInterval(() => {
    location.reload();
}, 300000);
</script>
{% endblock %}