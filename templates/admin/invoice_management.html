{% extends "admin_base.html" %}

{% block title %}Invoice Management - SPANKKS Construction{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Invoice Management</h2>
        <div>
            <button class="btn btn-primary me-2" onclick="generateInvoice()">
                <i class="fas fa-plus me-2"></i>New Invoice
            </button>
            <button class="btn btn-success" onclick="bulkActions()">
                <i class="fas fa-list me-2"></i>Bulk Actions
            </button>
        </div>
    </div>
    
    <!-- Invoice Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Status</label>
                    <select class="form-control" id="statusFilter" onchange="filterInvoices()">
                        <option value="">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Date Range</label>
                    <select class="form-control" id="dateFilter" onchange="filterInvoices()">
                        <option value="">All Time</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="this_year">This Year</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Search Customer</label>
                    <input type="text" class="form-control" id="customerSearch" 
                           placeholder="Search by customer name or email" onkeyup="filterInvoices()">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                        <i class="fas fa-times me-2"></i>Clear
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Invoice Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="invoiceTable">
                    <thead>
                        <tr>
                            <th>
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Invoice #</th>
                            <th>Customer</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for invoice in invoices %}
                        <tr data-status="{{ invoice.status }}" data-customer="{{ invoice.customer_name|lower }}">
                            <td>
                                <input type="checkbox" class="invoice-select" value="{{ invoice.id }}">
                            </td>
                            <td>
                                <strong>{{ invoice.invoice_number or invoice.id }}</strong>
                            </td>
                            <td>
                                <div>{{ invoice.customer_name }}</div>
                                <small class="text-muted">{{ invoice.customer_email }}</small>
                            </td>
                            <td>
                                <strong>${{ "%.2f"|format(invoice.total_amount|float) }}</strong>
                            </td>
                            <td>
                                {% set status_class = 'success' if invoice.status == 'paid' else 'warning' if invoice.status == 'unpaid' else 'danger' %}
                                <span class="badge bg-{{ status_class }}">{{ invoice.status|title }}</span>
                            </td>
                            <td>
                                {{ invoice.due_date }}
                                {% if invoice.status == 'unpaid' and invoice.due_date %}
                                    {% set due_date = moment(invoice.due_date) %}
                                    {% if due_date.isBefore(moment()) %}
                                        <br><small class="text-danger">Overdue</small>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>{{ invoice.created_date }}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewInvoice('{{ invoice.id }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="downloadInvoice('{{ invoice.id }}')">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="markPaid('{{ invoice.id }}')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-outline-info" onclick="sendReminder('{{ invoice.id }}')">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Actions Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceModalBody">
                <!-- Invoice details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printInvoice()">Print</button>
            </div>
        </div>
    </div>
</div>

<script>
function filterInvoices() {
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const customerSearch = document.getElementById('customerSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#invoiceTable tbody tr');
    
    rows.forEach(row => {
        const status = row.dataset.status.toLowerCase();
        const customer = row.dataset.customer;
        
        const statusMatch = !statusFilter || status === statusFilter;
        const customerMatch = !customerSearch || customer.includes(customerSearch);
        
        row.style.display = statusMatch && customerMatch ? '' : 'none';
    });
}

function clearFilters() {
    document.getElementById('statusFilter').value = '';
    document.getElementById('customerSearch').value = '';
    document.getElementById('dateFilter').value = '';
    filterInvoices();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.invoice-select');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function generateInvoice() {
    window.location.href = '/admin/quote-builder?mode=invoice';
}

function viewInvoice(invoiceId) {
    fetch(`/api/invoices/${invoiceId}`)
    .then(response => response.json())
    .then(data => {
        document.getElementById('invoiceModalBody').innerHTML = `
            <div class="invoice-preview">
                <h4>Invoice #${data.invoice_number}</h4>
                <p><strong>Customer:</strong> ${data.customer_name}</p>
                <p><strong>Amount:</strong> $${data.total_amount}</p>
                <p><strong>Status:</strong> ${data.status}</p>
                <p><strong>Due Date:</strong> ${data.due_date}</p>
            </div>
        `;
        new bootstrap.Modal(document.getElementById('invoiceModal')).show();
    });
}

function downloadInvoice(invoiceId) {
    window.open(`/api/download-invoice?invoice_id=${invoiceId}`, '_blank');
}

function markPaid(invoiceId) {
    if (confirm('Mark this invoice as paid?')) {
        fetch('/api/invoices/mark-paid', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({invoice_id: invoiceId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function sendReminder(invoiceId) {
    fetch('/api/invoices/send-reminder', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({invoice_id: invoiceId})
    })
    .then(response => response.json())
    .then(data => {
        alert(data.success ? 'Reminder sent successfully!' : 'Error: ' + data.error);
    });
}

function bulkActions() {
    const selected = Array.from(document.querySelectorAll('.invoice-select:checked')).map(cb => cb.value);
    
    if (selected.length === 0) {
        alert('Please select invoices first');
        return;
    }
    
    const action = prompt('Enter action (mark-paid, send-reminder, export):');
    if (action) {
        fetch('/api/invoices/bulk-action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({invoice_ids: selected, action: action})
        })
        .then(response => response.json())
        .then(data => {
            alert(data.success ? 'Bulk action completed!' : 'Error: ' + data.error);
            if (data.success) location.reload();
        });
    }
}

function printInvoice() {
    window.print();
}
</script>
{% endblock %}