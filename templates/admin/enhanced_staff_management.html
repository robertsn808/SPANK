<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Staff Management - SPANKKS Construction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .dashboard-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }
        
        .staff-card {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .staff-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .skill-badge {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            margin: 2px;
            display: inline-block;
        }
        
        .availability-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        
        .available { background: #4caf50; }
        .busy { background: #ff9800; }
        .unavailable { background: #f44336; }
        
        .performance-meter {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        
        .performance-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .performance-excellent { background: #4caf50; }
        .performance-good { background: #8bc34a; }
        .performance-average { background: #ffc107; }
        .performance-poor { background: #ff5722; }
        
        .tab-content {
            margin-top: 20px;
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .schedule-cell {
            background: white;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        .schedule-header {
            background: #1976d2;
            color: white;
            font-weight: 600;
        }
        
        .schedule-time {
            background: #f5f5f5;
            font-weight: 500;
        }
        
        .schedule-available {
            background: #e8f5e8;
            cursor: pointer;
        }
        
        .schedule-booked {
            background: #ffebee;
            color: #c62828;
        }
        
        .modal-lg { max-width: 900px; }
    </style>
</head>
<body>
    {% include 'admin_base.html' %}
    
    <div class="container-fluid">
        <div class="dashboard-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users-cog me-2"></i>Enhanced Staff Management</h2>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" onclick="openAddStaffModal()">
                        <i class="fas fa-user-plus me-2"></i>Add Staff Member
                    </button>
                    <button class="btn btn-primary" onclick="openBulkScheduleModal()">
                        <i class="fas fa-calendar-alt me-2"></i>Bulk Schedule
                    </button>
                    <button class="btn btn-info" onclick="generateStaffReport()">
                        <i class="fas fa-chart-bar me-2"></i>Performance Report
                    </button>
                </div>
            </div>
            
            <!-- Staff Overview Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">Available Now</h5>
                            <h3 id="availableCount">0</h3>
                            <small class="text-muted">Ready for assignment</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">On Assignment</h5>
                            <h3 id="busyCount">0</h3>
                            <small class="text-muted">Currently working</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-info">Total Staff</h5>
                            <h3 id="totalStaff">0</h3>
                            <small class="text-muted">Active employees</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">Avg Performance</h5>
                            <h3 id="avgPerformance">95%</h3>
                            <small class="text-muted">This month</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Staff Management Tabs -->
            <ul class="nav nav-tabs" id="staffTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                        <i class="fas fa-th-large me-2"></i>Staff Overview
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                        <i class="fas fa-calendar-week me-2"></i>Schedule Management
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="skills-tab" data-bs-toggle="tab" data-bs-target="#skills" type="button" role="tab">
                        <i class="fas fa-tools me-2"></i>Skills & Training
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                        <i class="fas fa-chart-line me-2"></i>Performance Analytics
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="staffTabsContent">
                <!-- Staff Overview Tab -->
                <div class="tab-pane fade show active" id="overview" role="tabpanel">
                    <div id="staffList">
                        <!-- Staff cards will be loaded here -->
                    </div>
                </div>
                
                <!-- Schedule Management Tab -->
                <div class="tab-pane fade" id="schedule" role="tabpanel">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="scheduleWeek" class="form-label">Select Week</label>
                            <input type="week" class="form-control" id="scheduleWeek" onchange="loadWeeklySchedule()">
                        </div>
                        <div class="col-md-6">
                            <label for="staffFilter" class="form-label">Filter by Staff</label>
                            <select class="form-select" id="staffFilter" onchange="filterSchedule()">
                                <option value="">All Staff Members</option>
                            </select>
                        </div>
                    </div>
                    <div id="weeklySchedule">
                        <!-- Weekly schedule grid will be loaded here -->
                    </div>
                </div>
                
                <!-- Skills & Training Tab -->
                <div class="tab-pane fade" id="skills" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Skill Categories</h5>
                            <div id="skillCategories">
                                <!-- Skill categories will be loaded here -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Training Programs</h5>
                            <div id="trainingPrograms">
                                <!-- Training programs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Analytics Tab -->
                <div class="tab-pane fade" id="performance" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <canvas id="performanceChart" width="400" height="200"></canvas>
                        </div>
                        <div class="col-md-4">
                            <div id="performanceMetrics">
                                <!-- Performance metrics will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div class="modal fade" id="staffModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="staffModalTitle">Add Staff Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="staffForm">
                        <input type="hidden" id="staffId" name="staff_id">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="staffName" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="staffName" name="name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="staffEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="staffEmail" name="email" required>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="staffPhone" class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="staffPhone" name="phone" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="staffRole" class="form-label">Role</label>
                                <select class="form-select" id="staffRole" name="role" required>
                                    <option value="">Select role</option>
                                    <option value="lead_contractor">Lead Contractor</option>
                                    <option value="general_handyman">General Handyman</option>
                                    <option value="specialist_flooring">Flooring Specialist</option>
                                    <option value="specialist_drywall">Drywall Specialist</option>
                                    <option value="specialist_electrical">Electrical Specialist</option>
                                    <option value="specialist_plumbing">Plumbing Specialist</option>
                                    <option value="apprentice">Apprentice</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="staffHourlyRate" class="form-label">Hourly Rate ($)</label>
                                <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" step="0.01" min="15" max="100">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="staffHireDate" class="form-label">Hire Date</label>
                                <input type="date" class="form-control" id="staffHireDate" name="hire_date">
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="staffSkills" class="form-label">Skills & Certifications</label>
                            <div class="row" id="skillsCheckboxes">
                                <!-- Skills checkboxes will be generated here -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="staffAvailability" class="form-label">Default Availability</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Working Days</label>
                                    <div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="monday" name="working_days" value="monday">
                                            <label class="form-check-label" for="monday">Mon</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="tuesday" name="working_days" value="tuesday">
                                            <label class="form-check-label" for="tuesday">Tue</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="wednesday" name="working_days" value="wednesday">
                                            <label class="form-check-label" for="wednesday">Wed</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="thursday" name="working_days" value="thursday">
                                            <label class="form-check-label" for="thursday">Thu</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="friday" name="working_days" value="friday">
                                            <label class="form-check-label" for="friday">Fri</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="saturday" name="working_days" value="saturday">
                                            <label class="form-check-label" for="saturday">Sat</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="checkbox" id="sunday" name="working_days" value="sunday">
                                            <label class="form-check-label" for="sunday">Sun</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label for="startTime" class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="startTime" name="start_time" value="07:00">
                                </div>
                                <div class="col-md-3">
                                    <label for="endTime" class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="endTime" name="end_time" value="17:00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="staffNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="staffNotes" name="notes" rows="3" placeholder="Emergency contact, special skills, preferences, etc."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveStaffMember()">
                        <i class="fas fa-save me-2"></i>Save Staff Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let allStaff = [];
        
        // Available skills for staff members
        const availableSkills = [
            'General Handyman', 'Drywall Installation', 'Drywall Repair', 'Flooring Installation',
            'Tile Work', 'Hardwood Installation', 'Laminate Installation', 'Basic Electrical',
            'Electrical Installation', 'Basic Plumbing', 'Plumbing Repair', 'Painting',
            'Fence Installation', 'Deck Building', 'Kitchen Installation', 'Bathroom Renovation',
            'HVAC Basic', 'Roofing Basic', 'Power Tools Certified', 'Safety Certified',
            'First Aid Certified', 'Hawaii Contractor License', 'Electrical License',
            'Plumbing License', 'Driver License Commercial'
        ];
        
        // Load staff data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStaffData();
            generateSkillsCheckboxes();
            setCurrentWeek();
        });
        
        async function loadStaffData() {
            try {
                const response = await fetch('/api/staff/enhanced');
                allStaff = await response.json();
                displayStaffOverview();
                updateStaffStats();
                populateStaffFilter();
            } catch (error) {
                console.error('Error loading staff data:', error);
                showAlert('Error loading staff data', 'danger');
            }
        }
        
        function displayStaffOverview() {
            const container = document.getElementById('staffList');
            
            if (allStaff.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-users fa-3x mb-3"></i><p>No staff members found</p></div>';
                return;
            }
            
            container.innerHTML = allStaff.map(staff => `
                <div class="staff-card">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="availability-indicator ${staff.availability_status || 'available'}"></div>
                                <div>
                                    <h6 class="mb-1">${staff.name}</h6>
                                    <small class="text-muted">${staff.role.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Hourly Rate</small><br>
                            <strong>$${staff.hourly_rate || '25.00'}/hr</strong>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Skills</small><br>
                            <div>
                                ${(staff.skills || []).slice(0, 3).map(skill => 
                                    `<span class="skill-badge">${skill}</span>`
                                ).join('')}
                                ${(staff.skills || []).length > 3 ? `<span class="skill-badge">+${(staff.skills || []).length - 3} more</span>` : ''}
                            </div>
                        </div>
                        <div class="col-md-2">
                            <small class="text-muted">Performance</small><br>
                            <div class="performance-meter">
                                <div class="performance-fill performance-excellent" style="width: ${staff.performance_score || 95}%"></div>
                            </div>
                            <small>${staff.performance_score || 95}%</small>
                        </div>
                        <div class="col-md-2">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editStaff('${staff.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-info" onclick="viewStaffSchedule('${staff.id}')">
                                    <i class="fas fa-calendar"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="assignToJob('${staff.id}')">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function updateStaffStats() {
            const available = allStaff.filter(staff => staff.availability_status === 'available').length;
            const busy = allStaff.filter(staff => staff.availability_status === 'busy').length;
            const total = allStaff.length;
            const avgPerformance = allStaff.reduce((sum, staff) => sum + (staff.performance_score || 95), 0) / total;
            
            document.getElementById('availableCount').textContent = available;
            document.getElementById('busyCount').textContent = busy;
            document.getElementById('totalStaff').textContent = total;
            document.getElementById('avgPerformance').textContent = Math.round(avgPerformance) + '%';
        }
        
        function generateSkillsCheckboxes() {
            const container = document.getElementById('skillsCheckboxes');
            container.innerHTML = availableSkills.map((skill, index) => `
                <div class="col-md-4 mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="skill_${index}" name="skills" value="${skill}">
                        <label class="form-check-label" for="skill_${index}">${skill}</label>
                    </div>
                </div>
            `).join('');
        }
        
        function openAddStaffModal() {
            document.getElementById('staffModalTitle').textContent = 'Add Staff Member';
            document.getElementById('staffForm').reset();
            document.getElementById('staffId').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('staffModal'));
            modal.show();
        }
        
        async function saveStaffMember() {
            const form = document.getElementById('staffForm');
            const formData = new FormData(form);
            
            // Collect selected skills
            const skills = Array.from(document.querySelectorAll('input[name="skills"]:checked')).map(cb => cb.value);
            formData.append('skills', JSON.stringify(skills));
            
            // Collect working days
            const workingDays = Array.from(document.querySelectorAll('input[name="working_days"]:checked')).map(cb => cb.value);
            formData.append('working_days', JSON.stringify(workingDays));
            
            try {
                const response = await fetch('/api/staff/save', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Staff member saved successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('staffModal')).hide();
                    loadStaffData();
                } else {
                    throw new Error(result.error || 'Failed to save staff member');
                }
            } catch (error) {
                console.error('Error saving staff member:', error);
                showAlert('Error: ' + error.message, 'danger');
            }
        }
        
        function setCurrentWeek() {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const year = startOfWeek.getFullYear();
            const month = String(startOfWeek.getMonth() + 1).padStart(2, '0');
            const day = String(startOfWeek.getDate()).padStart(2, '0');
            
            document.getElementById('scheduleWeek').value = `${year}-W${getWeekNumber(startOfWeek)}`;
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function populateStaffFilter() {
            const select = document.getElementById('staffFilter');
            select.innerHTML = '<option value="">All Staff Members</option>' +
                allStaff.map(staff => `<option value="${staff.id}">${staff.name}</option>`).join('');
        }
        
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.querySelector('.dashboard-container').prepend(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Placeholder functions for additional features
        function editStaff(staffId) {
            showAlert('Edit staff functionality will be implemented', 'info');
        }
        
        function viewStaffSchedule(staffId) {
            showAlert('Staff schedule view will be implemented', 'info');
        }
        
        function assignToJob(staffId) {
            showAlert('Job assignment functionality will be implemented', 'info');
        }
        
        function openBulkScheduleModal() {
            showAlert('Bulk scheduling functionality will be implemented', 'info');
        }
        
        function generateStaffReport() {
            showAlert('Staff performance reporting will be implemented', 'info');
        }
        
        function loadWeeklySchedule() {
            showAlert('Weekly schedule loading will be implemented', 'info');
        }
        
        function filterSchedule() {
            showAlert('Schedule filtering will be implemented', 'info');
        }
    </script>
</body>
</html>