{% extends "admin_base.html" %}

{% block title %}Enhanced Quote Builder - SPANKKS Construction{% endblock %}

{% block extra_css %}
<style>
.quote-builder-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.line-item-row {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    padding: 15px;
    position: relative;
}

.line-item-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 10px;
}

.item-number {
    background: #28a745;
    color: white;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.remove-item-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.quote-summary {
    background: #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
    position: sticky;
    top: 20px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    padding: 5px 0;
}

.summary-row.total {
    border-top: 2px solid #28a745;
    font-weight: bold;
    font-size: 1.1em;
    color: #28a745;
}

.add-item-btn {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-size: 16px;
    cursor: pointer;
    width: 100%;
    margin-top: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.quick-service-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    margin-bottom: 20px;
}

.quick-service-btn {
    background: #6c757d;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.quick-service-btn:hover {
    background: #5a6268;
}

.client-selector {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 120px 120px;
    gap: 15px;
    align-items: end;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .line-item-header {
        flex-direction: column;
        gap: 10px;
    }
    
    .quick-service-buttons {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="quote-builder-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-invoice-dollar"></i> Enhanced Quote Builder</h2>
        <div>
            <button type="button" class="btn btn-outline-secondary me-2" onclick="saveAsDraft()">
                <i class="fas fa-save"></i> Save Draft
            </button>
            <button type="button" class="btn btn-success" onclick="generateQuote()">
                <i class="fas fa-file-pdf"></i> Generate Quote
            </button>
        </div>
    </div>

    <!-- Client Selection -->
    <div class="client-selector">
        <h5><i class="fas fa-user"></i> Client Information</h5>
        <div class="row">
            <div class="col-md-6">
                <label class="form-label">Select Existing Client:</label>
                <select class="form-select" id="existingClient" onchange="loadClientInfo()">
                    <option value="">-- New Client --</option>
                    {% for contact in contacts %}
                    <option value="{{ contact.id }}" 
                            data-name="{{ contact.name }}" 
                            data-phone="{{ contact.phone }}" 
                            data-email="{{ contact.email }}" 
                            data-address="{{ contact.address }}">
                        {{ contact.name }} - {{ contact.phone }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Project Name:</label>
                <input type="text" class="form-control" id="projectName" 
                       placeholder="e.g., Kitchen Renovation, Bathroom Drywall">
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-3">
                <label class="form-label">Client Name:</label>
                <input type="text" class="form-control" id="clientName" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Phone:</label>
                <input type="tel" class="form-control" id="clientPhone" required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Email:</label>
                <input type="email" class="form-control" id="clientEmail">
            </div>
            <div class="col-md-3">
                <label class="form-label">Job Location:</label>
                <input type="text" class="form-control" id="jobLocation" placeholder="Honolulu, HI">
            </div>
        </div>
    </div>

    <!-- Quick Service Templates -->
    <div class="card mb-4">
        <div class="card-header">
            <h5><i class="fas fa-bolt"></i> Quick Service Templates</h5>
        </div>
        <div class="card-body">
            <div class="quick-service-buttons">
                <button class="quick-service-btn" onclick="addQuickService('drywall_patch')">
                    <i class="fas fa-tools"></i> Drywall Patch ($155)
                </button>
                <button class="quick-service-btn" onclick="addQuickService('flooring_install')">
                    <i class="fas fa-home"></i> Flooring Install ($5/sq ft)
                </button>
                <button class="quick-service-btn" onclick="addQuickService('fence_repair')">
                    <i class="fas fa-border-all"></i> Fence Repair ($45/ft)
                </button>
                <button class="quick-service-btn" onclick="addQuickService('bathroom_renovation')">
                    <i class="fas fa-bath"></i> Bathroom Renovation ($7500)
                </button>
                <button class="quick-service-btn" onclick="addQuickService('kitchen_renovation')">
                    <i class="fas fa-utensils"></i> Kitchen Renovation ($12500)
                </button>
                <button class="quick-service-btn" onclick="addQuickService('custom_service')">
                    <i class="fas fa-plus"></i> Custom Service
                </button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Line Items Container -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Quote Line Items</h5>
                </div>
                <div class="card-body">
                    <div id="lineItemsContainer">
                        <!-- Line items will be added here dynamically -->
                    </div>
                    
                    <button class="add-item-btn" onclick="addLineItem()">
                        <i class="fas fa-plus"></i> Add Line Item
                    </button>
                </div>
            </div>

            <!-- Additional Options -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-cog"></i> Quote Options</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">Valid Until:</label>
                            <input type="date" class="form-control" id="validUntil">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Estimated Start:</label>
                            <input type="date" class="form-control" id="estimatedStart">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Project Duration:</label>
                            <select class="form-select" id="projectDuration">
                                <option value="1-2 days">1-2 days</option>
                                <option value="3-5 days">3-5 days</option>
                                <option value="1-2 weeks">1-2 weeks</option>
                                <option value="2-4 weeks">2-4 weeks</option>
                                <option value="1-2 months">1-2 months</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <label class="form-label">Special Notes / Terms:</label>
                        <textarea class="form-control" id="specialNotes" rows="3" 
                                  placeholder="Any special conditions, material specifications, or project notes..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Quote Summary -->
            <div class="quote-summary">
                <h5><i class="fas fa-calculator"></i> Quote Summary</h5>
                
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotalAmount">$0.00</span>
                </div>
                
                <div class="summary-row">
                    <span>Discount:</span>
                    <div>
                        <input type="number" class="form-control form-control-sm d-inline-block" 
                               id="discountAmount" placeholder="0.00" style="width: 80px;" 
                               onchange="calculateTotals()"> %
                    </div>
                </div>
                
                <div class="summary-row">
                    <span>Hawaii GET (4.712%):</span>
                    <span id="taxAmount">$0.00</span>
                </div>
                
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="totalAmount">$0.00</span>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Hawaii GET tax automatically calculated at 4.712% for O'ahu
                    </small>
                </div>

                <!-- Quick Actions -->
                <div class="mt-4">
                    <h6>Quick Actions:</h6>
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="previewQuote()">
                            <i class="fas fa-eye"></i> Preview Quote
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="scheduleFollowUp()">
                            <i class="fas fa-calendar"></i> Schedule Follow-up
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="copyQuoteLink()">
                            <i class="fas fa-link"></i> Copy Shareable Link
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let lineItemCounter = 0;
const hawaiiTaxRate = 0.04712;

// Service templates
const serviceTemplates = {
    'drywall_patch': {
        description: 'Drywall Patch (Small hole under 12")',
        unit_price: 155.00,
        quantity: 1,
        unit: 'patch'
    },
    'flooring_install': {
        description: 'Flooring Installation',
        unit_price: 5.00,
        quantity: 100,
        unit: 'sq ft'
    },
    'fence_repair': {
        description: 'Fence Repair/Installation',
        unit_price: 45.00,
        quantity: 20,
        unit: 'linear ft'
    },
    'bathroom_renovation': {
        description: 'Complete Bathroom Renovation',
        unit_price: 7500.00,
        quantity: 1,
        unit: 'project'
    },
    'kitchen_renovation': {
        description: 'Complete Kitchen Renovation',
        unit_price: 12500.00,
        quantity: 1,
        unit: 'project'
    },
    'custom_service': {
        description: 'Custom Service',
        unit_price: 0.00,
        quantity: 1,
        unit: 'item'
    }
};

function loadClientInfo() {
    const select = document.getElementById('existingClient');
    const option = select.selectedOptions[0];
    
    if (option.value) {
        document.getElementById('clientName').value = option.dataset.name || '';
        document.getElementById('clientPhone').value = option.dataset.phone || '';
        document.getElementById('clientEmail').value = option.dataset.email || '';
        document.getElementById('jobLocation').value = option.dataset.address || '';
    } else {
        // Clear fields for new client
        document.getElementById('clientName').value = '';
        document.getElementById('clientPhone').value = '';
        document.getElementById('clientEmail').value = '';
        document.getElementById('jobLocation').value = '';
    }
}

function addQuickService(serviceType) {
    const template = serviceTemplates[serviceType];
    if (template) {
        addLineItem(template);
    }
}

function addLineItem(templateData = null) {
    lineItemCounter++;
    
    const container = document.getElementById('lineItemsContainer');
    const lineItem = document.createElement('div');
    lineItem.className = 'line-item-row';
    lineItem.id = `lineItem${lineItemCounter}`;
    
    const data = templateData || {
        description: '',
        unit_price: 0,
        quantity: 1,
        unit: 'item'
    };
    
    lineItem.innerHTML = `
        <div class="line-item-header">
            <div class="item-number">${lineItemCounter}</div>
            <button type="button" class="remove-item-btn" onclick="removeLineItem(${lineItemCounter})">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="form-row">
            <div>
                <label class="form-label">Service Description:</label>
                <input type="text" class="form-control" id="desc${lineItemCounter}" 
                       value="${data.description}" placeholder="Describe the service or materials"
                       onchange="calculateTotals()">
            </div>
            <div>
                <label class="form-label">Quantity:</label>
                <input type="number" class="form-control" id="qty${lineItemCounter}" 
                       value="${data.quantity}" min="0" step="0.1" onchange="calculateTotals()">
            </div>
            <div>
                <label class="form-label">Unit Price:</label>
                <input type="number" class="form-control" id="price${lineItemCounter}" 
                       value="${data.unit_price}" min="0" step="0.01" onchange="calculateTotals()">
            </div>
        </div>
        
        <div class="row mt-2">
            <div class="col-md-6">
                <label class="form-label">Unit Type:</label>
                <select class="form-select" id="unit${lineItemCounter}">
                    <option value="item" ${data.unit === 'item' ? 'selected' : ''}>Item</option>
                    <option value="sq ft" ${data.unit === 'sq ft' ? 'selected' : ''}>Square Feet</option>
                    <option value="linear ft" ${data.unit === 'linear ft' ? 'selected' : ''}>Linear Feet</option>
                    <option value="hour" ${data.unit === 'hour' ? 'selected' : ''}>Hour</option>
                    <option value="day" ${data.unit === 'day' ? 'selected' : ''}>Day</option>
                    <option value="project" ${data.unit === 'project' ? 'selected' : ''}>Project</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Line Total:</label>
                <div class="form-control bg-light" id="lineTotal${lineItemCounter}">$0.00</div>
            </div>
        </div>
    `;
    
    container.appendChild(lineItem);
    calculateTotals();
}

function removeLineItem(itemId) {
    const element = document.getElementById(`lineItem${itemId}`);
    if (element) {
        element.remove();
        calculateTotals();
    }
}

function calculateTotals() {
    let subtotal = 0;
    
    // Calculate line totals
    const container = document.getElementById('lineItemsContainer');
    const lineItems = container.querySelectorAll('.line-item-row');
    
    lineItems.forEach(item => {
        const id = item.id.replace('lineItem', '');
        const qty = parseFloat(document.getElementById(`qty${id}`)?.value || 0);
        const price = parseFloat(document.getElementById(`price${id}`)?.value || 0);
        const lineTotal = qty * price;
        
        const lineTotalElement = document.getElementById(`lineTotal${id}`);
        if (lineTotalElement) {
            lineTotalElement.textContent = `$${lineTotal.toFixed(2)}`;
        }
        
        subtotal += lineTotal;
    });
    
    // Apply discount
    const discountPercent = parseFloat(document.getElementById('discountAmount')?.value || 0);
    const discountAmount = subtotal * (discountPercent / 100);
    const discountedSubtotal = subtotal - discountAmount;
    
    // Calculate tax
    const taxAmount = discountedSubtotal * hawaiiTaxRate;
    const total = discountedSubtotal + taxAmount;
    
    // Update summary
    document.getElementById('subtotalAmount').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `$${taxAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `$${total.toFixed(2)}`;
}

function generateQuote() {
    // Collect all form data
    const quoteData = {
        client_name: document.getElementById('clientName').value,
        client_phone: document.getElementById('clientPhone').value,
        client_email: document.getElementById('clientEmail').value,
        job_location: document.getElementById('jobLocation').value,
        project_name: document.getElementById('projectName').value,
        valid_until: document.getElementById('validUntil').value,
        estimated_start: document.getElementById('estimatedStart').value,
        project_duration: document.getElementById('projectDuration').value,
        special_notes: document.getElementById('specialNotes').value,
        items: [],
        discount_percent: parseFloat(document.getElementById('discountAmount')?.value || 0)
    };
    
    // Collect line items
    const container = document.getElementById('lineItemsContainer');
    const lineItems = container.querySelectorAll('.line-item-row');
    
    lineItems.forEach(item => {
        const id = item.id.replace('lineItem', '');
        const itemData = {
            description: document.getElementById(`desc${id}`)?.value || '',
            quantity: parseFloat(document.getElementById(`qty${id}`)?.value || 0),
            unit_price: parseFloat(document.getElementById(`price${id}`)?.value || 0),
            unit_type: document.getElementById(`unit${id}`)?.value || 'item'
        };
        
        if (itemData.description && itemData.quantity > 0) {
            quoteData.items.push(itemData);
        }
    });
    
    // Validate required fields
    if (!quoteData.client_name || !quoteData.client_phone || quoteData.items.length === 0) {
        alert('Please fill in client name, phone number, and at least one line item.');
        return;
    }
    
    // Send to backend
    fetch('/api/generate-quote', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(quoteData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Quote ${data.quote_id} generated successfully!`);
            // Option to open PDF or redirect to quote detail
            window.open(`/api/download-quote/${data.quote_id}`, '_blank');
        } else {
            alert('Error generating quote: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating quote. Please try again.');
    });
}

function saveAsDraft() {
    // Save current state to localStorage
    const draftData = {
        client_name: document.getElementById('clientName').value,
        client_phone: document.getElementById('clientPhone').value,
        client_email: document.getElementById('clientEmail').value,
        job_location: document.getElementById('jobLocation').value,
        project_name: document.getElementById('projectName').value,
        // Add more fields as needed
    };
    
    localStorage.setItem('quoteDraft', JSON.stringify(draftData));
    alert('Quote saved as draft!');
}

function previewQuote() {
    // Generate preview in modal or new window
    alert('Preview functionality coming soon!');
}

function scheduleFollowUp() {
    // Open calendar or scheduling interface
    alert('Follow-up scheduling functionality coming soon!');
}

function copyQuoteLink() {
    // Generate shareable link
    alert('Shareable link functionality coming soon!');
}

// Set default values on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set valid until date to 30 days from now
    const validUntil = new Date();
    validUntil.setDate(validUntil.getDate() + 30);
    document.getElementById('validUntil').value = validUntil.toISOString().split('T')[0];
    
    // Set estimated start to tomorrow
    const estimatedStart = new Date();
    estimatedStart.setDate(estimatedStart.getDate() + 1);
    document.getElementById('estimatedStart').value = estimatedStart.toISOString().split('T')[0];
    
    // Add initial line item
    addLineItem();
});
</script>
{% endblock %}