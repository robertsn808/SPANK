{% extends "admin/base.html" %}

{% block title %}Workflow Automation - SPANKKS Construction Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Workflow Automation & Customer Engagement</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="processAutomatedActions()">
                        <i class="fas fa-play"></i> Process Actions
                    </button>
                    <button type="button" class="btn btn-success" onclick="generateEngagementCampaign()">
                        <i class="fas fa-bullhorn"></i> New Campaign
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analytics Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">Active Workflows</h5>
                            <h2 class="mb-0">{{ analytics.total_workflows or 0 }}</h2>
                        </div>
                        <div class="ml-3">
                            <i class="fas fa-project-diagram fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">Conversion Rate</h5>
                            <h2 class="mb-0">{{ "%.1f"|format(analytics.conversion_rates.quote_acceptance_rate or 0) }}%</h2>
                        </div>
                        <div class="ml-3">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">Automation Rate</h5>
                            <h2 class="mb-0">{{ "%.0f"|format(analytics.performance_metrics.automation_rate or 0) }}%</h2>
                        </div>
                        <div class="ml-3">
                            <i class="fas fa-robot fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <h5 class="card-title mb-1">Pending Actions</h5>
                            <h2 class="mb-0">{{ pending_actions|length or 0 }}</h2>
                        </div>
                        <div class="ml-3">
                            <i class="fas fa-tasks fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Workflow Management Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="workflowTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="active-workflows-tab" data-toggle="tab" href="#active-workflows" role="tab">
                        Active Workflows ({{ active_workflows|length }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pending-actions-tab" data-toggle="tab" href="#pending-actions" role="tab">
                        Pending Actions ({{ pending_actions|length }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="customer-engagement-tab" data-toggle="tab" href="#customer-engagement" role="tab">
                        Customer Engagement
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="workflow-stages-tab" data-toggle="tab" href="#workflow-stages" role="tab">
                        Stage Management
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="workflowTabContent">
                <!-- Active Workflows Tab -->
                <div class="tab-pane fade show active" id="active-workflows" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Active Workflow Tracking</h5>
                        </div>
                        <div class="card-body">
                            {% if active_workflows %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Workflow ID</th>
                                                <th>Quote ID</th>
                                                <th>Current Stage</th>
                                                <th>Started</th>
                                                <th>Next Action</th>
                                                <th>Progress</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for workflow in active_workflows %}
                                            <tr>
                                                <td>
                                                    <span class="badge badge-primary">{{ workflow.id }}</span>
                                                </td>
                                                <td>
                                                    <a href="/admin/crm/quotes/{{ workflow.quote_id }}" class="text-decoration-none">
                                                        Q{{ "%04d"|format(workflow.quote_id) }}
                                                    </a>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">{{ workflow.current_stage.replace('_', ' ').title() }}</span>
                                                </td>
                                                <td>{{ workflow.created_date }}</td>
                                                <td>
                                                    {% if workflow.next_action_due %}
                                                        <small class="text-muted">{{ workflow.next_action_due }}</small>
                                                    {% else %}
                                                        <span class="text-muted">-</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="progress" style="height: 8px;">
                                                        {% set stage_progress = {'quote_sent': 20, 'quote_accepted': 40, 'job_scheduled': 60, 'job_in_progress': 80, 'job_completed': 100} %}
                                                        <div class="progress-bar" role="progressbar" 
                                                             style="width: {{ stage_progress.get(workflow.current_stage, 10) }}%"></div>
                                                    </div>
                                                    <small class="text-muted">{{ stage_progress.get(workflow.current_stage, 10) }}%</small>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <button class="btn btn-outline-primary btn-sm" 
                                                                onclick="advanceWorkflow({{ workflow.quote_id }}, '{{ workflow.current_stage }}')"
                                                                data-toggle="tooltip" title="Advance Stage">
                                                            <i class="fas fa-forward"></i>
                                                        </button>
                                                        <button class="btn btn-outline-info btn-sm" 
                                                                onclick="viewWorkflowDetails({{ workflow.id }})"
                                                                data-toggle="tooltip" title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-project-diagram fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Active Workflows</h5>
                                    <p class="text-muted">Workflows will appear here when quotes are generated with automation enabled.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Pending Actions Tab -->
                <div class="tab-pane fade" id="pending-actions" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Scheduled Automation Actions</h5>
                        </div>
                        <div class="card-body">
                            {% if pending_actions %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Action Type</th>
                                                <th>Workflow</th>
                                                <th>Scheduled Date</th>
                                                <th>Priority</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for action in pending_actions %}
                                            <tr>
                                                <td>
                                                    <i class="fas fa-{{ 'envelope' if 'email' in action.action_type else 'phone' if 'call' in action.action_type else 'cog' }} mr-2"></i>
                                                    {{ action.action_type.replace('_', ' ').title() }}
                                                </td>
                                                <td>
                                                    <span class="badge badge-secondary">WF-{{ action.workflow_id }}</span>
                                                </td>
                                                <td>{{ action.scheduled_date }}</td>
                                                <td>
                                                    {% set priority_class = 'danger' if action.priority == 'high' else 'warning' if action.priority == 'medium' else 'success' %}
                                                    <span class="badge badge-{{ priority_class }}">{{ action.priority.title() }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info">{{ action.status.title() }}</span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="executeAction({{ action.id }})"
                                                            data-toggle="tooltip" title="Execute Now">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No Pending Actions</h5>
                                    <p class="text-muted">Automated actions will be scheduled as workflows progress.</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Customer Engagement Tab -->
                <div class="tab-pane fade" id="customer-engagement" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Customer Engagement Management</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Generate Engagement Campaign</h6>
                                            <div class="form-group">
                                                <label for="campaignType">Target Audience</label>
                                                <select class="form-control" id="campaignType">
                                                    <option value="new_customers">New Customers</option>
                                                    <option value="retention_risk">At-Risk Customers</option>
                                                    <option value="due">Due for Engagement</option>
                                                    <option value="all">All Customers</option>
                                                </select>
                                            </div>
                                            <button class="btn btn-primary btn-block" onclick="generateCampaign()">
                                                <i class="fas fa-bullhorn"></i> Generate Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">Quick Actions</h6>
                                            <div class="btn-group-vertical btn-block">
                                                <button class="btn btn-outline-primary" onclick="loadCustomersForEngagement('new_customers')">
                                                    <i class="fas fa-user-plus"></i> New Customer Follow-up
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="loadCustomersForEngagement('retention_risk')">
                                                    <i class="fas fa-exclamation-triangle"></i> At-Risk Customers
                                                </button>
                                                <button class="btn btn-outline-info" onclick="loadCustomersForEngagement('due')">
                                                    <i class="fas fa-clock"></i> Due for Contact
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Customer Engagement Results -->
                            <div id="engagementResults" style="display: none;">
                                <h6>Customers Requiring Attention</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm" id="engagementTable">
                                        <thead>
                                            <tr>
                                                <th>Customer</th>
                                                <th>Engagement Level</th>
                                                <th>Risk Level</th>
                                                <th>Last Contact</th>
                                                <th>Suggested Actions</th>
                                                <th>Contact</th>
                                            </tr>
                                        </thead>
                                        <tbody id="engagementTableBody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Workflow Stages Tab -->
                <div class="tab-pane fade" id="workflow-stages" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Workflow Stage Configuration</h5>
                        </div>
                        <div class="card-body">
                            {% if workflow_stages %}
                                <div class="row">
                                    {% for stage_name, stage in workflow_stages.items() %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-left-primary">
                                            <div class="card-body">
                                                <h6 class="card-title text-primary">{{ stage.name }}</h6>
                                                <p class="card-text text-muted">{{ stage.description }}</p>
                                                <div class="small">
                                                    <strong>Duration:</strong> {{ stage.duration_days }} days<br>
                                                    <strong>Auto-advance:</strong> {{ 'Yes' if stage.auto_advance else 'No' }}<br>
                                                    {% if stage.next_stage %}
                                                        <strong>Next Stage:</strong> {{ stage.next_stage }}
                                                    {% endif %}
                                                </div>
                                                {% if stage.actions %}
                                                    <div class="mt-2">
                                                        <strong>Actions:</strong>
                                                        <ul class="list-unstyled ml-3">
                                                            {% for action in stage.actions %}
                                                                <li><i class="fas fa-check text-success"></i> {{ action }}</li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Workflow Automation Results Modal -->
<div class="modal fade" id="automationResultsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Automation Results</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="automationResultsBody">
                <!-- Results will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Workflow automation functions
function processAutomatedActions() {
    fetch('/api/workflow/process-actions', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            showAutomationResults(data);
            // Reload page after 2 seconds to show updated data
            setTimeout(() => location.reload(), 2000);
        })
        .catch(error => {
            console.error('Error processing actions:', error);
            alert('Error processing automated actions. Please try again.');
        });
}

function advanceWorkflow(quoteId, currentStage) {
    const stageMap = {
        'quote_sent': 'quote_accepted',
        'quote_accepted': 'job_scheduled', 
        'job_scheduled': 'job_in_progress',
        'job_in_progress': 'job_completed'
    };
    
    const nextStage = stageMap[currentStage];
    if (!nextStage) {
        alert('Workflow is already at the final stage.');
        return;
    }
    
    if (confirm(`Advance workflow to ${nextStage.replace('_', ' ')}?`)) {
        fetch(`/api/workflow/advance/${quoteId}/${nextStage}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Workflow advanced successfully!');
                    location.reload();
                } else {
                    alert('Error advancing workflow: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error advancing workflow:', error);
                alert('Error advancing workflow. Please try again.');
            });
    }
}

function generateCampaign() {
    const campaignType = document.getElementById('campaignType').value;
    
    fetch('/api/customer-engagement/generate-campaign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ target_audience: campaignType })
    })
    .then(response => response.json())
    .then(data => {
        alert(`Campaign "${data.name}" created successfully! Targeting ${data.target_customers} customers.`);
        loadCustomersForEngagement(campaignType);
    })
    .catch(error => {
        console.error('Error generating campaign:', error);
        alert('Error generating campaign. Please try again.');
    });
}

function loadCustomersForEngagement(type) {
    fetch(`/api/customer-engagement/customers-for-engagement?type=${type}`)
        .then(response => response.json())
        .then(data => {
            displayEngagementResults(data.customers);
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
}

function displayEngagementResults(customers) {
    const resultsDiv = document.getElementById('engagementResults');
    const tableBody = document.getElementById('engagementTableBody');
    
    tableBody.innerHTML = '';
    
    if (customers.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No customers require attention at this time.</td></tr>';
    } else {
        customers.forEach(customer => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${customer.name}</strong><br>
                    <small class="text-muted">${customer.email}</small>
                </td>
                <td>
                    <span class="badge badge-${getEngagementBadgeClass(customer.engagement_level)}">
                        ${customer.engagement_level.replace('_', ' ')}
                    </span>
                </td>
                <td>
                    <span class="badge badge-${getRiskBadgeClass(customer.retention_risk)}">
                        ${customer.retention_risk}
                    </span>
                </td>
                <td>
                    ${customer.last_interaction ? new Date(customer.last_interaction).toLocaleDateString() : 'Never'}
                </td>
                <td>
                    <small>${customer.suggested_actions.slice(0, 2).join(', ')}</small>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="trackInteraction(${customer.contact_id}, 'phone_call_outbound')">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="trackInteraction(${customer.contact_id}, 'email_sent')">
                        <i class="fas fa-envelope"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    resultsDiv.style.display = 'block';
}

function getEngagementBadgeClass(level) {
    const classes = {
        'highly_engaged': 'success',
        'engaged': 'primary',
        'moderately_engaged': 'info',
        'low_engagement': 'warning',
        'new': 'secondary'
    };
    return classes[level] || 'secondary';
}

function getRiskBadgeClass(risk) {
    const classes = {
        'low': 'success',
        'medium': 'warning', 
        'high': 'danger'
    };
    return classes[risk] || 'secondary';
}

function trackInteraction(contactId, interactionType) {
    fetch('/api/customer-engagement/track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contact_id: contactId,
            interaction_type: interactionType,
            details: `Admin initiated ${interactionType.replace('_', ' ')}`
        })
    })
    .then(response => response.json())
    .then(data => {
        alert('Interaction logged successfully!');
        // Refresh the current engagement view
        const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
        if (activeTab === '#customer-engagement') {
            const lastType = document.getElementById('campaignType').value;
            loadCustomersForEngagement(lastType);
        }
    })
    .catch(error => {
        console.error('Error tracking interaction:', error);
        alert('Error logging interaction. Please try again.');
    });
}

function showAutomationResults(results) {
    const modalBody = document.getElementById('automationResultsBody');
    
    let html = '<h6>Automation Processing Results</h6>';
    
    if (results.actions_processed && results.actions_processed.length > 0) {
        html += '<div class="alert alert-success">Successfully processed ' + results.actions_processed.length + ' automated actions.</div>';
        html += '<ul class="list-group">';
        results.actions_processed.forEach(action => {
            html += `<li class="list-group-item">
                <i class="fas fa-check text-success"></i> ${action.action_type}: ${action.status}
            </li>`;
        });
        html += '</ul>';
    } else {
        html += '<div class="alert alert-info">No pending actions to process at this time.</div>';
    }
    
    modalBody.innerHTML = html;
    $('#automationResultsModal').modal('show');
}

// Initialize tooltips
$(document).ready(function() {
    $('[data-toggle="tooltip"]').tooltip();
    
    // Auto-refresh every 5 minutes
    setInterval(() => {
        if (document.visibilityState === 'visible') {
            location.reload();
        }
    }, 300000);
});
</script>
{% endblock %}