{% extends "admin/core/base.html" %}

{% block title %}Invoices & Payments - SPANKKS Construction{% endblock %}

{% block content %}
<div class="invoice-payment-dashboard">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Invoices & Payments</h1>
            <p class="text-muted mb-0">Manage invoices, track payments, and financial records</p>
        </div>
        <div>
            <button class="btn btn-primary" onclick="createNewInvoice()">
                <i class="fas fa-file-invoice-dollar me-2"></i>Create Invoice
            </button>
        </div>
    </div>

    <!-- Financial Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted">Total Invoiced</h6>
                            <h3 class="card-title">${{ (invoices|sum(attribute='total_amount') or 0)|round(2) }}</h3>
                        </div>
                        <div class="stat-icon bg-primary">
                            <i class="fas fa-file-invoice-dollar"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted">Payments Received</h6>
                            <h3 class="card-title">${{ (payments|sum(attribute='amount_paid') or 0)|round(2) }}</h3>
                        </div>
                        <div class="stat-icon bg-success">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted">Outstanding</h6>
                            <h3 class="card-title">${{ ((invoices|sum(attribute='total_amount') or 0) - (payments|sum(attribute='amount_paid') or 0))|round(2) }}</h3>
                        </div>
                        <div class="stat-icon bg-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted">This Month</h6>
                            <h3 class="card-title">${{ (payments|selectattr('payment_date')|list|length * 250)|round(2) }}</h3>
                        </div>
                        <div class="stat-icon bg-info">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="card">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" id="invoiceTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#invoices-list">
                        <i class="fas fa-file-invoice me-2"></i>Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#payments-log">
                        <i class="fas fa-money-check-alt me-2"></i>Payments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#payment-tracking">
                        <i class="fas fa-chart-line me-2"></i>Payment Tracking
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#overdue-invoices">
                        <i class="fas fa-clock me-2"></i>Overdue
                    </a>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="invoiceTabContent">
                <!-- Invoices List Tab -->
                <div class="tab-pane fade show active" id="invoices-list">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <input type="text" class="form-control" id="invoiceSearch" placeholder="Search invoices..." style="width: 300px;">
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                Filter Status
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="filterInvoices('all')">All Invoices</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterInvoices('pending')">Pending</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterInvoices('paid')">Paid</a></li>
                                <li><a class="dropdown-item" href="#" onclick="filterInvoices('overdue')">Overdue</a></li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover" id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Date</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                <tr data-status="{{ invoice.status }}">
                                    <td>
                                        <strong>{{ invoice.invoice_number }}</strong>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ invoice.client_name or 'Unknown' }}</strong><br>
                                            <small class="text-muted">{{ invoice.client_id }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if invoice.created_at %}
                                        {{ invoice.created_at.strftime('%m/%d/%Y') }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if invoice.due_date %}
                                        {{ invoice.due_date.strftime('%m/%d/%Y') }}
                                        {% else %}
                                        <span class="text-muted">Not set</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>${{ "%.2f"|format(invoice.total_amount or 0) }}</strong>
                                        {% if invoice.tax_amount %}
                                        <br><small class="text-muted">Tax: ${{ "%.2f"|format(invoice.tax_amount) }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if invoice.status == 'paid' else 'warning' if invoice.status == 'pending' else 'danger' }}">
                                            {{ invoice.status|title }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" 
                                                    onclick="viewInvoice('{{ invoice.invoice_number }}')"
                                                    title="View Invoice">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-success" 
                                                    onclick="recordPayment('{{ invoice.invoice_number }}')"
                                                    title="Record Payment">
                                                <i class="fas fa-dollar-sign"></i>
                                            </button>
                                            <button class="btn btn-outline-info" 
                                                    onclick="emailInvoice('{{ invoice.invoice_number }}')"
                                                    title="Email Invoice">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="editInvoice('{{ invoice.invoice_number }}')"
                                                    title="Edit Invoice">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-file-invoice fa-3x mb-3"></i><br>
                                        No invoices found. Create your first invoice to get started.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Log Tab -->
                <div class="tab-pane fade" id="payments-log">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Recent Payments</h5>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportPayments()">
                            <i class="fas fa-download me-2"></i>Export Payments
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in payments %}
                                <tr>
                                    <td>
                                        {% if payment.payment_date %}
                                        {{ payment.payment_date.strftime('%m/%d/%Y') }}
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ payment.invoice_number or 'N/A' }}</td>
                                    <td>{{ payment.client_name or 'Unknown' }}</td>
                                    <td><strong>${{ "%.2f"|format(payment.amount_paid or 0) }}</strong></td>
                                    <td>
                                        <span class="badge bg-info">{{ payment.payment_method or 'Cash' }}</span>
                                    </td>
                                    <td>{{ payment.reference_number or '-' }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-info" 
                                                onclick="viewPaymentDetails('{{ payment.payment_id }}')"
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">
                                        <i class="fas fa-money-check-alt fa-3x mb-3"></i><br>
                                        No payments recorded yet.
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payment Tracking Tab -->
                <div class="tab-pane fade" id="payment-tracking">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>Payment Trends</h5>
                            <div class="chart-container bg-light p-3 rounded">
                                <canvas id="paymentChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>Payment Methods</h5>
                            <div class="payment-methods">
                                <div class="method-item">
                                    <div class="d-flex justify-content-between">
                                        <span>Cash</span>
                                        <strong>{{ ((payments|selectattr('payment_method', 'equalto', 'Cash')|list|length / payments|length * 100) if payments else 0)|round(1) }}%</strong>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" style="width: {{ ((payments|selectattr('payment_method', 'equalto', 'Cash')|list|length / payments|length * 100) if payments else 0)|round(1) }}%"></div>
                                    </div>
                                </div>
                                <div class="method-item">
                                    <div class="d-flex justify-content-between">
                                        <span>Check</span>
                                        <strong>{{ ((payments|selectattr('payment_method', 'equalto', 'Check')|list|length / payments|length * 100) if payments else 0)|round(1) }}%</strong>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-primary" style="width: {{ ((payments|selectattr('payment_method', 'equalto', 'Check')|list|length / payments|length * 100) if payments else 0)|round(1) }}%"></div>
                                    </div>
                                </div>
                                <div class="method-item">
                                    <div class="d-flex justify-content-between">
                                        <span>Venmo/Zelle</span>
                                        <strong>{{ ((payments|selectattr('payment_method', 'match', '.*Venmo.*|.*Zelle.*')|list|length / payments|length * 100) if payments else 0)|round(1) }}%</strong>
                                    </div>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-info" style="width: {{ ((payments|selectattr('payment_method', 'match', '.*Venmo.*|.*Zelle.*')|list|length / payments|length * 100) if payments else 0)|round(1) }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overdue Invoices Tab -->
                <div class="tab-pane fade" id="overdue-invoices">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Overdue Invoices</h5>
                        <button class="btn btn-outline-danger btn-sm" onclick="sendOverdueReminders()">
                            <i class="fas fa-exclamation-triangle me-2"></i>Send Reminders
                        </button>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Payment Collection:</strong> Review overdue invoices and follow up with clients for timely payments.
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Client</th>
                                    <th>Amount</th>
                                    <th>Due Date</th>
                                    <th>Days Overdue</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                {% if invoice.status != 'paid' and invoice.due_date and invoice.due_date < moment() %}
                                <tr class="table-warning">
                                    <td><strong>{{ invoice.invoice_number }}</strong></td>
                                    <td>{{ invoice.client_name or 'Unknown' }}</td>
                                    <td><strong>${{ "%.2f"|format(invoice.total_amount or 0) }}</strong></td>
                                    <td>{{ invoice.due_date.strftime('%m/%d/%Y') if invoice.due_date else '-' }}</td>
                                    <td>
                                        {% if invoice.due_date %}
                                        <span class="badge bg-danger">{{ (moment() - invoice.due_date).days }} days</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-warning" 
                                                    onclick="sendReminder('{{ invoice.invoice_number }}')"
                                                    title="Send Reminder">
                                                <i class="fas fa-envelope"></i>
                                            </button>
                                            <button class="btn btn-outline-primary" 
                                                    onclick="callClient('{{ invoice.client_name }}')"
                                                    title="Call Client">
                                                <i class="fas fa-phone"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endif %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i><br>
                                        No overdue invoices. Great job staying on top of collections!
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="recordPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Record Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="recordPaymentForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Invoice Number</label>
                        <input type="text" class="form-control" name="invoice_number" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Amount *</label>
                        <input type="number" class="form-control" name="amount_paid" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method *</label>
                        <select class="form-select" name="payment_method" required>
                            <option value="Cash">Cash</option>
                            <option value="Check">Check</option>
                            <option value="Venmo">Venmo</option>
                            <option value="Zelle">Zelle</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                            <option value="Credit Card">Credit Card</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference Number</label>
                        <input type="text" class="form-control" name="reference_number" placeholder="Check #, transaction ID, etc.">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Date</label>
                        <input type="date" class="form-control" name="payment_date" value="{{ moment().strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="payment_notes" rows="2" placeholder="Additional payment notes..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.invoice-payment-dashboard {
    padding: 20px;
}

.stat-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
}

.stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.2rem;
}

.chart-container {
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.payment-methods .method-item {
    margin-bottom: 15px;
}

.nav-tabs .nav-link {
    border: none;
    color: #6c757d;
}

.nav-tabs .nav-link.active {
    color: #667eea;
    border-bottom: 2px solid #667eea;
    background: none;
}

#invoicesTable tbody tr:hover {
    background-color: #f8f9fa;
}
</style>

<script>
// Search functionality
document.getElementById('invoiceSearch').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#invoicesTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Filter functionality
function filterInvoices(status) {
    const rows = document.querySelectorAll('#invoicesTable tbody tr');
    
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else {
            const invoiceStatus = row.getAttribute('data-status');
            row.style.display = invoiceStatus === status ? '' : 'none';
        }
    });
}

// Invoice management functions
function createNewInvoice() {
    window.location.href = '/admin/quote-builder';
}

function viewInvoice(invoiceNumber) {
    window.open(`/api/admin/invoices/${invoiceNumber}/pdf`, '_blank');
}

function recordPayment(invoiceNumber) {
    document.querySelector('input[name="invoice_number"]').value = invoiceNumber;
    new bootstrap.Modal(document.getElementById('recordPaymentModal')).show();
}

function emailInvoice(invoiceNumber) {
    fetch('/api/email/send-reminder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            invoice: { invoice_number: invoiceNumber },
            client: { email: 'client@example.com' } // Would get from database
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Invoice emailed successfully!');
        } else {
            alert(`Error: ${result.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending email');
    });
}

function editInvoice(invoiceNumber) {
    alert(`Edit invoice ${invoiceNumber} - would open edit form`);
}

function exportPayments() {
    window.open('/api/admin/payments/export', '_blank');
}

function viewPaymentDetails(paymentId) {
    alert(`View payment details for ID ${paymentId} - would show modal`);
}

function sendOverdueReminders() {
    if (confirm('Send payment reminders to all clients with overdue invoices?')) {
        alert('Sending overdue reminders - would process bulk emails');
    }
}

function sendReminder(invoiceNumber) {
    emailInvoice(invoiceNumber);
}

function callClient(clientName) {
    alert(`Calling ${clientName} - would open phone/contact dialog`);
}

// Form submission
document.getElementById('recordPaymentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const paymentData = {
        invoice_number: formData.get('invoice_number'),
        amount_paid: parseFloat(formData.get('amount_paid')),
        payment_method: formData.get('payment_method'),
        reference_number: formData.get('reference_number'),
        payment_date: formData.get('payment_date'),
        payment_notes: formData.get('payment_notes')
    };
    
    fetch('/api/admin/payment-records', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(paymentData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('recordPaymentModal')).hide();
            location.reload();
        } else {
            alert(`Error: ${result.error}`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error recording payment');
    });
});

// Initialize chart (placeholder)
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('paymentChart');
    if (ctx) {
        ctx.getContext('2d');
        // Chart.js would be initialized here
        ctx.style.display = 'none';
        ctx.parentElement.innerHTML += '<p class="text-center text-muted">Payment trends chart would be displayed here</p>';
    }
});
</script>
{% endblock %}