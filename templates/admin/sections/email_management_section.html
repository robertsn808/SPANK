
<style>
body {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
    font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    min-height: 100vh;
}

.container-fluid {
    background: transparent;
    min-height: 100vh;
    padding: 30px;
}

/* Professional Email Management Design */
.email-card {
    background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
    border: 1px solid rgba(26, 95, 63, 0.1);
    border-radius: 20px;
    box-shadow: 
        0 10px 40px rgba(0,0,0,0.08),
        0 4px 20px rgba(26, 95, 63, 0.05),
        inset 0 1px 0 rgba(255,255,255,0.8);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.email-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #1a5f3f, #2d7a5a, #1a5f3f);
    border-radius: 20px 20px 0 0;
}

.email-card:hover {
    transform: translateY(-8px) scale(1.01);
    box-shadow: 
        0 20px 60px rgba(0,0,0,0.15),
        0 8px 30px rgba(26, 95, 63, 0.1),
        inset 0 1px 0 rgba(255,255,255,0.9);
}

.card-header {
    background: linear-gradient(135deg, #1a5f3f 0%, #2d7a5a 50%, #1a5f3f 100%) !important;
    color: white !important;
    border-radius: 20px 20px 0 0 !important;
    padding: 2rem !important;
    position: relative;
    overflow: hidden;
}

.card-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
}

@keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
}

.card-header h5 {
    color: white !important;
    font-weight: 700;
    font-size: 1.5rem;
    margin-bottom: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
}

.card-header h5 i {
    margin-right: 12px;
    font-size: 1.3rem;
}

.stats-card {
    background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
    border: 1px solid rgba(26, 95, 63, 0.08);
    border-radius: 20px;
    box-shadow: 
        0 8px 32px rgba(0,0,0,0.06),
        0 4px 16px rgba(26, 95, 63, 0.04),
        inset 0 1px 0 rgba(255,255,255,0.9);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #1a5f3f, #2d7a5a);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.stats-card:hover {
    transform: translateY(-6px) scale(1.02);
    box-shadow: 
        0 16px 48px rgba(0,0,0,0.12),
        0 8px 24px rgba(26, 95, 63, 0.08),
        inset 0 1px 0 rgba(255,255,255,1);
}

.stats-card:hover::before {
    opacity: 1;
}

.stats-card .card-body {
    padding: 2rem 1.5rem;
}

.stats-icon {
    width: 80px;
    height: 80px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin-bottom: 1.5rem;
    position: relative;
    overflow: hidden;
}

.stats-icon::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: inherit;
    filter: blur(20px);
    opacity: 0.3;
    transform: scale(1.2);
}

.stats-icon i {
    position: relative;
    z-index: 2;
}

.stats-icon.primary {
    background: linear-gradient(135deg, #1a5f3f 0%, #2d7a5a 50%, #1a5f3f 100%);
    color: white;
    box-shadow: 
        0 8px 32px rgba(26, 95, 63, 0.4),
        0 4px 16px rgba(26, 95, 63, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
}

.stats-icon.success {
    background: linear-gradient(135deg, #198754 0%, #20c997 50%, #198754 100%);
    color: white;
    box-shadow: 
        0 8px 32px rgba(25, 135, 84, 0.4),
        0 4px 16px rgba(25, 135, 84, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
}

.stats-icon.warning {
    background: linear-gradient(135deg, #fd7e14 0%, #ffc107 50%, #fd7e14 100%);
    color: white;
    box-shadow: 
        0 8px 32px rgba(253, 126, 20, 0.4),
        0 4px 16px rgba(253, 126, 20, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
}

.stats-icon.info {
    background: linear-gradient(135deg, #0dcaf0 0%, #6f42c1 50%, #0dcaf0 100%);
    color: white;
    box-shadow: 
        0 8px 32px rgba(13, 202, 240, 0.4),
        0 4px 16px rgba(13, 202, 240, 0.2),
        inset 0 1px 0 rgba(255,255,255,0.2);
}

.btn-primary {
    background: linear-gradient(135deg, #1a5f3f 0%, #2d7a5a 100%);
    border: none;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(26, 95, 63, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #145a34 0%, #246a4f 100%);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(26, 95, 63, 0.4);
}

.btn-outline-secondary {
    border: 2px solid #6c757d;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.btn-outline-secondary:hover {
    background: #6c757d;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(108, 117, 125, 0.3);
}

.btn-outline-primary {
    border: 2px solid #1a5f3f;
    color: #1a5f3f;
    border-radius: 12px;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.btn-outline-primary:hover {
    background: #1a5f3f;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(26, 95, 63, 0.3);
}

.btn-outline-info {
    border: 2px solid #0dcaf0;
    color: #0dcaf0;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
}

.btn-outline-info:hover {
    background: #0dcaf0;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(13, 202, 240, 0.3);
}

.form-control, .form-select {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
}

.form-control:focus, .form-select:focus {
    border-color: #1a5f3f;
    box-shadow: 0 0 0 0.2rem rgba(26, 95, 63, 0.15);
    background: white;
    transform: scale(1.02);
}

.section-divider {
    height: 3px;
    background: linear-gradient(90deg, #1a5f3f 0%, #2d7a5a 50%, #1a5f3f 100%);
    border: none;
    margin: 3rem 0;
    border-radius: 2px;
    box-shadow: 0 2px 10px rgba(26, 95, 63, 0.2);
}

.email-template {
    border: 2px solid #e9ecef;
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
}

.email-template::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(26, 95, 63, 0.1), transparent);
    transition: left 0.6s ease;
}

.email-template:hover::before {
    left: 100%;
}

.email-template:hover {
    border-color: #1a5f3f;
    background: linear-gradient(135deg, #f0f8f4 0%, #e8f5e8 100%);
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(26, 95, 63, 0.15);
}

.email-template.selected {
    border-color: #1a5f3f;
    background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
    box-shadow: 0 6px 20px rgba(26, 95, 63, 0.2);
}

.email-template h6 {
    color: #1a5f3f;
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
}

.email-template p {
    margin-bottom: 0;
    font-size: 0.9rem;
    color: #6c757d;
}

.email-editor {
    min-height: 300px;
    border: 2px solid #e9ecef;
    border-radius: 16px;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    transition: all 0.3s ease;
    resize: vertical;
    font-family: 'Inter', sans-serif;
}

.email-editor:focus {
    border-color: #1a5f3f;
    box-shadow: 0 0 0 0.2rem rgba(26, 95, 63, 0.15);
    background: white;
    transform: scale(1.01);
}

.email-preview {
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
    border: 2px solid #e9ecef;
    border-radius: 16px;
    padding: 2rem;
    min-height: 400px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    backdrop-filter: blur(10px);
}

.table-responsive {
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 6px 20px rgba(0,0,0,0.05);
    background: white;
}

.table {
    margin-bottom: 0;
}

.table thead th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border: none;
    padding: 1.2rem;
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.table tbody tr {
    transition: all 0.2s ease;
}

.table tbody tr:hover {
    background: linear-gradient(135deg, #f8f9fa 0%, #f0f8f4 100%);
    transform: scale(1.001);
}

.table tbody td {
    padding: 1.2rem;
    border-color: #e9ecef;
    vertical-align: middle;
}

.badge {
    border-radius: 12px;
    padding: 0.5rem 0.75rem;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-sm {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    padding: 0.5rem 1rem;
}

.btn-sm:hover {
    transform: translateY(-1px);
}

.form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.header-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 1px solid rgba(26, 95, 63, 0.1);
    box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.header-section h1 {
    background: linear-gradient(135deg, #1a5f3f, #2d7a5a);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
}

.btn-group .btn {
    transition: all 0.3s ease;
}

.btn-group .btn:hover {
    transform: translateY(-2px);
    z-index: 2;
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
    .container-fluid {
        padding: 15px;
    }
    
    .email-card {
        margin-bottom: 1rem;
    }
    
    .card-header {
        padding: 1.5rem !important;
    }
    
    .card-header h5 {
        font-size: 1.2rem;
    }
    
    .stats-card .card-body {
        padding: 1.5rem 1rem;
    }
    
    .stats-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .btn-group {
        flex-direction: column;
        width: 100%;
        gap: 0.5rem;
    }
    
    .btn-group .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }
    
    .table-responsive {
        font-size: 0.85rem;
    }
    
    .table td, .table th {
        padding: 0.75rem 0.5rem;
    }
}

/* Loading Animation */
@keyframes loadingPulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.loading {
    animation: loadingPulse 1.5s infinite;
}

/* Success Animation */
@keyframes successPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.success-animation {
    animation: successPulse 0.6s ease-in-out;
}
</style>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="header-section">
                <div class="d-flex justify-content-between align-items-center flex-wrap">
                    <div class="d-flex align-items-center mb-3 mb-md-0">
                        <a href="/admin-home" class="btn btn-outline-secondary me-4 rounded-pill px-4 py-2" style="border-width: 2px; font-weight: 600;">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                        <div>
                            <h1 class="mb-2 fw-bold">
                                <i class="fas fa-envelope me-3"></i>Email Management
                            </h1>
                            <p class="text-muted mb-0 fs-5">Professional email campaigns and customer communications</p>
                        </div>
                    </div>
                    <div class="btn-group shadow-lg rounded-pill" style="box-shadow: 0 4px 20px rgba(26, 95, 63, 0.2) !important;">
                        <button class="btn btn-primary rounded-start-pill px-4 py-3 fw-bold" onclick="sendEmail()" style="background: linear-gradient(135deg, #1a5f3f, #2d7a5a); border: none; font-size: 1.1rem;">
                            <i class="fas fa-paper-plane me-2"></i>Send Campaign
                        </button>
                        <button class="btn btn-outline-primary rounded-end-pill px-4 py-3 fw-bold" onclick="createTemplate()" style="border-color: #1a5f3f; color: #1a5f3f; border-width: 2px; font-size: 1.1rem;">
                            <i class="fas fa-plus me-2"></i>New Template
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Statistics -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon primary mx-auto">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <h3 class="mb-2 fw-bold" id="emailsSent" style="font-size: 2.5rem; color: #1a5f3f;">0</h3>
                    <p class="text-muted mb-0 fw-semibold">Emails Sent</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon success mx-auto">
                        <i class="fas fa-eye"></i>
                    </div>
                    <h3 class="mb-2 fw-bold" id="openRate" style="font-size: 2.5rem; color: #198754;">-</h3>
                    <p class="text-muted mb-0 fw-semibold">Open Rate</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon warning mx-auto">
                        <i class="fas fa-mouse-pointer"></i>
                    </div>
                    <h3 class="mb-2 fw-bold" id="clickRate" style="font-size: 2.5rem; color: #fd7e14;">-</h3>
                    <p class="text-muted mb-0 fw-semibold">Click Rate</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="stats-card">
                <div class="card-body text-center">
                    <div class="stats-icon info mx-auto">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="mb-2 fw-bold" id="totalSubscribers" style="font-size: 2.5rem; color: #0dcaf0;">0</h3>
                    <p class="text-muted mb-0 fw-semibold">Subscribers</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Composer -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card email-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Email Composer</h5>
                </div>
                <div class="card-body p-4">
                    <form id="emailForm">
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="clientEmail" class="form-label">
                                    <i class="fas fa-user me-2 text-primary"></i>Client Email
                                </label>
                                <input type="email" class="form-control" id="clientEmail" placeholder="client@example.com">
                                <small class="form-text text-muted">Individual client email address</small>
                            </div>
                            <div class="col-md-4">
                                <label for="emailSubject" class="form-label">
                                    <i class="fas fa-envelope me-2 text-primary"></i>Subject Line
                                </label>
                                <input type="text" class="form-control" id="emailSubject" placeholder="Enter email subject...">
                                <small class="form-text text-muted">Keep it clear and professional</small>
                            </div>
                            <div class="col-md-4">
                                <label for="automationGroup" class="form-label">
                                    <i class="fas fa-cogs me-2 text-primary"></i>Add to Group
                                </label>
                                <select class="form-select" id="automationGroup">
                                    <option value="">No automation group</option>
                                </select>
                                <small class="form-text text-muted">Trigger MailerLite automation</small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="emailTemplate" class="form-label">
                                <i class="fas fa-file-alt me-2 text-primary"></i>Email Template
                            </label>
                            <select class="form-select" id="emailTemplate" onchange="loadTemplate()">
                                <option value="">âœ¨ Select a template...</option>
                                <option value="welcome">ðŸ‘‹ Welcome Email</option>
                                <option value="quote_follow_up">ðŸ“‹ Quote Follow-up</option>
                                <option value="job_completion">âœ… Job Completion</option>
                                <option value="newsletter">ðŸ“° Newsletter</option>
                                <option value="promotion">ðŸŽ‰ Promotional Email</option>
                            </select>
                            <small class="form-text text-muted">Choose a template to get started quickly</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="emailContent" class="form-label">Email Content</label>
                            <textarea class="form-control email-editor" id="emailContent" placeholder="Enter your email content here..."></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-secondary" onclick="saveAsDraft()">
                                    <i class="fas fa-save me-1"></i>Save Draft
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="previewEmail()">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </button>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-1"></i>Send Email
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card email-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Preview</h5>
                </div>
                <div class="card-body">
                    <div class="email-preview" id="emailPreview">
                        <p class="text-muted text-center">Preview will appear here</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <hr class="section-divider">

    <!-- Email Templates -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card email-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Email Templates</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="email-template" onclick="selectTemplate('welcome')">
                                <h6><i class="fas fa-hand-sparkles me-2"></i>Welcome Email</h6>
                                <p class="text-muted mb-0">Welcome new clients to SPANKKS Construction</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="email-template" onclick="selectTemplate('quote_follow_up')">
                                <h6><i class="fas fa-file-invoice me-2"></i>Quote Follow-up</h6>
                                <p class="text-muted mb-0">Follow up on pending quotes</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="email-template" onclick="selectTemplate('job_completion')">
                                <h6><i class="fas fa-check-circle me-2"></i>Job Completion</h6>
                                <p class="text-muted mb-0">Notify clients of completed work</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="email-template" onclick="selectTemplate('newsletter')">
                                <h6><i class="fas fa-newspaper me-2"></i>Newsletter</h6>
                                <p class="text-muted mb-0">Monthly company newsletter</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Emails -->
    <div class="row">
        <div class="col-12">
            <div class="card email-card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Emails</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Subject</th>
                                    <th>Recipients</th>
                                    <th>Sent Date</th>
                                    <th>Open Rate</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="emailHistoryTable">
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <div class="d-flex justify-content-center align-items-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading email history...
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Email management page loaded');
    
    // Load email statistics
    loadEmailStatistics();
    
    // Email form submission
    document.getElementById('emailForm').addEventListener('submit', function(e) {
        e.preventDefault();
        sendEmail();
    });
    
    // Add loading states
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(button => {
        button.addEventListener('click', function() {
            if (!this.classList.contains('btn-outline-secondary') && !this.classList.contains('btn-outline-info')) {
                this.classList.add('loading');
                setTimeout(() => {
                    this.classList.remove('loading');
                    this.classList.add('success-animation');
                    setTimeout(() => {
                        this.classList.remove('success-animation');
                    }, 600);
                }, 1000);
            }
        });
    });
});

function loadEmailStatistics() {
    // Fetch real email statistics from MailerLite API
    fetch('/api/admin/email-stats')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('emailsSent').textContent = data.stats.emails_sent || 0;
            document.getElementById('openRate').textContent = data.stats.open_rate ? data.stats.open_rate + '%' : '-';
            document.getElementById('clickRate').textContent = data.stats.click_rate ? data.stats.click_rate + '%' : '-';
            document.getElementById('totalSubscribers').textContent = data.stats.subscribers || 0;
        }
    })
    .catch(error => {
        console.log('Email statistics not available:', error);
        // Set default values if API fails
        document.getElementById('emailsSent').textContent = '0';
        document.getElementById('openRate').textContent = '-';
        document.getElementById('clickRate').textContent = '-';
        document.getElementById('totalSubscribers').textContent = '0';
    });
}

// Initialize multi-select for recipients
function initializeRecipientSelect() {
    const selectElement = document.getElementById('emailTo');
    if (selectElement) {
        // Enable multiple selection
        selectElement.setAttribute('multiple', 'multiple');
        
        // Add event listener for selection changes
        selectElement.addEventListener('change', function() {
            const selectedOptions = Array.from(this.selectedOptions);
            const selectedValues = selectedOptions.map(option => option.value);
            console.log('Selected recipients:', selectedValues);
        });
    }
}

// Form validation
function validateEmailForm() {
    const recipients = document.getElementById('emailTo').value;
    const subject = document.getElementById('emailSubject').value;
    const content = document.getElementById('emailContent').value;
    
    const errors = [];
    
    if (!recipients || recipients.length === 0) {
        errors.push('Please select at least one recipient group');
    }
    
    if (!subject.trim()) {
        errors.push('Please enter an email subject');
    }
    
    if (!content.trim()) {
        errors.push('Please enter email content');
    }
    
    if (subject.length > 100) {
        errors.push('Subject line should be under 100 characters');
    }
    
    return errors;
}

// Auto-save draft functionality
function startAutoSave() {
    setInterval(() => {
        const form = document.getElementById('emailForm');
        if (form) {
            const subject = document.getElementById('emailSubject').value;
            const content = document.getElementById('emailContent').value;
            
            if (subject.trim() || content.trim()) {
                const draftData = {
                    subject: subject,
                    content: content,
                    recipients: document.getElementById('emailTo').value,
                    template: document.getElementById('emailTemplate').value,
                    timestamp: new Date().toISOString()
                };
                
                localStorage.setItem('email_auto_draft', JSON.stringify(draftData));
                console.log('Auto-saved draft');
            }
        }
    }, 30000); // Auto-save every 30 seconds
}

// Load auto-saved draft
function loadAutoSavedDraft() {
    const draft = localStorage.getItem('email_auto_draft');
    if (draft) {
        try {
            const draftData = JSON.parse(draft);
            const confirmLoad = confirm('Found an auto-saved draft. Would you like to restore it?');
            
            if (confirmLoad) {
                document.getElementById('emailSubject').value = draftData.subject || '';
                document.getElementById('emailContent').value = draftData.content || '';
                if (draftData.template) {
                    document.getElementById('emailTemplate').value = draftData.template;
                }
                showNotification('Auto-saved draft restored', 'success');
            }
        } catch (error) {
            console.error('Error loading auto-saved draft:', error);
        }
    }
}

function sendEmail() {
    const emailTo = document.getElementById('emailTo').value;
    const subject = document.getElementById('emailSubject').value;
    const content = document.getElementById('emailContent').value;
    
    if (!emailTo || !subject || !content) {
        showNotification('Please fill in all required fields', 'error');
        return;
    }
    
    // Send email via API
    fetch('/api/admin/send-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            to: emailTo,
            subject: subject,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Email sent successfully!', 'success');
            document.getElementById('emailForm').reset();
            document.getElementById('emailPreview').innerHTML = '<p class="text-muted text-center">Preview will appear here</p>';
        } else {
            showNotification(data.message || 'Failed to send email', 'error');
        }
    })
    .catch(error => {
        showNotification('Error sending email', 'error');
        console.error('Error:', error);
    });
}

function loadTemplate() {
    const templateSelect = document.getElementById('emailTemplate');
    const template = templateSelect.value;
    const contentArea = document.getElementById('emailContent');
    const subjectField = document.getElementById('emailSubject');
    
    const templates = {
        welcome: {
            subject: 'Welcome to SPANKKS Construction!',
            content: `Dear [Client Name],

Welcome to SPANKKS Construction! We're excited to work with you on your upcoming project.

Our team is committed to providing exceptional service and quality workmanship. We'll keep you updated throughout the entire process.

If you have any questions, please don't hesitate to contact us at (808) 778-9132 or spank808@gmail.com.

Best regards,
The SPANKKS Construction Team`
        },
        quote_follow_up: {
            subject: 'Your Quote is Ready - SPANKKS Construction',
            content: `Dear [Client Name],

Thank you for your interest in SPANKKS Construction. Your quote is now ready for review.

Quote Number: [Quote Number]
Total Amount: $[Amount]

Please review the details and let us know if you have any questions. We're here to help!

Best regards,
SPANKKS Construction Team`
        },
        job_completion: {
            subject: 'Job Completed Successfully - SPANKKS Construction',
            content: `Dear [Client Name],

Great news! Your project has been completed successfully.

We hope you're satisfied with the quality of our work. Please take a moment to inspect everything and let us know if you have any concerns.

Thank you for choosing SPANKKS Construction!

Best regards,
The SPANKKS Team`
        },
        newsletter: {
            subject: 'SPANKKS Construction Newsletter - [Month] [Year]',
            content: `SPANKKS Construction Monthly Newsletter

This month's highlights:
- Recent project completions
- New services available
- Special offers for returning clients
- Tips for home maintenance

Contact us for your next project!`
        },
        promotion: {
            subject: 'Special Offer from SPANKKS Construction',
            content: `Limited Time Offer!

Get 15% off your next project with SPANKKS Construction.

This offer is valid for new bookings through the end of the month.

Contact us today to schedule your consultation!`
        }
    };
    
    if (templates[template]) {
        subjectField.value = templates[template].subject;
        contentArea.value = templates[template].content;
        previewEmail();
    }
}

function previewEmail() {
    const subject = document.getElementById('emailSubject').value;
    const content = document.getElementById('emailContent').value;
    const preview = document.getElementById('emailPreview');
    
    preview.innerHTML = `
        <div style="font-family: Arial, sans-serif;">
            <h6 style="margin-bottom: 15px; color: #1a5f3f;"><strong>Subject: ${subject}</strong></h6>
            <div style="white-space: pre-wrap; line-height: 1.6;">${content}</div>
        </div>
    `;
}

function selectTemplate(templateName) {
    document.getElementById('emailTemplate').value = templateName;
    loadTemplate();
    
    // Visual feedback
    document.querySelectorAll('.email-template').forEach(t => t.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
}

function saveAsDraft() {
    showNotification('Email saved as draft', 'success');
}

function createTemplate() {
    showNotification('Template creator would open here', 'info');
}

function viewEmail(emailId) {
    showNotification(`Viewing email ${emailId}`, 'info');
}

function duplicateEmail(emailId) {
    showNotification(`Email ${emailId} duplicated`, 'success');
}

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);';
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 4000);
}
</script>
