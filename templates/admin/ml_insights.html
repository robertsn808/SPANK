{% extends "base.html" %}

{% block title %}ML Insights - SPANKKS Construction{% endblock %}

{% block extra_css %}
<style>
    .ml-dashboard {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 0;
    }
    
    .ml-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .prediction-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: transform 0.3s ease;
    }
    
    .prediction-card:hover {
        transform: translateY(-5px);
    }
    
    .ml-metric {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
        color: #333;
    }
    
    .seasonal-chart {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    
    .pricing-recommendation {
        border-left: 5px solid;
        background: #f8f9fa;
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0 10px 10px 0;
    }
    
    .increase-price { border-left-color: #28a745; }
    .decrease-price { border-left-color: #dc3545; }
    .maintain-price { border-left-color: #17a2b8; }
    
    .customer-segment {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin: 0.25rem;
    }
    
    .vip-customer { background: #ffd700; color: #333; }
    .high-value { background: #28a745; color: white; }
    .regular-customer { background: #17a2b8; color: white; }
    .occasional-customer { background: #6c757d; color: white; }
    
    .confidence-meter {
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        margin-top: 0.5rem;
    }
    
    .confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.5s ease;
    }
    
    .growth-projection {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
    }
    
    .forecast-timeline {
        display: flex;
        overflow-x: auto;
        gap: 1rem;
        padding: 1rem 0;
    }
    
    .forecast-month {
        min-width: 200px;
        background: white;
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .ml-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        color: white;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .optimization-alert {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        color: #333;
    }
    
    .risk-indicator {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }
    
    .risk-low { background: #28a745; }
    .risk-medium { background: #ffc107; }
    .risk-high { background: #dc3545; }
    
    .ai-insight {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="ml-dashboard">
    <div class="container-fluid">
        <!-- Quick Actions Navigation -->
        {% include 'quick_actions_nav.html' %}
        
        <!-- ML Header -->
        <div class="ml-header">
            <h1 class="mb-3"><i class="fas fa-brain me-3"></i>Machine Learning Insights</h1>
            <p class="lead mb-1">AI-powered predictive analytics for SPANKKS Construction</p>
            <small class="opacity-75">Confidence Level: {{ ml_insights.ml_confidence }} | Generated: {{ ml_insights.insights_generated }}</small>
        </div>

        <!-- Key ML Metrics -->
        <div class="row mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="ml-metric">
                    <div class="h3 mb-1">${{ "{:,.0f}".format(ml_insights.customer_lifetime_value.total_predicted_value) }}</div>
                    <div class="small">Predicted Customer Value</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="ml-metric">
                    <div class="h3 mb-1">{{ ml_insights.growth_forecast.annual_projection.growth_rate }}%</div>
                    <div class="small">Projected Growth Rate</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="ml-metric">
                    <div class="h3 mb-1">{{ ml_insights.crew_optimization.crew_requirements.recommended_size }}</div>
                    <div class="small">Optimal Crew Size</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="ml-metric">
                    <div class="h3 mb-1">{{ ml_insights.crew_optimization.crew_requirements.efficiency_score|round }}%</div>
                    <div class="small">Operational Efficiency</div>
                </div>
            </div>
        </div>

        <!-- Seasonal Demand Predictions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="ml-card">
                    <h4 class="mb-3"><i class="fas fa-calendar-alt me-2"></i>Seasonal Demand Predictions</h4>
                    <div class="row">
                        {% for month, data in ml_insights.seasonal_demand.items() %}
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-3">
                            <div class="seasonal-chart">
                                <h6 class="text-center">{{ month }}</h6>
                                <div class="text-center">
                                    <div class="h5 text-primary">{{ data.seasonal_factor }}x</div>
                                    <small class="text-muted">Seasonal Factor</small>
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">Growth: {{ data.predicted_growth }}%</small>
                                </div>
                                <div class="mt-1">
                                    <small>{{ data.weather_impact }}</small>
                                </div>
                                {% if data.top_services %}
                                <div class="mt-2">
                                    <small class="fw-bold">Top Services:</small>
                                    {% for service, count in data.top_services[:2] %}
                                    <div class="small">{{ service }} ({{ count }})</div>
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pricing Optimization -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="ml-card">
                    <h4 class="mb-3"><i class="fas fa-dollar-sign me-2"></i>AI-Powered Pricing Optimization</h4>
                    {% if ml_insights.pricing_optimization %}
                        {% for service, data in ml_insights.pricing_optimization.items() %}
                        <div class="pricing-recommendation {{ 'increase-price' if 'Increase' in data.strategy else 'decrease-price' if 'Reduce' in data.strategy else 'maintain-price' }}">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="mb-1">{{ service }}</h6>
                                    <p class="mb-1">{{ data.strategy }}</p>
                                    <small class="text-muted">Acceptance Rate: {{ data.acceptance_rate }}%</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="fw-bold">${{ "{:,.0f}".format(data.current_avg_price) }} â†’ ${{ "{:,.0f}".format(data.recommended_price) }}</div>
                                    <small class="text-success">Potential Impact: ${{ "{:,.0f}".format(data.potential_revenue_impact) }}</small>
                                    <div class="confidence-meter">
                                        <div class="confidence-fill" style="width: {{ data.confidence_level }}%"></div>
                                    </div>
                                    <small>{{ data.confidence_level }}% confidence</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <p>Pricing optimization requires additional quote data for analysis</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="ml-card">
                    <h5 class="mb-3"><i class="fas fa-robot me-2"></i>AI Recommendations</h5>
                    <div class="ai-insight">
                        <h6>Market Positioning</h6>
                        <p class="mb-1">Based on conversion patterns, your pricing is {{ 'competitive' if ml_insights.ml_confidence == 'High' else 'developing' }}.</p>
                    </div>
                    
                    <div class="ai-insight">
                        <h6>Seasonal Strategy</h6>
                        <p class="mb-1">Peak demand periods show 20-30% higher acceptance rates for premium pricing.</p>
                    </div>
                    
                    <div class="ai-insight">
                        <h6>Service Focus</h6>
                        <p class="mb-1">Drywall and flooring services show highest profit potential in Hawaii market.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Customer Lifetime Value Analysis -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="ml-card">
                    <h4 class="mb-3"><i class="fas fa-users me-2"></i>Customer Lifetime Value Predictions</h4>
                    {% if ml_insights.customer_lifetime_value.customer_predictions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Customer</th>
                                        <th>Current Value</th>
                                        <th>Predicted CLV</th>
                                        <th>Segment</th>
                                        <th>Risk Level</th>
                                        <th>Strategy</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for customer_id, data in ml_insights.customer_lifetime_value.customer_predictions.items() %}
                                    <tr>
                                        <td>Customer #{{ customer_id }}</td>
                                        <td>${{ "{:,.0f}".format(data.current_value) }}</td>
                                        <td class="fw-bold">${{ "{:,.0f}".format(data.predicted_clv) }}</td>
                                        <td>
                                            <span class="customer-segment {{ data.segment.lower().replace(' ', '-') }}">
                                                {{ data.segment }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="risk-indicator risk-{{ data.risk_level.lower() }}"></span>
                                            {{ data.risk_level }}
                                        </td>
                                        <td><small>{{ data.retention_strategy }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-user-friends fa-2x mb-2"></i>
                            <p>Customer value analysis requires invoice history data</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="ml-card">
                    <h5 class="mb-3"><i class="fas fa-pie-chart me-2"></i>Customer Segments</h5>
                    {% if ml_insights.customer_lifetime_value.segment_distribution %}
                        {% for segment, count in ml_insights.customer_lifetime_value.segment_distribution.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="customer-segment {{ segment.lower().replace(' ', '-') }}">{{ segment }}</span>
                            <span class="fw-bold">{{ count }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    <div class="mt-4">
                        <h6>Retention Insights</h6>
                        <div class="optimization-alert">
                            <small><strong>Priority:</strong> Focus on high-value customers with medium-high risk levels for retention campaigns.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Growth Forecast -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="ml-card">
                    <h4 class="mb-3"><i class="fas fa-chart-line me-2"></i>12-Month Growth Forecast</h4>
                    
                    <div class="growth-projection mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="h2">${{ "{:,.0f}".format(ml_insights.growth_forecast.annual_projection.revenue) }}</div>
                                <div>Projected Annual Revenue</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h2">{{ ml_insights.growth_forecast.annual_projection.growth_rate }}%</div>
                                <div>Growth Rate</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h2">+{{ ml_insights.growth_forecast.annual_projection.customer_growth }}</div>
                                <div>New Customers</div>
                            </div>
                            <div class="col-md-3">
                                <div class="h2">{{ ml_insights.growth_forecast.annual_projection.market_share_opportunity }}</div>
                                <div>Market Opportunity</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="forecast-timeline">
                        {% for forecast in ml_insights.growth_forecast.monthly_forecasts[:6] %}
                        <div class="forecast-month">
                            <h6>{{ forecast.month }}</h6>
                            <div class="h5 text-primary">${{ "{:,.0f}".format(forecast.projected_revenue) }}</div>
                            <small class="text-muted">Revenue</small>
                            <div class="mt-2">
                                <small>{{ forecast.projected_customers }} customers</small>
                            </div>
                            <div class="confidence-meter">
                                <div class="confidence-fill" style="width: {{ forecast.confidence_level }}%"></div>
                            </div>
                            <small>{{ forecast.confidence_level }}% confidence</small>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Crew Optimization -->
        <div class="row mb-4">
            <div class="col-lg-6">
                <div class="ml-card">
                    <h5 class="mb-3"><i class="fas fa-users-cog me-2"></i>Crew Optimization</h5>
                    <div class="optimization-alert">
                        <h6>Current Analysis</h6>
                        <p class="mb-1">Recommended crew size: <strong>{{ ml_insights.crew_optimization.crew_requirements.recommended_size }} members</strong></p>
                        <p class="mb-1">Current utilization: {{ ml_insights.crew_optimization.crew_requirements.current_utilization }}</p>
                        <p class="mb-0">Efficiency score: {{ ml_insights.crew_optimization.crew_requirements.efficiency_score|round }}%</p>
                    </div>
                    
                    {% if ml_insights.crew_optimization.peak_days %}
                    <div class="mt-3">
                        <h6>Peak Days Alert</h6>
                        {% for day in ml_insights.crew_optimization.peak_days[:3] %}
                        <div class="optimization-alert">
                            <small><strong>{{ day.date }}:</strong> {{ day.jobs }} jobs ({{ day.hours }} hours)</small><br>
                            <small>{{ day.recommendation }}</small>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="col-lg-6">
                <div class="ml-card">
                    <h5 class="mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Risk Factors</h5>
                    {% for risk in ml_insights.growth_forecast.risk_factors %}
                    <div class="optimization-alert">
                        <span class="risk-indicator risk-medium"></span>
                        <small>{{ risk }}</small>
                    </div>
                    {% endfor %}
                    
                    <h6 class="mt-3">Growth Opportunities</h6>
                    {% for opportunity in ml_insights.growth_forecast.growth_opportunities %}
                    <div class="optimization-alert">
                        <span class="risk-indicator risk-low"></span>
                        <small>{{ opportunity }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Action Center -->
        <div class="row">
            <div class="col-12">
                <div class="ml-card text-center">
                    <h5 class="mb-3">ML-Powered Actions</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <a href="{{ url_for('business_intelligence_dashboard') }}" class="btn btn-primary w-100 mb-2">
                                <i class="fas fa-chart-bar me-2"></i>Business Intelligence
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('analytics_dashboard') }}" class="btn btn-success w-100 mb-2">
                                <i class="fas fa-analytics me-2"></i>Advanced Analytics
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('crm_dashboard') }}" class="btn btn-info w-100 mb-2">
                                <i class="fas fa-users me-2"></i>Customer Management
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary w-100 mb-2">
                                <i class="fas fa-tachometer-alt me-2"></i>Operations Center
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh every 15 minutes for updated ML insights
document.addEventListener('DOMContentLoaded', function() {
    setInterval(function() {
        location.reload();
    }, 900000);
});
</script>
{% endblock %}