<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-users-cog me-2"></i>Staff CRM Management
        </h3>
        <div class="btn-group">
            <button class="btn btn-success btn-sm" onclick="showStaffLoginModal()">
                <i class="fas fa-key me-1"></i>Staff Access
            </button>
            <button class="btn btn-outline-secondary btn-sm" onclick="refreshClientData()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Staff Authentication Notice -->
        <div id="staff-auth-notice" class="alert alert-warning">
            <i class="fas fa-lock me-2"></i>
            <strong>Staff Access Required:</strong> Please authenticate with your staff PIN to access customer management features.
        </div>

        <!-- Staff CRM Interface (Hidden until authenticated) -->
        <div id="staff-crm-interface" class="d-none">
            <!-- Search and Filter Controls -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="clientSearch" placeholder="Search clients by name, phone, or email...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="statusFilter">
                        <option value="all">All Clients</option>
                        <option value="active">Active</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button class="btn btn-spankks btn-sm w-100" onclick="showAddClientModal()">
                        <i class="fas fa-user-plus me-1"></i>Add New Client
                    </button>
                </div>
            </div>

            <!-- Client Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalClients">0</div>
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-change">
                            <i class="fas fa-users me-1"></i>Active
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRevenue">$0</div>
                        <div class="stat-label">Total Revenue</div>
                        <div class="stat-change positive">
                            <i class="fas fa-dollar-sign me-1"></i>Lifetime
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="activeJobs">0</div>
                        <div class="stat-label">Active Jobs</div>
                        <div class="stat-change">
                            <i class="fas fa-tools me-1"></i>In Progress
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-value" id="pendingFollowups">0</div>
                        <div class="stat-label">Follow-ups</div>
                        <div class="stat-change warning">
                            <i class="fas fa-clock me-1"></i>Pending
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Management Table -->
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Client</th>
                            <th>Contact</th>
                            <th>Jobs</th>
                            <th>Revenue</th>
                            <th>Status</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-table-body">
                        <!-- Populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Staff Authentication Modal -->
<div class="modal fade" id="staffLoginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-shield me-2"></i>Staff Authentication
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="staffAuthForm">
                    <div class="mb-3">
                        <label class="form-label">Staff ID</label>
                        <input type="text" class="form-control" id="staffId" placeholder="Enter your staff ID">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Access PIN</label>
                        <input type="password" class="form-control" id="staffPin" placeholder="Enter your PIN">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="rememberAuth">
                        <label class="form-check-label" for="rememberAuth">
                            Remember authentication for this session
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="authenticateStaff()">
                    <i class="fas fa-unlock me-1"></i>Access CRM
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Client Details Modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientModalTitle">Client Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="clientModalBody">
                    <!-- Content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="editClientMode()">
                    <i class="fas fa-edit me-1"></i>Edit Client
                </button>
                <button type="button" class="btn btn-spankks" onclick="saveClientChanges()">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add New Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>Add New Client
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addClientForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Client Name *</label>
                                <input type="text" class="form-control" name="client_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Phone Number *</label>
                                <input type="tel" class="form-control" name="client_phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" name="client_email">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Service Type</label>
                                <select class="form-select" name="service_type">
                                    <option value="">Select Service</option>
                                    <option value="Drywall Services">Drywall Services</option>
                                    <option value="Flooring Installation">Flooring Installation</option>
                                    <option value="Fence Building">Fence Building</option>
                                    <option value="General Handyman">General Handyman</option>
                                    <option value="Home Renovation">Home Renovation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="createNewClient()">
                    <i class="fas fa-user-plus me-1"></i>Create Client
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    background: white;
    border-radius: 0.5rem;
    padding: 1.5rem;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid var(--spankks-green);
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--spankks-green);
    margin-bottom: 0.5rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6c757d;
    margin-bottom: 0.25rem;
}

.stat-change {
    font-size: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.25rem;
}

.stat-change.positive {
    color: #28a745;
}

.stat-change.warning {
    color: #ffc107;
}

.client-row {
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.client-row:hover {
    background-color: #f8f9fa;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 1rem;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-active {
    background-color: #d4edda;
    color: #155724;
}

.status-pending {
    background-color: #fff3cd;
    color: #856404;
}

.status-completed {
    background-color: #d1ecf1;
    color: #0c5460;
}

.action-btn {
    padding: 0.25rem 0.5rem;
    margin: 0 0.125rem;
    border-radius: 0.25rem;
    border: none;
    font-size: 0.75rem;
}

.action-btn:hover {
    opacity: 0.8;
}

.modal-header {
    background: var(--spankks-green);
    color: white;
}

.modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

#clientModalBody {
    min-height: 400px;
}

.client-detail-section {
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 0.5rem;
    border-left: 4px solid var(--spankks-green);
}

.client-detail-section h6 {
    color: var(--spankks-green);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
}

.photo-item {
    position: relative;
    border-radius: 0.5rem;
    overflow: hidden;
    aspect-ratio: 1;
    background: #e9ecef;
}

.photo-item img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.photo-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 0.5rem;
    font-size: 0.75rem;
}

.checklist-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    background: white;
}

.checklist-item.completed {
    background: #d4edda;
    border-color: #c3e6cb;
}

.notes-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-top: 1rem;
}

.note-item {
    padding: 0.75rem;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 0.75rem;
}

.note-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}

.note-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.note-author {
    font-weight: 600;
    color: var(--spankks-green);
}

.note-date {
    font-size: 0.75rem;
    color: #6c757d;
}

.note-content {
    color: #495057;
}
</style>

<script>
let staffAuthenticated = false;
let currentClientData = null;
let editMode = false;

// Staff Authentication
function showStaffLoginModal() {
    const modal = new bootstrap.Modal(document.getElementById('staffLoginModal'));
    modal.show();
}

function authenticateStaff() {
    const staffId = document.getElementById('staffId').value;
    const staffPin = document.getElementById('staffPin').value;
    
    if (!staffId || !staffPin) {
        showToast('Please enter both Staff ID and PIN', 'warning');
        return;
    }
    
    // Authenticate with backend
    fetch('/api/staff/authenticate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            staff_id: staffId,
            pin: staffPin
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            staffAuthenticated = true;
            showToast('Staff authentication successful', 'success');
            bootstrap.Modal.getInstance(document.getElementById('staffLoginModal')).hide();
            
            // Show CRM interface
            document.getElementById('staff-auth-notice').classList.add('d-none');
            document.getElementById('staff-crm-interface').classList.remove('d-none');
            
            // Load client data
            loadClientData();
        } else {
            showToast('Invalid credentials. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Authentication error:', error);
        showToast('Authentication failed. Please try again.', 'error');
    });
}

// Client Data Management
function loadClientData() {
    if (!staffAuthenticated) {
        showToast('Staff authentication required', 'warning');
        return;
    }
    
    fetch('/api/clients/staff-view')
        .then(response => response.json())
        .then(clients => {
            updateClientStats(clients);
            renderClientTable(clients);
        })
        .catch(error => {
            console.error('Error loading client data:', error);
            showToast('Error loading client data', 'error');
        });
}

function updateClientStats(clients) {
    const totalClients = clients.length;
    const totalRevenue = clients.reduce((sum, client) => sum + (client.total_revenue || 0), 0);
    const activeJobs = clients.reduce((sum, client) => sum + (client.active_jobs || 0), 0);
    const pendingFollowups = clients.filter(client => client.follow_up_required).length;
    
    document.getElementById('totalClients').textContent = totalClients;
    document.getElementById('totalRevenue').textContent = `$${totalRevenue.toLocaleString()}`;
    document.getElementById('activeJobs').textContent = activeJobs;
    document.getElementById('pendingFollowups').textContent = pendingFollowups;
}

function renderClientTable(clients) {
    const tbody = document.getElementById('client-table-body');
    
    if (clients.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="fas fa-users fa-2x mb-2"></i><br>
                    No clients found. Add your first client to get started.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = clients.map(client => `
        <tr class="client-row" onclick="openClientModal('view', '${client.client_id}')">
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2">${client.client_name.charAt(0).toUpperCase()}</div>
                    <div>
                        <div class="fw-bold">${client.client_name}</div>
                        <div class="text-muted small">${client.client_id}</div>
                    </div>
                </div>
            </td>
            <td>
                <div>${client.client_email || 'No email'}</div>
                <div class="text-muted small">${client.client_phone}</div>
            </td>
            <td>
                <span class="badge bg-info">${client.total_jobs || 0} jobs</span>
            </td>
            <td>
                <div class="fw-bold text-success">$${(client.total_revenue || 0).toLocaleString()}</div>
            </td>
            <td>
                <span class="status-badge status-${client.status || 'active'}">${(client.status || 'active').charAt(0).toUpperCase() + (client.status || 'active').slice(1)}</span>
            </td>
            <td>
                <div class="small">${client.last_activity || 'No recent activity'}</div>
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="action-btn btn btn-outline-primary" onclick="event.stopPropagation(); openClientModal('view', '${client.client_id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn btn btn-outline-info" onclick="event.stopPropagation(); openClientModal('photos', '${client.client_id}')" title="Photos">
                        <i class="fas fa-camera"></i>
                    </button>
                    <button class="action-btn btn btn-outline-warning" onclick="event.stopPropagation(); openClientModal('notes', '${client.client_id}')" title="Notes">
                        <i class="fas fa-sticky-note"></i>
                    </button>
                    <button class="action-btn btn btn-outline-success" onclick="event.stopPropagation(); openClientModal('checklist', '${client.client_id}')" title="Checklist">
                        <i class="fas fa-tasks"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Modal Management
function openClientModal(type, clientId) {
    if (!staffAuthenticated) {
        showToast('Staff authentication required', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('clientModal'));
    const title = document.getElementById('clientModalTitle');
    const body = document.getElementById('clientModalBody');
    
    // Load client data
    fetch(`/api/clients/${clientId}/details`)
        .then(response => response.json())
        .then(client => {
            currentClientData = client;
            
            let content = '';
            switch (type) {
                case 'view':
                    title.textContent = `${client.client_name} - Overview`;
                    content = generateClientOverview(client);
                    break;
                case 'photos':
                    title.textContent = `${client.client_name} - Job Photos`;
                    content = generatePhotoSection(client);
                    break;
                case 'notes':
                    title.textContent = `${client.client_name} - Staff Notes`;
                    content = generateNotesSection(client);
                    break;
                case 'checklist':
                    title.textContent = `${client.client_name} - Job Checklist`;
                    content = generateChecklistSection(client);
                    break;
            }
            
            body.innerHTML = content;
            modal.show();
        })
        .catch(error => {
            console.error('Error loading client details:', error);
            showToast('Error loading client details', 'error');
        });
}

function generateClientOverview(client) {
    return `
        <div class="client-detail-section">
            <h6><i class="fas fa-user"></i>Client Information</h6>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Name:</strong> ${client.client_name}</p>
                    <p><strong>Phone:</strong> ${client.client_phone}</p>
                    <p><strong>Email:</strong> ${client.client_email || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Client ID:</strong> ${client.client_id}</p>
                    <p><strong>Status:</strong> <span class="status-badge status-${client.status || 'active'}">${(client.status || 'active').charAt(0).toUpperCase() + (client.status || 'active').slice(1)}</span></p>
                    <p><strong>Member Since:</strong> ${client.created_date || 'Unknown'}</p>
                </div>
            </div>
            <p><strong>Address:</strong> ${client.address || 'Not provided'}</p>
        </div>
        
        <div class="client-detail-section">
            <h6><i class="fas fa-chart-line"></i>Business Summary</h6>
            <div class="row">
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h4 text-success">${client.total_jobs || 0}</div>
                        <div class="small text-muted">Total Jobs</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h4 text-success">$${(client.total_revenue || 0).toLocaleString()}</div>
                        <div class="small text-muted">Total Revenue</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h4 text-info">${client.active_jobs || 0}</div>
                        <div class="small text-muted">Active Jobs</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center">
                        <div class="h4 text-warning">${client.pending_quotes || 0}</div>
                        <div class="small text-muted">Pending Quotes</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="client-detail-section">
            <h6><i class="fas fa-history"></i>Recent Activity</h6>
            <div class="timeline">
                ${generateRecentActivity(client.recent_activity || [])}
            </div>
        </div>
    `;
}

function generatePhotoSection(client) {
    const photos = client.photos || [];
    
    return `
        <div class="client-detail-section">
            <h6><i class="fas fa-camera"></i>Job Photos</h6>
            <div class="mb-3">
                <button class="btn btn-outline-spankks btn-sm" onclick="uploadNewPhoto('${client.client_id}')">
                    <i class="fas fa-plus me-1"></i>Upload New Photo
                </button>
            </div>
            <div class="photo-grid">
                ${photos.length > 0 ? photos.map(photo => `
                    <div class="photo-item">
                        <img src="${photo.url}" alt="${photo.description}" onclick="viewFullPhoto('${photo.url}')">
                        <div class="photo-overlay">
                            <div>${photo.description}</div>
                            <div class="small">${photo.date}</div>
                        </div>
                    </div>
                `).join('') : '<p class="text-muted">No photos uploaded yet.</p>'}
            </div>
        </div>
    `;
}

function generateNotesSection(client) {
    const notes = client.staff_notes || [];
    
    return `
        <div class="client-detail-section">
            <h6><i class="fas fa-sticky-note"></i>Staff Notes</h6>
            <div class="mb-3">
                <button class="btn btn-outline-spankks btn-sm" onclick="addNewNote('${client.client_id}')">
                    <i class="fas fa-plus me-1"></i>Add Note
                </button>
            </div>
            <div class="notes-section">
                ${notes.length > 0 ? notes.map(note => `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-author">${note.author}</span>
                            <span class="note-date">${note.date}</span>
                        </div>
                        <div class="note-content">${note.content}</div>
                    </div>
                `).join('') : '<p class="text-muted">No notes added yet.</p>'}
            </div>
        </div>
    `;
}

function generateChecklistSection(client) {
    const checklists = client.job_checklists || [];
    
    return `
        <div class="client-detail-section">
            <h6><i class="fas fa-tasks"></i>Job Checklists</h6>
            ${checklists.length > 0 ? checklists.map(checklist => `
                <div class="mb-4">
                    <h6 class="text-muted">${checklist.job_title} (${checklist.date})</h6>
                    ${checklist.items.map(item => `
                        <div class="checklist-item ${item.completed ? 'completed' : ''}">
                            <input type="checkbox" ${item.completed ? 'checked' : ''} 
                                onchange="updateChecklistItem('${client.client_id}', '${checklist.id}', '${item.id}', this.checked)">
                            <span>${item.description}</span>
                            ${item.notes ? `<small class="text-muted ms-auto">${item.notes}</small>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('') : '<p class="text-muted">No checklists created yet.</p>'}
        </div>
    `;
}

function generateRecentActivity(activities) {
    if (activities.length === 0) {
        return '<p class="text-muted">No recent activity.</p>';
    }
    
    return activities.map(activity => `
        <div class="d-flex align-items-center mb-2">
            <div class="activity-icon me-3">
                <i class="fas fa-${activity.icon || 'circle'} text-${activity.type || 'secondary'}"></i>
            </div>
            <div class="flex-grow-1">
                <div>${activity.description}</div>
                <div class="small text-muted">${activity.date}</div>
            </div>
        </div>
    `).join('');
}

// Utility Functions
function refreshClientData() {
    if (staffAuthenticated) {
        loadClientData();
        showToast('Client data refreshed', 'info');
    } else {
        showToast('Please authenticate first', 'warning');
    }
}

function showAddClientModal() {
    if (!staffAuthenticated) {
        showToast('Staff authentication required', 'warning');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('addClientModal'));
    modal.show();
}

function createNewClient() {
    const form = document.getElementById('addClientForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('/api/clients/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showToast('Client created successfully', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addClientModal')).hide();
            loadClientData();
            form.reset();
        } else {
            showToast('Error creating client: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating client:', error);
        showToast('Error creating client', 'error');
    });
}

function editClientMode() {
    editMode = !editMode;
    // Toggle edit mode UI
    showToast(editMode ? 'Edit mode enabled' : 'Edit mode disabled', 'info');
}

function saveClientChanges() {
    if (!editMode || !currentClientData) {
        showToast('No changes to save', 'info');
        return;
    }
    
    // Save changes logic
    showToast('Changes saved successfully', 'success');
    editMode = false;
}

// Search and Filter
document.getElementById('clientSearch')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    filterClientTable(searchTerm);
});

document.getElementById('statusFilter')?.addEventListener('change', function(e) {
    const status = e.target.value;
    filterClientTableByStatus(status);
});

function filterClientTable(searchTerm) {
    const rows = document.querySelectorAll('#client-table-body tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function filterClientTableByStatus(status) {
    const rows = document.querySelectorAll('#client-table-body tr');
    
    rows.forEach(row => {
        if (status === 'all') {
            row.style.display = '';
        } else {
            const statusBadge = row.querySelector('.status-badge');
            const rowStatus = statusBadge ? statusBadge.textContent.toLowerCase() : '';
            row.style.display = rowStatus === status ? '' : 'none';
        }
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check if staff is already authenticated
    const savedAuth = sessionStorage.getItem('staffAuthenticated');
    if (savedAuth === 'true') {
        staffAuthenticated = true;
        document.getElementById('staff-auth-notice').classList.add('d-none');
        document.getElementById('staff-crm-interface').classList.remove('d-none');
        loadClientData();
    }
});
</script>