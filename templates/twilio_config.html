{% extends "base.html" %}

{% block title %}Twilio SendGrid Configuration - SPANK Admin{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-cog me-2"></i>Twilio SendGrid Configuration</h3>
                </div>
                <div class="card-body p-4">
                    <form id="twilioConfigForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="twilioSid" class="form-label">Twilio Account SID</label>
                                <input type="text" class="form-control" id="twilioSid" value="US56bbfe10c643f708191c41349097faa4" required>
                                <div class="form-text">Your Twilio Account SID (starts with AC)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="twilioToken" class="form-label">Twilio Auth Token</label>
                                <input type="password" class="form-control" id="twilioToken" placeholder="Enter your auth token" required>
                                <div class="form-text">Your Twilio authentication token</div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="twilioPhone" class="form-label">Twilio Phone Number</label>
                                <input type="tel" class="form-control" id="twilioPhone" placeholder="+18085551234" required>
                                <div class="form-text">Your Twilio phone number (with country code)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sendgridKey" class="form-label">SendGrid API Key</label>
                                <input type="password" class="form-control" id="sendgridKey" placeholder="SG.xxxxx" required>
                                <div class="form-text">Your SendGrid API key</div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h5 class="mb-3">Test Configuration</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="testPhone" class="form-label">Test Phone Number</label>
                                <input type="tel" class="form-control" id="testPhone" placeholder="+18085551234">
                                <div class="form-text">Phone number for SMS test</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="testEmail" class="form-label">Test Email Address</label>
                                <input type="email" class="form-control" id="testEmail" placeholder="test@example.com">
                                <div class="form-text">Email address for email test</div>
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-outline-primary" onclick="testSMS()">
                                <i class="fas fa-sms me-2"></i>Test SMS
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="testEmail()">
                                <i class="fas fa-envelope me-2"></i>Test Email
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Configuration
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Test Results -->
            <div id="testResults" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Test Results</h5>
                    </div>
                    <div class="card-body">
                        <div id="testOutput"></div>
                    </div>
                </div>
            </div>
            
            <!-- Current Configuration Status -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">Configuration Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i id="twilioStatus" class="fas fa-times-circle text-danger fa-2x"></i>
                                <div class="mt-2">Twilio SMS</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i id="sendgridStatus" class="fas fa-times-circle text-danger fa-2x"></i>
                                <div class="mt-2">SendGrid Email</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i id="integrationStatus" class="fas fa-times-circle text-danger fa-2x"></i>
                                <div class="mt-2">Integration</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i id="rewardsStatus" class="fas fa-times-circle text-danger fa-2x"></i>
                                <div class="mt-2">SPANK Bucks</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function testSMS() {
    const phone = document.getElementById('testPhone').value;
    if (!phone) {
        alert('Please enter a test phone number');
        return;
    }
    
    showTestResults('Testing SMS...', 'info');
    
    fetch('/api/test-sms', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            phone: phone,
            twilio_sid: document.getElementById('twilioSid').value,
            twilio_token: document.getElementById('twilioToken').value,
            twilio_phone: document.getElementById('twilioPhone').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showTestResults('SMS sent successfully!', 'success');
            updateStatus('twilioStatus', true);
        } else {
            showTestResults(`SMS failed: ${data.error}`, 'danger');
            updateStatus('twilioStatus', false);
        }
    })
    .catch(error => {
        showTestResults(`SMS test error: ${error}`, 'danger');
        updateStatus('twilioStatus', false);
    });
}

function testEmail() {
    const email = document.getElementById('testEmail').value;
    if (!email) {
        alert('Please enter a test email address');
        return;
    }
    
    showTestResults('Testing email...', 'info');
    
    fetch('/api/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email: email,
            sendgrid_key: document.getElementById('sendgridKey').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showTestResults('Email sent successfully!', 'success');
            updateStatus('sendgridStatus', true);
        } else {
            showTestResults(`Email failed: ${data.error}`, 'danger');
            updateStatus('sendgridStatus', false);
        }
    })
    .catch(error => {
        showTestResults(`Email test error: ${error}`, 'danger');
        updateStatus('sendgridStatus', false);
    });
}

function showTestResults(message, type) {
    const resultsDiv = document.getElementById('testResults');
    const outputDiv = document.getElementById('testOutput');
    
    outputDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    resultsDiv.style.display = 'block';
}

function updateStatus(elementId, success) {
    const element = document.getElementById(elementId);
    if (success) {
        element.className = 'fas fa-check-circle text-success fa-2x';
    } else {
        element.className = 'fas fa-times-circle text-danger fa-2x';
    }
}

// Form submission
document.getElementById('twilioConfigForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = {
        twilio_sid: document.getElementById('twilioSid').value,
        twilio_token: document.getElementById('twilioToken').value,
        twilio_phone: document.getElementById('twilioPhone').value,
        sendgrid_key: document.getElementById('sendgridKey').value
    };
    
    fetch('/api/save-twilio-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showTestResults('Configuration saved successfully!', 'success');
            updateStatus('integrationStatus', true);
            updateStatus('rewardsStatus', true);
        } else {
            showTestResults(`Configuration save failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showTestResults(`Save error: ${error}`, 'danger');
    });
});

// Check current status on page load
window.addEventListener('load', function() {
    fetch('/api/check-twilio-status')
        .then(response => response.json())
        .then(data => {
            updateStatus('twilioStatus', data.twilio_configured);
            updateStatus('sendgridStatus', data.sendgrid_configured);
            updateStatus('integrationStatus', data.integration_ready);
            updateStatus('rewardsStatus', data.rewards_enabled);
        });
});
</script>
{% endblock %}