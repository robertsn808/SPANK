<!-- CRM Dashboard Widgets -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-header">
                <i class="fas fa-users text-primary"></i>
                <span class="metric-title">Total Contacts</span>
            </div>
            <div class="metric-value" id="totalContacts">9</div>
            <div class="metric-trend">+3 this week</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-header">
                <i class="fas fa-chart-line text-success"></i>
                <span class="metric-title">Conversion Rate</span>
            </div>
            <div class="metric-value" id="conversionRate">0%</div>
            <div class="metric-trend">New system</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-header">
                <i class="fas fa-dollar-sign text-info"></i>
                <span class="metric-title">Total Revenue</span>
            </div>
            <div class="metric-value" id="totalRevenue">$0</div>
            <div class="metric-trend">Ready to grow</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-header">
                <i class="fas fa-hourglass-half text-warning"></i>
                <span class="metric-title">Pipeline Value</span>
            </div>
            <div class="metric-value" id="pipelineValue">$0</div>
            <div class="metric-trend">Getting started</div>
        </div>
    </div>
</div>

<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-address-book me-2"></i>Customer CRM
        </h3>
        <div class="btn-group">
            <button class="btn btn-spankks btn-sm" onclick="showAddContactModal()">
                <i class="fas fa-user-plus me-1"></i>Add Contact
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="loadContactsNow()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>

    <div class="card-body">
        <!-- Search and Filter -->
        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="contactSearch" placeholder="Search contacts...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="contactFilter">
                    <option value="">All Contacts</option>
                    <option value="active">Active</option>
                    <option value="potential">Potential</option>
                    <option value="completed">Completed</option>
                </select>
            </div>
            <div class="col-md-3">
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear Filters
                </button>
            </div>
        </div>

        <!-- Contacts Table -->
        <div class="table-responsive">
            <table class="table table-hover" id="contactsTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Service Type</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="contactsTableBody">
                    <!-- Contacts will be loaded here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Immediate execution CRM functionality
(function() {
    console.log('üöÄ CRM Section loaded, initializing contacts...');
    
    // Load contacts immediately
    loadContactsNow();
    
    function loadContactsNow() {
        const tableBody = document.getElementById('contactsTableBody');
        if (!tableBody) {
            console.error('‚ùå Contact table body not found');
            return;
        }
        
        console.log('üìû Fetching contacts from API...');
        tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading contacts...</td></tr>';
        
        fetch('/api/contacts')
            .then(response => {
                console.log('üì° API Response Status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(contacts => {
                console.log('‚úÖ Contacts loaded:', contacts.length, 'total');
                displayContacts(contacts);
            })
            .catch(error => {
                console.error('‚ùå Error loading contacts:', error);
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading contacts: ${error.message}
                            <br><small>Check console for details</small>
                        </td>
                    </tr>
                `;
            });
    }
    
    function displayContacts(contacts) {
        const tableBody = document.getElementById('contactsTableBody');
        
        if (!contacts || contacts.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            No contacts found. Add your first contact to get started.
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        console.log('üé® Rendering', contacts.length, 'contacts in table');
        
        const rows = contacts.map(contact => {
            const statusColor = getStatusBadgeColor(contact.status || 'active');
            const serviceType = contact.service_type || 'General';
            const createdDate = contact.created_date || 'Unknown';
            
            return `
                <tr data-contact-id="${contact.id}">
                    <td>
                        <div>
                            <strong>${contact.name || 'Unknown'}</strong>
                            ${contact.address ? `<br><small class="text-muted">${contact.address}</small>` : ''}
                            <br><small class="text-info">${contact.source || 'Database'}</small>
                        </div>
                    </td>
                    <td>
                        ${contact.phone ? `<a href="tel:${contact.phone}" class="text-decoration-none">${contact.phone}</a>` : '<span class="text-muted">No phone</span>'}
                    </td>
                    <td>
                        ${contact.email ? `<a href="mailto:${contact.email}" class="text-decoration-none">${contact.email}</a>` : '<span class="text-muted">No email</span>'}
                    </td>
                    <td>
                        <span class="badge bg-secondary">${serviceType}</span>
                    </td>
                    <td>
                        <span class="badge bg-${statusColor}">${(contact.status || 'active').charAt(0).toUpperCase() + (contact.status || 'active').slice(1)}</span>
                    </td>
                    <td>
                        <small>${createdDate}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="viewContact('${contact.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="createQuote('${contact.id}')" title="Create Quote">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="editContact('${contact.id}')" title="Edit Contact">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
        tableBody.innerHTML = rows;
        console.log('‚úÖ Table updated with', contacts.length, 'contacts');
    }
    
    function getStatusBadgeColor(status) {
        const colors = {
            'active': 'success',
            'potential': 'warning', 
            'completed': 'info',
            'inactive': 'secondary'
        };
        return colors[status.toLowerCase()] || 'secondary';
    }
    
    // Global functions for button actions
    window.loadContactsNow = loadContactsNow;
    
    window.viewContact = function(contactId) {
        alert(`View contact details for ID: ${contactId}`);
    };
    
    window.createQuote = function(contactId) {
        const url = `/admin/quote-invoice-form?contactId=${contactId}`;
        window.open(url, '_blank');
    };
    
    window.editContact = function(contactId) {
        alert(`Edit contact functionality for ID: ${contactId} - Coming soon`);
    };
    
    window.showAddContactModal = function() {
        alert('Add contact modal - Coming soon');
    };
    
    window.clearFilters = function() {
        document.getElementById('contactSearch').value = '';
        document.getElementById('contactFilter').value = '';
        loadContactsNow();
    };
    
    // Auto-refresh every 30 seconds
    setInterval(loadContactsNow, 30000);
    
    console.log('‚úÖ CRM system fully initialized');
})();
</script>

<style>
.metric-card {
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid #e0e0e0;
    height: 100%;
    transition: transform 0.2s;
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.metric-header {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
}

.metric-header i {
    font-size: 1.2rem;
    margin-right: 0.5rem;
}

.metric-title {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
}

.metric-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--spankks-green);
    margin-bottom: 0.5rem;
}

.metric-trend {
    font-size: 0.75rem;
    color: #6c757d;
}

.content-card {
    background: white;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    overflow: hidden;
}

.card-header {
    background: linear-gradient(135deg, var(--spankks-green) 0%, #1e7e34 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-bottom: none;
}

.card-title {
    margin: 0;
    font-size: 1.125rem;
    font-weight: 600;
}

.card-body {
    padding: 1.5rem;
}

.table th {
    font-weight: 600;
    color: #495057;
    border-bottom: 2px solid #dee2e6;
}

.table td {
    vertical-align: middle;
}

.table-hover tbody tr:hover {
    background-color: #f8f9fa;
}

.loading-spinner {
    display: inline-block;
    width: 1rem;
    height: 1rem;
    border: 2px solid #f3f3f3;
    border-top: 2px solid var(--spankks-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>