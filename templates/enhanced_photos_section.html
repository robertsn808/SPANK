<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-camera me-2"></i>Job Photo Documentation
        </h3>
        <div class="btn-group">
            <button class="btn btn-spankks btn-sm" onclick="showUploadModal()">
                <i class="fas fa-upload me-1"></i>Upload Photos
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="loadPhotoStats()">
                <i class="fas fa-chart-bar me-1"></i>Gallery Stats
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Photo Gallery Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalPhotos">0</div>
                    <div class="stat-label">Total Photos</div>
                    <div class="stat-change">
                        <i class="fas fa-images me-1"></i>All Jobs
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="uploadsToday">0</div>
                    <div class="stat-label">Uploaded Today</div>
                    <div class="stat-change positive">
                        <i class="fas fa-calendar-day me-1"></i>Recent
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="gallerySize">0 MB</div>
                    <div class="stat-label">Gallery Size</div>
                    <div class="stat-change">
                        <i class="fas fa-hdd me-1"></i>Storage
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="beforeAfterPairs">0</div>
                    <div class="stat-label">Before/After</div>
                    <div class="stat-change">
                        <i class="fas fa-sync-alt me-1"></i>Comparisons
                    </div>
                </div>
            </div>
        </div>

        <!-- Photo Management Tabs -->
        <ul class="nav nav-tabs mb-4" id="photoTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="gallery-tab" data-bs-toggle="tab" data-bs-target="#gallery" type="button" role="tab">
                    <i class="fas fa-images me-1"></i>Photo Gallery
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="before-after-tab" data-bs-toggle="tab" data-bs-target="#before-after" type="button" role="tab">
                    <i class="fas fa-sync-alt me-1"></i>Before/After
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="by-job-tab" data-bs-toggle="tab" data-bs-target="#by-job" type="button" role="tab">
                    <i class="fas fa-folder me-1"></i>By Job
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="photoTabContent">
            <!-- Photo Gallery Tab -->
            <div class="tab-pane fade show active" id="gallery" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Search photos..." id="photoSearch">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="photoTypeFilter">
                            <option value="">All Types</option>
                            <option value="before">Before</option>
                            <option value="after">After</option>
                            <option value="progress">Progress</option>
                            <option value="materials">Materials</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="jobFilter">
                            <option value="">All Jobs</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-success" onclick="refreshPhotoGallery()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div id="photoGallery" class="row">
                    <div class="col-12 text-center py-5">
                        <div class="loading-spinner me-2"></div>
                        Loading photo gallery...
                    </div>
                </div>
            </div>
            
            <!-- Before/After Comparison Tab -->
            <div class="tab-pane fade" id="before-after" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <select class="form-select" id="comparisonJobFilter">
                            <option value="">Select Job for Comparison</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-spankks" onclick="loadBeforeAfterComparisons()">
                            <i class="fas fa-search me-1"></i>Load Comparisons
                        </button>
                    </div>
                </div>
                
                <div id="beforeAfterGallery">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-sync-alt fa-3x mb-3"></i>
                        <div>Select a job to view before/after photo comparisons</div>
                    </div>
                </div>
            </div>
            
            <!-- By Job Tab -->
            <div class="tab-pane fade" id="by-job" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-8">
                        <select class="form-select" id="jobPhotoFilter">
                            <option value="">Select Job to View Photos</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success" onclick="loadJobPhotos()">
                            <i class="fas fa-folder-open me-1"></i>Load Photos
                        </button>
                    </div>
                </div>
                
                <div id="jobPhotoGallery">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-folder-open fa-3x mb-3"></i>
                        <div>Select a job to view all associated photos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Photo Modal -->
<div class="modal fade" id="uploadPhotoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Upload Job Photos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="photoUploadForm" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Job ID</label>
                            <input type="text" class="form-control" name="job_id" required placeholder="Enter job ID">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Photo Type</label>
                            <select class="form-select" name="photo_type" required>
                                <option value="">Select Type</option>
                                <option value="before">Before</option>
                                <option value="after">After</option>
                                <option value="progress">Progress</option>
                                <option value="materials">Materials</option>
                                <option value="completion">Completion</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Photos</label>
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-placeholder">
                                <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                                <p>Drag and drop photos here or click to select</p>
                                <p class="text-muted small">Maximum 16MB per file. Supports JPG, PNG, HEIC</p>
                            </div>
                            <input type="file" id="photoFiles" name="photos" multiple accept=".jpg,.jpeg,.png,.heic" style="display: none;">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Location (GPS)</label>
                            <input type="text" class="form-control" name="location" placeholder="Auto-detected or manual entry">
                            <button type="button" class="btn btn-sm btn-outline-primary mt-1" onclick="getGPSLocation()">
                                <i class="fas fa-map-marker-alt me-1"></i>Get Current Location
                            </button>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Staff Member</label>
                            <select class="form-select" name="staff_id">
                                <option value="STF001">SPANKKS Admin</option>
                                <option value="STF002">Mike Johnson</option>
                                <option value="STF003">Carlos Rodriguez</option>
                                <option value="STF004">Keoni Nakamura</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Description/Notes</label>
                        <textarea class="form-control" name="description" rows="3" placeholder="Add notes about these photos"></textarea>
                    </div>
                    
                    <div id="uploadPreview" class="d-none">
                        <h6>Files to Upload:</h6>
                        <div id="fileList"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="uploadPhotos()" id="uploadBtn">
                    <i class="fas fa-upload me-1"></i>Upload Photos
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Photo Detail Modal -->
<div class="modal fade" id="photoDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="photoDetailTitle">Photo Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="photo-display text-center">
                            <img id="photoDetailImage" src="" alt="Photo" class="img-fluid" style="max-height: 500px;">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="photo-metadata">
                            <h6>Photo Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td><strong>Job ID:</strong></td>
                                    <td id="photoJobId">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Type:</strong></td>
                                    <td id="photoType">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Upload Date:</strong></td>
                                    <td id="photoUploadDate">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Uploaded By:</strong></td>
                                    <td id="photoUploadedBy">-</td>
                                </tr>
                                <tr>
                                    <td><strong>File Size:</strong></td>
                                    <td id="photoFileSize">-</td>
                                </tr>
                                <tr>
                                    <td><strong>Location:</strong></td>
                                    <td id="photoLocation">-</td>
                                </tr>
                            </table>
                            
                            <div class="photo-actions mt-3">
                                <button class="btn btn-sm btn-warning" onclick="setCoverPhoto()">
                                    <i class="fas fa-star me-1"></i>Set as Cover
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePhoto()">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                            
                            <div class="photo-notes mt-3">
                                <label class="form-label">Notes:</label>
                                <textarea class="form-control" id="photoNotes" rows="3"></textarea>
                                <button class="btn btn-sm btn-success mt-2" onclick="savePhotoNote()">
                                    <i class="fas fa-save me-1"></i>Save Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.upload-area {
    border: 2px dashed var(--spankks-green);
    border-radius: 0.5rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-area:hover {
    background: #f0fff4;
    border-color: #1e7e34;
}

.upload-area.dragover {
    background: #e8f5e8;
    border-color: #1e7e34;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 1rem;
}

.photo-card {
    background: white;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    cursor: pointer;
}

.photo-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.photo-card img {
    width: 100%;
    height: 150px;
    object-fit: cover;
}

.photo-card-body {
    padding: 0.75rem;
}

.photo-type-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    font-size: 0.75rem;
}

.before-after-comparison {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    border: 1px solid var(--border-gray);
    border-radius: 0.5rem;
}

.comparison-side {
    text-align: center;
}

.comparison-side img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 0.25rem;
}

.comparison-label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
}

.comparison-label.before {
    background: #fff3cd;
    color: #856404;
}

.comparison-label.after {
    background: #d4edda;
    color: #155724;
}
</style>

<script>
let currentPhotoId = null;
let uploadedFiles = [];

// Initialize photo management
document.addEventListener('DOMContentLoaded', function() {
    loadPhotoStats();
    loadPhotoGallery();
    
    // Setup drag and drop
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('photoFiles');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleFileDrop);
    fileInput.addEventListener('change', handleFileSelect);
});

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('dragover');
}

function handleFileDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    processFiles(files);
}

function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    processFiles(files);
}

function processFiles(files) {
    uploadedFiles = files;
    displayFilePreview();
}

function displayFilePreview() {
    const preview = document.getElementById('uploadPreview');
    const fileList = document.getElementById('fileList');
    
    if (uploadedFiles.length === 0) {
        preview.classList.add('d-none');
        return;
    }
    
    preview.classList.remove('d-none');
    fileList.innerHTML = uploadedFiles.map((file, index) => `
        <div class="file-preview-item d-flex justify-content-between align-items-center p-2 border rounded mb-2">
            <div>
                <strong>${file.name}</strong>
                <small class="text-muted d-block">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `).join('');
}

function removeFile(index) {
    uploadedFiles.splice(index, 1);
    displayFilePreview();
}

function getGPSLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const location = `${position.coords.latitude}, ${position.coords.longitude}`;
            document.querySelector('input[name="location"]').value = location;
            showToast('GPS location captured', 'success');
        }, function() {
            showToast('Unable to get GPS location', 'warning');
        });
    } else {
        showToast('GPS not supported by browser', 'warning');
    }
}

function showUploadModal() {
    const modal = new bootstrap.Modal(document.getElementById('uploadPhotoModal'));
    modal.show();
}

function uploadPhotos() {
    const form = document.getElementById('photoUploadForm');
    const formData = new FormData(form);
    
    if (uploadedFiles.length === 0) {
        showToast('Please select photos to upload', 'warning');
        return;
    }
    
    const uploadBtn = document.getElementById('uploadBtn');
    uploadBtn.disabled = true;
    uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Uploading...';
    
    // Upload each file
    let uploadPromises = uploadedFiles.map(file => {
        const fileFormData = new FormData();
        fileFormData.append('photo', file);
        fileFormData.append('job_id', formData.get('job_id'));
        fileFormData.append('photo_type', formData.get('photo_type'));
        fileFormData.append('staff_id', formData.get('staff_id'));
        fileFormData.append('location', formData.get('location'));
        fileFormData.append('description', formData.get('description'));
        
        return fetch('/api/photos/upload', {
            method: 'POST',
            body: fileFormData
        }).then(response => response.json());
    });
    
    Promise.all(uploadPromises)
        .then(results => {
            const successful = results.filter(r => r.success);
            const failed = results.filter(r => !r.success);
            
            if (successful.length > 0) {
                showToast(`${successful.length} photos uploaded successfully!`, 'success');
                refreshPhotoGallery();
                bootstrap.Modal.getInstance(document.getElementById('uploadPhotoModal')).hide();
                form.reset();
                uploadedFiles = [];
                displayFilePreview();
            }
            
            if (failed.length > 0) {
                showToast(`${failed.length} photos failed to upload`, 'error');
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            showToast('Error uploading photos', 'error');
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="fas fa-upload me-1"></i>Upload Photos';
        });
}

function loadPhotoStats() {
    fetch('/api/photos/stats')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('totalPhotos').textContent = stats.total_photos || 0;
            document.getElementById('uploadsToday').textContent = stats.uploads_today || 0;
            document.getElementById('gallerySize').textContent = `${stats.total_size_mb || 0} MB`;
            // Before/after pairs would need separate calculation
            document.getElementById('beforeAfterPairs').textContent = '0';
        })
        .catch(error => {
            console.error('Error loading photo stats:', error);
        });
}

function loadPhotoGallery() {
    // For demo purposes, show sample photo data
    const samplePhotos = [
        {
            id: 'PHOTO001',
            job_id: 'JOB001',
            filename: 'before_kitchen_001.jpg',
            photo_type: 'before',
            upload_date: '2025-06-24T14:30:00',
            uploaded_by: 'STF002',
            file_size: 2048000,
            notes: 'Kitchen before renovation'
        },
        {
            id: 'PHOTO002',
            job_id: 'JOB001',
            filename: 'after_kitchen_001.jpg',
            photo_type: 'after',
            upload_date: '2025-06-24T16:45:00',
            uploaded_by: 'STF002',
            file_size: 1856000,
            notes: 'Kitchen after drywall completion'
        }
    ];
    
    displayPhotoGallery(samplePhotos);
}

function displayPhotoGallery(photos) {
    const gallery = document.getElementById('photoGallery');
    
    if (photos.length === 0) {
        gallery.innerHTML = `
            <div class="col-12 text-center py-5 text-muted">
                <i class="fas fa-camera fa-3x mb-3"></i>
                <div>No photos uploaded yet. Upload your first job photos to get started.</div>
            </div>
        `;
        return;
    }
    
    gallery.innerHTML = `
        <div class="photo-grid">
            ${photos.map(photo => `
                <div class="photo-card" onclick="showPhotoDetail('${photo.id}')">
                    <div class="position-relative">
                        <img src="/uploads/photos/${photo.filename}" alt="${photo.notes}" 
                             onerror="this.src='/static/images/photo-placeholder.png'">
                        <span class="badge photo-type-badge bg-${getPhotoTypeBadgeColor(photo.photo_type)}">
                            ${photo.photo_type}
                        </span>
                    </div>
                    <div class="photo-card-body">
                        <div class="fw-bold small">${photo.job_id}</div>
                        <div class="text-muted small">${formatFileSize(photo.file_size)}</div>
                        <div class="text-muted small">${formatDate(photo.upload_date)}</div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
}

function getPhotoTypeBadgeColor(type) {
    const colors = {
        'before': 'warning',
        'after': 'success',
        'progress': 'info',
        'materials': 'secondary',
        'completion': 'primary'
    };
    return colors[type] || 'secondary';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function showPhotoDetail(photoId) {
    currentPhotoId = photoId;
    // Show photo detail modal with metadata
    showToast('Photo detail view coming soon', 'info');
}

function refreshPhotoGallery() {
    loadPhotoStats();
    loadPhotoGallery();
}

function loadBeforeAfterComparisons() {
    showToast('Before/after comparison view coming soon', 'info');
}

function loadJobPhotos() {
    showToast('Job-specific photo view coming soon', 'info');
}

function setCoverPhoto() {
    if (currentPhotoId) {
        showToast(`Setting photo ${currentPhotoId} as cover`, 'info');
    }
}

function deletePhoto() {
    if (currentPhotoId && confirm('Are you sure you want to delete this photo?')) {
        showToast(`Deleting photo ${currentPhotoId}`, 'info');
    }
}

function savePhotoNote() {
    if (currentPhotoId) {
        const note = document.getElementById('photoNotes').value;
        showToast('Photo note saved', 'success');
    }
}

// Load photos when section is shown
if (typeof loadPhotoGallery === 'function') {
    loadPhotoGallery();
}
</script>