{% extends "admin_base.html" %}

{% block title %}Admin Dashboard - SPANKKS Construction{% endblock %}

{% block content %}
<style>
.calendar-day-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.2s ease;
    height: 100%;
}
.calendar-day-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.day-header {
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #dee2e6;
}
.appointment-block {
    font-size: 0.75rem;
    line-height: 1.2;
}

/* Side Menu Styles */
.side-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
}

.side-menu {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.side-menu.active {
    right: 0;
}

.side-menu-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

.side-menu-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    float: right;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.side-menu-content {
    padding: 1rem;
}

.menu-section {
    margin-bottom: 1.5rem;
}

.menu-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    color: #495057;
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.menu-item:hover {
    background: #f8f9fa;
    color: #28a745;
    text-decoration: none;
    transform: translateX(5px);
}

.menu-item i {
    width: 20px;
    margin-right: 0.75rem;
    font-size: 1rem;
}

.menu-item-text {
    font-weight: 500;
}

.menu-item-desc {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.quick-actions-toggle {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 1.5rem;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1030;
}

.quick-actions-toggle:hover {
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
}

.quick-actions-toggle.active {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
}

@media (max-width: 768px) {
    .side-menu {
        width: 100%;
        right: -100%;
    }
    
    .calendar-day-card {
        margin-bottom: 0.5rem;
    }
    
    .quick-actions-toggle {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        right: 15px;
    }
}
</style>
<div class="container-fluid py-3">
    <!-- Stats Cards Row -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ bookings|length if bookings else 0 }}</h3>
                    <p class="card-text text-muted small">Total Requests</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-coins fa-2x text-warning mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ pending_requests|length if pending_requests else 0 }}</h3>
                    <p class="card-text text-muted small">Pending</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-envelope fa-2x text-info mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ contact_messages|length if contact_messages else 0 }}</h3>
                    <p class="card-text text-muted small">Messages</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-calendar-week fa-2x text-success mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ week_appointments|length if week_appointments else 0 }}</h3>
                    <p class="card-text text-muted small">This Week</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions Toggle Button -->
    <button class="quick-actions-toggle" id="quickActionsToggle" onclick="toggleSideMenu()">
        <i class="fas fa-bolt"></i>
    </button>

    <!-- Side Menu Overlay -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h5 class="mb-0">
                <i class="fas fa-bolt me-2"></i>
                Quick Actions
            </h5>
            <button class="side-menu-close" onclick="closeSideMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="side-menu-content">
            <!-- Core Business Section -->
            <div class="menu-section">
                <div class="menu-section-title">Core Business</div>
                
                <a href="{{ url_for('crm_dashboard') }}" class="menu-item">
                    <i class="fas fa-users text-primary"></i>
                    <div>
                        <div class="menu-item-text">CRM Dashboard</div>
                        <div class="menu-item-desc">Manage customer relationships</div>
                    </div>
                </a>
                
                <a href="{{ url_for('quote_invoice_form') }}" class="menu-item">
                    <i class="fas fa-file-invoice-dollar text-success"></i>
                    <div>
                        <div class="menu-item-text">Quote & Invoice</div>
                        <div class="menu-item-desc">Generate quotes and invoices</div>
                    </div>
                </a>
                
                <a href="{{ url_for('job_schedule') }}" class="menu-item">
                    <i class="fas fa-calendar text-info"></i>
                    <div>
                        <div class="menu-item-text">Job Schedule</div>
                        <div class="menu-item-desc">View and manage appointments</div>
                    </div>
                </a>
                
                <a href="{{ url_for('contact_list') }}" class="menu-item">
                    <i class="fas fa-address-book text-secondary"></i>
                    <div>
                        <div class="menu-item-text">Contact Database</div>
                        <div class="menu-item-desc">Manage customer contacts</div>
                    </div>
                </a>
            </div>

            <!-- Operations Section -->
            <div class="menu-section">
                <div class="menu-section-title">Operations</div>
                
                <a href="{{ url_for('staff_management') }}" class="menu-item">
                    <i class="fas fa-hard-hat text-warning"></i>
                    <div>
                        <div class="menu-item-text">Staff Management</div>
                        <div class="menu-item-desc">Manage crew and assignments</div>
                    </div>
                </a>
                
                <a href="{{ url_for('inventory_dashboard') }}" class="menu-item">
                    <i class="fas fa-boxes text-info"></i>
                    <div>
                        <div class="menu-item-text">Inventory</div>
                        <div class="menu-item-desc">Track materials and supplies</div>
                    </div>
                </a>
                
                <a href="{{ url_for('checklist_management') }}" class="menu-item">
                    <i class="fas fa-tasks text-secondary"></i>
                    <div>
                        <div class="menu-item-text">Job Checklists</div>
                        <div class="menu-item-desc">Track job completion</div>
                    </div>
                </a>
                
                <a href="{{ url_for('unified_scheduler_dashboard') }}" class="menu-item">
                    <i class="fas fa-calendar-week text-primary"></i>
                    <div>
                        <div class="menu-item-text">Advanced Scheduler</div>
                        <div class="menu-item-desc">Comprehensive scheduling tools</div>
                    </div>
                </a>
            </div>

            <!-- Analytics Section -->
            <div class="menu-section">
                <div class="menu-section-title">Analytics & Intelligence</div>
                
                <a href="{{ url_for('analytics_dashboard') }}" class="menu-item">
                    <i class="fas fa-chart-bar text-info"></i>
                    <div>
                        <div class="menu-item-text">Analytics Dashboard</div>
                        <div class="menu-item-desc">Business performance metrics</div>
                    </div>
                </a>
                
                <a href="{{ url_for('business_intelligence_dashboard') }}" class="menu-item">
                    <i class="fas fa-brain text-success"></i>
                    <div>
                        <div class="menu-item-text">Business Intelligence</div>
                        <div class="menu-item-desc">Strategic insights and recommendations</div>
                    </div>
                </a>
                
                <a href="{{ url_for('ml_insights_dashboard') }}" class="menu-item">
                    <i class="fas fa-magic text-warning"></i>
                    <div>
                        <div class="menu-item-text">ML Insights</div>
                        <div class="menu-item-desc">AI-powered analytics</div>
                    </div>
                </a>
                
                <a href="{{ url_for('integrated_analytics') }}" class="menu-item">
                    <i class="fas fa-chart-line text-dark"></i>
                    <div>
                        <div class="menu-item-text">Analytics Command</div>
                        <div class="menu-item-desc">Integrated analytics platform</div>
                    </div>
                </a>
            </div>

            <!-- Advanced Tools Section -->
            <div class="menu-section">
                <div class="menu-section-title">Advanced Tools</div>
                
                <a href="{{ url_for('advanced_scheduler_dashboard') }}" class="menu-item">
                    <i class="fas fa-calendar-alt text-dark"></i>
                    <div>
                        <div class="menu-item-text">Advanced Scheduler</div>
                        <div class="menu-item-desc">Professional scheduling interface</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="row g-4">
        <!-- Full Width - Weekly Schedule -->
        <div class="col-12">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="scheduleTitle">Weekly Schedule</span>
                    </h5>
                    <div class="d-flex align-items-center">
                        <!-- Week Navigation -->
                        <div class="d-flex align-items-center me-3">
                            <button type="button" class="btn btn-outline-light btn-sm me-2" id="prevWeek" onclick="changeWeek(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm me-2" id="nextWeek" onclick="changeWeek(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm me-3" id="todayBtn" onclick="goToToday()">
                                Today
                            </button>
                        </div>
                        
                        <!-- View Switcher -->
                        <div class="btn-group btn-group-sm me-3" role="group">
                            <button type="button" class="btn btn-outline-light active" id="weekView" onclick="switchView('week')">
                                <i class="fas fa-calendar-week me-1"></i>Week
                            </button>
                            <button type="button" class="btn btn-outline-light" id="monthView" onclick="switchView('month')">
                                <i class="fas fa-calendar-alt me-1"></i>4 Weeks
                            </button>
                        </div>
                        <!-- Date Range -->
                        <small id="dateRange">
                            {% if week_dates %}
                            {{ week_dates[0].strftime('%B %d') }} - {{ week_dates[6].strftime('%B %d, %Y') }}
                            {% else %}
                            Current Week
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Calendar Status Badges -->
                    <div class="p-3 border-bottom">
                        <div class="row g-2">
                            <div class="col-6 col-md-3">
                                <span class="badge bg-success d-block py-2">
                                    <i class="fas fa-dollar-sign me-1"></i>
                                    Invoice Management
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-dark d-block py-2">
                                    <i class="fas fa-users me-1"></i>
                                    Staff Management
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-info d-block py-2">
                                    <i class="fas fa-tasks me-1"></i>
                                    Job Tracking
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-warning d-block py-2">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    Financial Reports
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly View (Default) -->
                    <div class="p-3" id="weeklyView">
                        {% if week_dates %}
                        <!-- Time Slot Schedule -->
                        <div class="time-slot-schedule">
                            <!-- Header Row with Days -->
                            <div class="schedule-header">
                                <div class="time-column-header">Time</div>
                                {% for date in week_dates %}
                                <div class="day-column-header text-center {{ 'bg-primary text-white' if date.strftime('%Y-%m-%d') == today else 'bg-light' }}">
                                    <div class="fw-bold">{{ date.strftime('%a') }}</div>
                                    <div class="h6 mb-0">{{ date.strftime('%m/%d') }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Time Slots -->
                            {% set time_slots = [
                                ('7:00 AM', '7:00'),
                                ('8:00 AM', '8:00'),
                                ('9:00 AM', '9:00'),
                                ('10:00 AM', '10:00'),
                                ('11:00 AM', '11:00'),
                                ('12:00 PM', '12:00'),
                                ('1:00 PM', '13:00'),
                                ('2:00 PM', '14:00'),
                                ('3:00 PM', '15:00'),
                                ('4:00 PM', '16:00'),
                                ('5:00 PM', '17:00')
                            ] %}
                            
                            {% for time_display, time_value in time_slots %}
                            <div class="schedule-row">
                                <div class="time-column">
                                    <span class="time-label">{{ time_display }}</span>
                                </div>
                                {% for date in week_dates %}
                                <div class="appointment-slot" data-date="{{ date.strftime('%Y-%m-%d') }}" data-time="{{ time_value }}">
                                    {% set slot_appointments = [] %}
                                    {% for appointment in week_appointments %}
                                        {% if appointment.date == date.strftime('%Y-%m-%d') and appointment.time.startswith(time_value) %}
                                            {% set _ = slot_appointments.append(appointment) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if slot_appointments %}
                                        {% for appointment in slot_appointments %}
                                        <div class="appointment-block bg-success text-white p-1 rounded small">
                                            <div class="fw-bold">{{ appointment.service[:15] }}{% if appointment.service|length > 15 %}...{% endif %}</div>
                                            <div class="text-white-50" style="font-size: 0.7rem;">{{ appointment.client_name if appointment.client_name else 'Client' }}</div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="empty-slot" onclick="console.log('Clicked empty slot:', '{{ date.strftime('%Y-%m-%d') }}', '{{ time_value }}'); openNewAppointmentModal('{{ date.strftime('%Y-%m-%d') }}', '{{ time_value }}');" style="cursor: pointer;">
                                            <i class="fas fa-plus text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">Calendar loading...</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Extended View (4 Weeks) - Hidden by default -->
                    <div class="p-3 d-none" id="extendedView">
                        {% if all_weeks and all_weeks|length > 0 %}
                            {% for week in all_weeks %}
                            <div class="mb-4 {% if not loop.last %}border-bottom pb-3{% endif %}">
                                <!-- Week Header -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0 {{ 'text-primary' if week.is_current else 'text-muted' }}">
                                        <i class="fas fa-calendar-week me-1"></i>
                                        Week {{ week.week_number }} 
                                        {% if week.is_current %}
                                            <span class="badge bg-primary ms-2">Current</span>
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        {{ week.dates[0].strftime('%b %d') }} - {{ week.dates[6].strftime('%b %d') }}
                                    </small>
                                </div>
                                
                                <!-- Week Days -->
                                <div class="row g-2">
                                    {% for date in week.dates %}
                                    <div class="col">
                                        <div class="calendar-day-card h-100" style="min-height: 100px;">
                                            <div class="day-header text-center p-2 {{ 'bg-primary text-white' if date.strftime('%Y-%m-%d') == today else 'bg-light' }}">
                                                <div class="fw-bold small">{{ date.strftime('%a') }}</div>
                                                <div class="h6 mb-0">{{ date.strftime('%d') }}</div>
                                            </div>
                                            <div class="day-content p-1" style="min-height: 60px;">
                                                {% set day_appointments = [] %}
                                                {% for appointment in all_appointments %}
                                                    {% if appointment.date == date.strftime('%Y-%m-%d') %}
                                                        {% set _ = day_appointments.append(appointment) %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if day_appointments %}
                                                    {% for appointment in day_appointments %}
                                                    <div class="appointment-block bg-success text-white p-1 mb-1 rounded" style="font-size: 0.7rem; line-height: 1.1;">
                                                        <div class="fw-bold">{{ appointment.time }}</div>
                                                        <div>{{ appointment.service[:20] }}{% if appointment.service|length > 20 %}...{% endif %}</div>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="text-center text-muted mt-2" style="font-size: 0.65rem;">
                                                        <i class="fas fa-plus-circle"></i>
                                                        <div>Open</div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">Extended schedule loading...</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Appointment Modal -->
<div class="modal fade" id="newAppointmentModal" tabindex="-1" aria-labelledby="newAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAppointmentModalLabel">
                    <i class="fas fa-calendar-plus me-2"></i>New Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm">
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="appointmentDate" required readonly>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentTime" class="form-label">Time</label>
                        <select class="form-select" id="appointmentTime" required>
                            <option value="7:00">7:00 AM</option>
                            <option value="8:00">8:00 AM</option>
                            <option value="9:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="clientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="clientPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="serviceType" class="form-label">Service Type</label>
                        <select class="form-select" id="serviceType" required>
                            <option value="">Select Service</option>
                            <option value="Drywall Services">Drywall Services</option>
                            <option value="Flooring Installation">Flooring Installation</option>
                            <option value="Fence Building">Fence Building</option>
                            <option value="General Handyman">General Handyman</option>
                            <option value="Plumbing Repair">Plumbing Repair</option>
                            <option value="Electrical Work">Electrical Work</option>
                            <option value="Painting">Painting</option>
                            <option value="Home Renovation">Home Renovation</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="serviceDescription" class="form-label">Service Description</label>
                        <textarea class="form-control" id="serviceDescription" rows="3" placeholder="Brief description of the work needed"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="estimatedDuration" class="form-label">Estimated Duration (hours)</label>
                        <select class="form-select" id="estimatedDuration">
                            <option value="1">1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="4">4 hours</option>
                            <option value="6">6 hours</option>
                            <option value="8">8 hours (Full day)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAppointment()">
                    <i class="fas fa-save me-1"></i>Create Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Side Menu Functionality
function toggleSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    if (sideMenu.classList.contains('active')) {
        closeSideMenu();
    } else {
        openSideMenu();
    }
}

function openSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    sideMenu.classList.add('active');
    overlay.style.display = 'block';
    toggleBtn.classList.add('active');
    
    // Change icon to close
    const icon = toggleBtn.querySelector('i');
    icon.className = 'fas fa-times';
    
    // Prevent body scroll when menu is open
    document.body.style.overflow = 'hidden';
}

function closeSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    sideMenu.classList.remove('active');
    overlay.style.display = 'none';
    toggleBtn.classList.remove('active');
    
    // Change icon back to bolt
    const icon = toggleBtn.querySelector('i');
    icon.className = 'fas fa-bolt';
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Close menu when pressing Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSideMenu();
    }
});

// Close menu when clicking on menu items (for better UX)
document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            // Small delay to allow the navigation to start
            setTimeout(closeSideMenu, 100);
        });
    });
});

// Add CSS for time slot schedule
const timeSlotStyles = `
<style>
.time-slot-schedule {
    display: grid;
    grid-template-rows: auto repeat(11, 1fr);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.schedule-header {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.time-column-header {
    padding: 12px 8px;
    font-weight: bold;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.day-column-header {
    padding: 12px 8px;
    border-left: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60px;
}

.schedule-row {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    border-bottom: 1px solid #dee2e6;
    min-height: 50px;
}

.time-column {
    padding: 8px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.time-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #495057;
}

.appointment-slot {
    padding: 4px;
    border-left: 1px solid #dee2e6;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.appointment-slot:hover {
    background-color: #f8f9fa;
}

.appointment-block {
    width: 100%;
    max-width: 100%;
    margin: 0;
    font-size: 0.75rem;
    line-height: 1.2;
    padding: 4px 6px !important;
}

.empty-slot {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.3;
    transition: opacity 0.2s;
}

.appointment-slot:hover .empty-slot {
    opacity: 0.8;
}

.empty-slot i {
    font-size: 1.2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .schedule-header,
    .schedule-row {
        grid-template-columns: 80px repeat(7, 1fr);
    }
    
    .time-column-header,
    .time-column {
        padding: 8px 4px;
    }
    
    .time-label {
        font-size: 0.7rem;
    }
    
    .day-column-header {
        padding: 8px 4px;
        font-size: 0.8rem;
    }
    
    .appointment-block {
        font-size: 0.65rem;
        padding: 2px 4px !important;
    }
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', timeSlotStyles);

// Schedule view switching functionality
function switchView(viewType) {
    const weekBtn = document.getElementById('weekView');
    const monthBtn = document.getElementById('monthView');
    const weeklyView = document.getElementById('weeklyView');
    const extendedView = document.getElementById('extendedView');
    const scheduleTitle = document.getElementById('scheduleTitle');
    const dateRange = document.getElementById('dateRange');
    
    if (viewType === 'week') {
        // Switch to weekly view
        weekBtn.classList.add('active');
        monthBtn.classList.remove('active');
        weeklyView.classList.remove('d-none');
        extendedView.classList.add('d-none');
        scheduleTitle.textContent = 'Weekly Schedule';
        
        // Update date range for weekly view
        {% if week_dates %}
        dateRange.innerHTML = '{{ week_dates[0].strftime("%B %d") }} - {{ week_dates[6].strftime("%B %d, %Y") }}';
        {% endif %}
    } else if (viewType === 'month') {
        // Switch to extended view
        weekBtn.classList.remove('active');
        monthBtn.classList.add('active');
        weeklyView.classList.add('d-none');
        extendedView.classList.remove('d-none');
        scheduleTitle.textContent = 'Extended Schedule (4 Weeks)';
        
        // Update date range for extended view
        {% if all_weeks and all_weeks|length > 0 %}
        dateRange.innerHTML = '{{ all_weeks[0]["dates"][0].strftime("%B %d") }} - {{ all_weeks[-1]["dates"][6].strftime("%B %d, %Y") }}';
        {% endif %}
    }
}

// Week navigation functionality
let currentWeekOffset = 0; // 0 = current week, -1 = last week, 1 = next week

function changeWeek(direction) {
    currentWeekOffset += direction;
    
    // Update the URL with week parameter and reload
    const url = new URL(window.location);
    url.searchParams.set('week_offset', currentWeekOffset);
    window.location.href = url.toString();
}

function goToToday() {
    currentWeekOffset = 0;
    
    // Remove week_offset parameter and reload
    const url = new URL(window.location);
    url.searchParams.delete('week_offset');
    window.location.href = url.toString();
}

// Initialize current week offset from URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const weekOffset = urlParams.get('week_offset');
    if (weekOffset) {
        currentWeekOffset = parseInt(weekOffset);
    }
    
    // Update button states based on current week
    updateNavigationButtons();
    
    // Test if appointment modal function is accessible
    console.log('Testing appointment modal function:', typeof openNewAppointmentModal);
    window.openNewAppointmentModal = openNewAppointmentModal;
});

function updateNavigationButtons() {
    const todayBtn = document.getElementById('todayBtn');
    
    // Highlight "Today" button if we're viewing current week
    if (currentWeekOffset === 0) {
        todayBtn.classList.add('btn-light');
        todayBtn.classList.remove('btn-outline-light');
    } else {
        todayBtn.classList.remove('btn-light');
        todayBtn.classList.add('btn-outline-light');
    }
}

// Appointment modal functions
function openNewAppointmentModal(date, time) {
    console.log('openNewAppointmentModal called with:', date, time);
    
    // Set the date and time in the modal
    document.getElementById('appointmentDate').value = date;
    document.getElementById('appointmentTime').value = time;
    
    // Convert time to display format for the time selector
    const timeOptions = {
        '7:00': '7:00', '8:00': '8:00', '9:00': '9:00', '10:00': '10:00',
        '11:00': '11:00', '12:00': '12:00', '13:00': '13:00', '14:00': '14:00',
        '15:00': '15:00', '16:00': '16:00', '17:00': '17:00'
    };
    
    if (timeOptions[time]) {
        document.getElementById('appointmentTime').value = time;
    }
    
    // Clear any previous form data
    document.getElementById('newAppointmentForm').reset();
    document.getElementById('appointmentDate').value = date;
    document.getElementById('appointmentTime').value = time;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('newAppointmentModal'));
    modal.show();
}

function createAppointment() {
    const form = document.getElementById('newAppointmentForm');
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect form data
    const appointmentData = {
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        client_name: document.getElementById('clientName').value,
        client_phone: document.getElementById('clientPhone').value,
        service_type: document.getElementById('serviceType').value,
        service_description: document.getElementById('serviceDescription').value,
        estimated_duration: document.getElementById('estimatedDuration').value
    };
    
    // Create appointment via API
    fetch('/api/appointments/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(appointmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newAppointmentModal'));
            modal.hide();
            
            // Show success message
            alert('Appointment created successfully!');
            
            // Reload the page to show the new appointment
            window.location.reload();
        } else {
            alert('Error creating appointment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating appointment. Please try again.');
    });
}
</script>
{% endblock %}