{% extends "admin_base.html" %}

{% block title %}Admin Dashboard - SPANKKS Construction{% endblock %}

{% block content %}
<!-- Force cache refresh -->
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
.calendar-day-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    background: white;
    transition: all 0.2s ease;
    height: 100%;
}
.calendar-day-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.day-header {
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #dee2e6;
}
.appointment-block {
    font-size: 0.75rem;
    line-height: 1.2;
}

/* Mobile Dashboard Enhancements */
@media (max-width: 768px) {
    .admin-header {
        padding: 0.75rem 0 !important;
    }
    
    .admin-header h4 {
        font-size: 1.1rem;
        margin-bottom: 0;
    }
    
    .admin-header .d-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 0.5rem;
    }
    
    .admin-header .btn-group {
        width: 100%;
        justify-content: center;
    }
    
    .admin-header small {
        font-size: 0.7rem;
        align-self: center;
    }
    
    /* Stats cards in mobile 2x2 grid */
    .stats-row-mobile {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .stats-card-mobile {
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        text-align: center;
        padding: 0.75rem 0.5rem;
    }
    
    .stats-card-mobile i {
        font-size: 1.2rem;
        margin-bottom: 0.25rem;
    }
    
    .stats-card-mobile h3 {
        font-size: 1.25rem;
        margin: 0.25rem 0;
    }
    
    .stats-card-mobile p {
        font-size: 0.7rem;
        margin: 0;
        line-height: 1.2;
    }
    
    /* Calendar header mobile adjustments */
    .card-header .d-flex {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 0.75rem;
    }
    
    .card-header .d-flex > div {
        width: 100%;
        justify-content: center;
    }
    
    .card-header .btn-group {
        justify-content: center;
        width: 100%;
    }
    
    /* Calendar status badges mobile */
    .calendar-status-badges .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    
    .calendar-status-badges .badge {
        font-size: 0.7rem;
        padding: 0.5rem;
        text-align: center;
    }
    
    /* Better mobile scroll for schedule */
    .time-slot-schedule {
        border-radius: 8px;
        overflow: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    /* Hide some elements on very small screens */
    .mobile-hide-sm {
        display: none !important;
    }
    
    /* Compact button text */
    .btn-sm {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Modal improvements */
    .modal-header h5 {
        font-size: 1rem;
    }
    
    .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
    }
    
    .form-control,
    .form-select {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
    }
}
</style>

<style>
/* Drag and Drop Styles */
.draggable-appointment {
    transition: all 0.2s ease;
    user-select: none;
}

.draggable-appointment:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.draggable-appointment.dragging {
    opacity: 0.6;
    transform: rotate(3deg) scale(1.05);
    z-index: 1000;
}

.drop-zone.drag-over {
    border: 2px dashed #007bff;
    background-color: rgba(0, 123, 255, 0.1);
    border-radius: 4px;
}

.drop-zone.drag-enter {
    background-color: rgba(40, 167, 69, 0.1);
    border: 2px dashed #28a745;
}

/* Side Menu Styles */
.side-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1040;
    display: none;
}

.side-menu {
    position: fixed;
    top: 0;
    right: -350px;
    width: 350px;
    height: 100%;
    background: white;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
    z-index: 1050;
    transition: right 0.3s ease;
    overflow-y: auto;
}

.side-menu.active {
    right: 0;
}

.side-menu-header {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    padding: 1rem;
    position: sticky;
    top: 0;
    z-index: 10;
}

.side-menu-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    float: right;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.side-menu-content {
    padding: 1rem;
}

.menu-section {
    margin-bottom: 1.5rem;
}

.menu-section-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #6c757d;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.menu-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    color: #495057;
    text-decoration: none;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
}

.menu-item:hover {
    background: #f8f9fa;
    color: #28a745;
    text-decoration: none;
    transform: translateX(5px);
}

.menu-item i {
    width: 20px;
    margin-right: 0.75rem;
    font-size: 1rem;
}

.menu-item-text {
    font-weight: 500;
}

.menu-item-desc {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
}

.quick-actions-toggle {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
    border: none;
    border-radius: 50%;
    width: 70px;
    height: 70px;
    font-size: 1.8rem;
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 1030;
    border: 3px solid rgba(255, 255, 255, 0.3);
}

.quick-actions-toggle:hover {
    transform: translateY(-50%) scale(1.15);
    box-shadow: 0 8px 25px rgba(40, 167, 69, 0.5);
}

.quick-actions-toggle.active {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
}

/* Desktop-specific enhancements */
@media (min-width: 992px) {
    .quick-actions-toggle {
        width: 85px;
        height: 85px;
        font-size: 2.1rem;
        right: 30px;
        box-shadow: 0 8px 30px rgba(40, 167, 69, 0.5);
        border: 4px solid rgba(255, 255, 255, 0.4);
    }
    
    .quick-actions-toggle::before {
        content: 'Quick Actions';
        position: absolute;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        white-space: nowrap;
        margin-right: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    
    .quick-actions-toggle:hover::before {
        opacity: 1;
    }
    
    .quick-actions-toggle:hover {
        transform: translateY(-50%) scale(1.2);
        box-shadow: 0 12px 35px rgba(40, 167, 69, 0.6);
    }
}

@media (max-width: 768px) {
    .side-menu {
        width: 100%;
        right: -100%;
    }
    
    .calendar-day-card {
        margin-bottom: 0.5rem;
    }
    
    .quick-actions-toggle {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
        right: 15px;
    }
}
</style>
<div class="container-fluid py-3">
    <!-- Stats Cards Row -->
    <div class="row g-3 mb-4 d-none d-md-flex">
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-clipboard-list fa-2x text-primary mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ bookings|length if bookings else 0 }}</h3>
                    <p class="card-text text-muted small">Total Requests</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm" style="cursor: pointer;" onclick="showPendingDetails()">
                <div class="card-body py-3">
                    <i class="fas fa-coins fa-2x text-warning mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ pending_requests|length if pending_requests else 0 }}</h3>
                    <p class="card-text text-muted small">Pending</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-envelope fa-2x text-info mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ contact_messages|length if contact_messages else 0 }}</h3>
                    <p class="card-text text-muted small">Messages</p>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card text-center border-0 shadow-sm">
                <div class="card-body py-3">
                    <i class="fas fa-calendar-week fa-2x text-success mb-2"></i>
                    <h3 class="card-title h4 mb-1">{{ week_appointments|length if week_appointments else 0 }}</h3>
                    <p class="card-text text-muted small">This Week</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Stats Cards -->
    <div class="stats-row-mobile d-md-none">
        <div class="card stats-card-mobile shadow-sm" onclick="showPendingDetails()">
            <i class="fas fa-clipboard-list text-primary"></i>
            <h3>{{ bookings|length if bookings else 0 }}</h3>
            <p class="text-muted">Total Requests</p>
        </div>
        <div class="card stats-card-mobile shadow-sm" onclick="showPendingDetails()">
            <i class="fas fa-coins text-warning"></i>
            <h3>{{ pending_requests|length if pending_requests else 0 }}</h3>
            <p class="text-muted">Pending</p>
        </div>
        <div class="card stats-card-mobile shadow-sm">
            <i class="fas fa-envelope text-info"></i>
            <h3>{{ contact_messages|length if contact_messages else 0 }}</h3>
            <p class="text-muted">Messages</p>
        </div>
        <div class="card stats-card-mobile shadow-sm">
            <i class="fas fa-calendar-week text-success"></i>
            <h3>{{ week_appointments|length if week_appointments else 0 }}</h3>
            <p class="text-muted">This Week</p>
        </div>
    </div>

    <!-- Quick Actions Toggle Button -->
    <button class="quick-actions-toggle" id="quickActionsToggle" onclick="toggleSideMenu()" 
            data-help="quick-actions-toggle" 
            data-help-click-only="true">
        <i class="fas fa-bolt"></i>
    </button>

    <!-- Side Menu Overlay -->
    <div class="side-menu-overlay" id="sideMenuOverlay" onclick="closeSideMenu()"></div>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header">
            <h5 class="mb-0">
                <i class="fas fa-bolt me-2"></i>
                Quick Actions
            </h5>
            <button class="side-menu-close" onclick="closeSideMenu()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="side-menu-content">
            <!-- Core Business Section -->
            <div class="menu-section">
                <div class="menu-section-title">Core Business</div>
                
                <a href="{{ url_for('quote_invoice_generator') }}" class="menu-item" 
                   data-help="quote-builder">
                    <i class="fas fa-file-invoice-dollar text-success"></i>
                    <div>
                        <div class="menu-item-text">Quote Builder</div>
                        <div class="menu-item-desc">Create professional quotes</div>
                    </div>
                </a>
                
                <a href="javascript:void(0)" onclick="showPaymentModal()" class="menu-item"
                   data-help-content="Track and record customer payments for invoices. Supports multiple payment methods including cash, check, Venmo, and Zelle."
                   data-help-illustration="quote">
                    <i class="fas fa-dollar-sign text-warning"></i>
                    <div>
                        <div class="menu-item-text">Mark Payment</div>
                        <div class="menu-item-desc">Track invoice payments</div>
                    </div>
                </a>
                
                <a href="/admin/scheduler/unified" class="menu-item" 
                   data-help="scheduler">
                    <i class="fas fa-calendar-alt text-info"></i>
                    <div>
                        <div class="menu-item-text">Enhanced Calendar</div>
                        <div class="menu-item-desc">Color-coded scheduling system</div>
                    </div>
                </a>
            </div>

            <!-- Operations Section -->
            <div class="menu-section">
                <div class="menu-section-title">Operations</div>
                
                <a href="/admin/staff" class="menu-item" 
                   data-help="staff-management">
                    <i class="fas fa-hard-hat text-warning"></i>
                    <div>
                        <div class="menu-item-text">Staff Management</div>
                        <div class="menu-item-desc">Manage crew and assignments</div>
                    </div>
                </a>
                
                <a href="/admin/inventory" class="menu-item" 
                   data-help="inventory-dashboard">
                    <i class="fas fa-boxes text-info"></i>
                    <div>
                        <div class="menu-item-text">Inventory</div>
                        <div class="menu-item-desc">Track materials and supplies</div>
                    </div>
                </a>
                
                <a href="/admin/checklists" class="menu-item" 
                   data-help="checklist-management">
                    <i class="fas fa-tasks text-secondary"></i>
                    <div>
                        <div class="menu-item-text">Job Checklists</div>
                        <div class="menu-item-desc">Track job completion</div>
                    </div>
                </a>
                

            </div>

            <!-- Analytics Section -->
            <div class="menu-section">
                <div class="menu-section-title">Analytics & Intelligence</div>
                
                <a href="/admin/analytics-dashboard" class="menu-item" 
                   data-help="analytics-dashboard">
                    <i class="fas fa-chart-bar text-info"></i>
                    <div>
                        <div class="menu-item-text">Analytics Dashboard</div>
                        <div class="menu-item-desc">Business performance metrics</div>
                    </div>
                </a>
                
                <a href="/admin/business-intelligence" class="menu-item" 
                   data-help="business-intelligence">
                    <i class="fas fa-brain text-success"></i>
                    <div>
                        <div class="menu-item-text">Business Intelligence</div>
                        <div class="menu-item-desc">Strategic insights and recommendations</div>
                    </div>
                </a>
                
                <a href="/admin/ml-insights" class="menu-item" 
                   data-help="ml-insights">
                    <i class="fas fa-magic text-warning"></i>
                    <div>
                        <div class="menu-item-text">ML Insights</div>
                        <div class="menu-item-desc">AI-powered analytics</div>
                    </div>
                </a>
                
                <a href="/admin/integrated-analytics" class="menu-item">
                    <i class="fas fa-chart-line text-dark"></i>
                    <div>
                        <div class="menu-item-text">Analytics Command</div>
                        <div class="menu-item-desc">Integrated analytics platform</div>
                    </div>
                </a>
            </div>

            <!-- Advanced Tools Section -->
            <div class="menu-section">
                <div class="menu-section-title">Advanced Tools</div>
                

                
                <a href="/admin/scheduler/advanced" class="menu-item">
                    <i class="fas fa-calendar-alt text-dark"></i>
                    <div>
                        <div class="menu-item-text">Advanced Scheduler</div>
                        <div class="menu-item-desc">Professional scheduling interface</div>
                    </div>
                </a>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Content -->
    <div class="row g-4">
        <!-- Full Width - Weekly Schedule -->
        <div class="col-12">
            <div class="card border-0 shadow-lg h-100" style="border-left: 4px solid #28a745 !important;">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center py-3">
                    <h4 class="mb-0 fw-bold">
                        <i class="fas fa-calendar-week me-2"></i>
                        <span id="scheduleTitle">SPANKKS Weekly Schedule</span>
                    </h4>
                    <div class="d-flex align-items-center">
                        <!-- Week Navigation -->
                        <div class="d-flex align-items-center me-3">
                            <button type="button" class="btn btn-outline-light btn-sm me-2" id="prevWeek">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm me-2" id="nextWeek">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light btn-sm me-3" id="todayBtn" onclick="goToToday()">
                                Today
                            </button>
                        </div>
                        
                        <!-- View Switcher -->
                        <div class="btn-group btn-group-sm me-3" role="group">
                            <button type="button" class="btn btn-outline-light active" id="weekView" onclick="switchView('week')">
                                <i class="fas fa-calendar-week me-1"></i>Week
                            </button>
                            <button type="button" class="btn btn-outline-light" id="monthView" onclick="switchView('month')">
                                <i class="fas fa-calendar-alt me-1"></i>4 Weeks
                            </button>
                        </div>
                        <!-- Date Range -->
                        <small id="dateRange">
                            {% if week_dates %}
                            {{ week_dates[0].strftime('%B %d') }} - {{ week_dates[6].strftime('%B %d, %Y') }}
                            {% else %}
                            Current Week
                            {% endif %}
                        </small>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Calendar Status Badges -->
                    <div class="p-3 border-bottom calendar-status-badges">
                        <div class="row g-2">
                            <div class="col-6 col-md-3">
                                <span class="badge bg-success d-block py-2">
                                    <i class="fas fa-dollar-sign me-1"></i>
                                    <span class="d-none d-sm-inline">Invoice Management</span>
                                    <span class="d-sm-none">Invoices</span>
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-dark d-block py-2">
                                    <i class="fas fa-users me-1"></i>
                                    <span class="d-none d-sm-inline">Staff Management</span>
                                    <span class="d-sm-none">Staff</span>
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-info d-block py-2">
                                    <i class="fas fa-tasks me-1"></i>
                                    <span class="d-none d-sm-inline">Job Tracking</span>
                                    <span class="d-sm-none">Jobs</span>
                                </span>
                            </div>
                            <div class="col-6 col-md-3">
                                <span class="badge bg-warning d-block py-2">
                                    <i class="fas fa-chart-bar me-1"></i>
                                    <span class="d-none d-sm-inline">Financial Reports</span>
                                    <span class="d-sm-none">Reports</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly View (Default) -->
                    <div class="p-3" id="weeklyView">
                        {% if week_dates %}
                        <!-- Time Slot Schedule -->
                        <div class="time-slot-schedule">
                            <!-- Header Row with Days -->
                            <div class="schedule-header">
                                <div class="time-column-header">Time</div>
                                {% for date in week_dates %}
                                <div class="day-column-header text-center {{ 'bg-primary text-white' if date.strftime('%Y-%m-%d') == today else 'bg-light' }}">
                                    <div class="fw-bold">{{ date.strftime('%a') }}</div>
                                    <div class="h6 mb-0">{{ date.strftime('%m/%d') }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Time Slots -->
                            {% set time_slots = [
                                ('7:00 AM', '07:00'),
                                ('8:00 AM', '08:00'),
                                ('9:00 AM', '09:00'),
                                ('10:00 AM', '10:00'),
                                ('11:00 AM', '11:00'),
                                ('12:00 PM', '12:00'),
                                ('1:00 PM', '13:00'),
                                ('2:00 PM', '14:00'),
                                ('3:00 PM', '15:00'),
                                ('4:00 PM', '16:00'),
                                ('5:00 PM', '17:00')
                            ] %}
                            
                            {% for time_display, time_value in time_slots %}
                            <div class="schedule-row">
                                <div class="time-column">
                                    <span class="time-label">{{ time_display }}</span>
                                </div>
                                {% for date in week_dates %}
                                <div class="appointment-slot" data-date="{{ date.strftime('%Y-%m-%d') }}" data-time="{{ time_value }}">
                                    {% set slot_appointments = [] %}
                                    {% for appointment in week_appointments %}
                                        {% if appointment.date == date.strftime('%Y-%m-%d') and appointment.time == time_value %}
                                            {% set _ = slot_appointments.append(appointment) %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if slot_appointments %}
                                        {% for appointment in slot_appointments %}
                                        <div class="appointment-block bg-success text-white p-1 rounded small" style="cursor: pointer;" onclick="showAppointmentDetails('{{ appointment.id if appointment.id else loop.index }}', '{{ appointment.client_name }}', '{{ appointment.service }}', '{{ appointment.estimated_amount if appointment.estimated_amount else 'TBD' }}', '{{ appointment.status if appointment.status else 'Scheduled' }}', '{{ appointment.time }}', '{{ date.strftime('%Y-%m-%d') }}')">
                                            <div class="fw-bold">{{ appointment.service[:15] }}{% if appointment.service|length > 15 %}...{% endif %}</div>
                                            <div class="text-white-50" style="font-size: 0.7rem;">{{ appointment.client_name if appointment.client_name else 'Client' }}</div>
                                            <div class="text-white-75" style="font-size: 0.65rem;">
                                                {% if appointment.estimated_amount %}${{ appointment.estimated_amount }}{% endif %}
                                                <span class="badge bg-light text-dark ms-1" style="font-size: 0.6rem;">{{ appointment.status if appointment.status else 'Scheduled' }}</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="empty-slot" data-date="{{ date.strftime('%Y-%m-%d') }}" data-time="{{ time_value }}" style="cursor: pointer;">
                                            <i class="fas fa-plus text-muted"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">Calendar loading...</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Extended View (4 Weeks) - Hidden by default -->
                    <div class="p-3 d-none" id="extendedView">
                        {% if all_weeks and all_weeks|length > 0 %}
                            {% for week in all_weeks %}
                            <div class="mb-4 {% if not loop.last %}border-bottom pb-3{% endif %}">
                                <!-- Week Header -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="fw-bold mb-0 {{ 'text-primary' if week.is_current else 'text-muted' }}">
                                        <i class="fas fa-calendar-week me-1"></i>
                                        Week {{ week.week_number }} 
                                        {% if week.is_current %}
                                            <span class="badge bg-primary ms-2">Current</span>
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        {{ week.dates[0].strftime('%b %d') }} - {{ week.dates[6].strftime('%b %d') }}
                                    </small>
                                </div>
                                
                                <!-- Week Days -->
                                <div class="row g-2">
                                    {% for date in week.dates %}
                                    <div class="col">
                                        <div class="calendar-day-card h-100" style="min-height: 100px;">
                                            <div class="day-header text-center p-2 {{ 'bg-primary text-white' if date.strftime('%Y-%m-%d') == today else 'bg-light' }}">
                                                <div class="fw-bold small">{{ date.strftime('%a') }}</div>
                                                <div class="h6 mb-0">{{ date.strftime('%d') }}</div>
                                            </div>
                                            <div class="day-content p-1 drop-zone" 
                                                 style="min-height: 60px;"
                                                 data-date="{{ date.strftime('%Y-%m-%d') }}"
                                                 ondrop="dropAppointment(event)" 
                                                 ondragover="allowDrop(event)"
                                                 ondragenter="dragEnter(event)"
                                                 ondragleave="dragLeave(event)">
                                                {% set day_appointments = [] %}
                                                {% for appointment in all_appointments %}
                                                    {% if appointment.date == date.strftime('%Y-%m-%d') %}
                                                        {% set _ = day_appointments.append(appointment) %}
                                                    {% endif %}
                                                {% endfor %}
                                                
                                                {% if day_appointments %}
                                                    {% for appointment in day_appointments %}
                                                    <div class="appointment-block bg-success text-white p-1 mb-1 rounded draggable-appointment" 
                                                         style="font-size: 0.7rem; line-height: 1.1; cursor: move;" 
                                                         draggable="true"
                                                         data-appointment-id="{{ appointment.id }}"
                                                         data-appointment-date="{{ appointment.date }}"
                                                         data-appointment-time="{{ appointment.time }}"
                                                         data-client-name="{{ appointment.client_name }}"
                                                         data-service="{{ appointment.service }}">
                                                        <div class="fw-bold">{{ appointment.time }}</div>
                                                        <div>{{ appointment.service[:20] }}{% if appointment.service|length > 20 %}...{% endif %}</div>
                                                    </div>
                                                    {% endfor %}
                                                {% else %}
                                                    <div class="text-center text-muted mt-2" style="font-size: 0.65rem;">
                                                        <i class="fas fa-plus-circle"></i>
                                                        <div>Open</div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">Extended schedule loading...</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Appointment Modal -->
<div class="modal fade" id="newAppointmentModal" tabindex="-1" aria-labelledby="newAppointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newAppointmentModalLabel">
                    <i class="fas fa-calendar-plus me-2"></i>New Appointment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="newAppointmentForm">
                    <div class="mb-3">
                        <label for="appointmentDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="appointmentDate" required readonly>
                    </div>
                    <div class="mb-3">
                        <label for="appointmentTime" class="form-label">Time</label>
                        <select class="form-select" id="appointmentTime" required>
                            <option value="7:00">7:00 AM</option>
                            <option value="8:00">8:00 AM</option>
                            <option value="9:00">9:00 AM</option>
                            <option value="10:00">10:00 AM</option>
                            <option value="11:00">11:00 AM</option>
                            <option value="12:00">12:00 PM</option>
                            <option value="13:00">1:00 PM</option>
                            <option value="14:00">2:00 PM</option>
                            <option value="15:00">3:00 PM</option>
                            <option value="16:00">4:00 PM</option>
                            <option value="17:00">5:00 PM</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="clientName" class="form-label">Client Name</label>
                        <input type="text" class="form-control" id="clientName" required>
                    </div>
                    <div class="mb-3">
                        <label for="clientPhone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="clientPhone" required>
                    </div>
                    <div class="mb-3">
                        <label for="serviceType" class="form-label">Service Type</label>
                        <select class="form-select" id="serviceType" required>
                            <option value="">Select Service</option>
                            <option value="Consultation">Consultation</option>
                            <option value="Admin Block">Admin Block</option>
                            <option value="Drywall Services">Drywall Services</option>
                            <option value="Flooring Installation">Flooring Installation</option>
                            <option value="Fence Building">Fence Building</option>
                            <option value="General Handyman">General Handyman</option>
                            <option value="Plumbing Repair">Plumbing Repair</option>
                            <option value="Electrical Work">Electrical Work</option>
                            <option value="Painting">Painting</option>
                            <option value="Home Renovation">Home Renovation</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="serviceDescription" class="form-label">Service Description</label>
                        <textarea class="form-control" id="serviceDescription" rows="3" placeholder="Brief description of the work needed"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="estimatedDuration" class="form-label">Estimated Duration (hours)</label>
                        <select class="form-select" id="estimatedDuration">
                            <option value="1">1 hour</option>
                            <option value="2">2 hours</option>
                            <option value="3">3 hours</option>
                            <option value="4">4 hours</option>
                            <option value="6">6 hours</option>
                            <option value="8">8 hours (Full day)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAppointment()">
                    <i class="fas fa-save me-1"></i>Create Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Pending Items Modal -->
<div class="modal fade" id="pendingDetailsModal" tabindex="-1" aria-labelledby="pendingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pendingDetailsModalLabel">
                    <i class="fas fa-clock me-2"></i>Pending Items
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <h6 class="mb-3"><i class="fas fa-clipboard-check me-2"></i>Pending Service Requests</h6>
                        {% if pending_requests %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Service</th>
                                        <th>Date Requested</th>
                                        <th>Phone</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in pending_requests %}
                                    <tr>
                                        <td>{{ request.name if request.name is defined else request.get('name', 'Unknown') if request.get is defined else 'Unknown' }}</td>
                                        <td>{{ request.service if request.service is defined else request.get('service', 'General Service') if request.get is defined else 'General Service' }}</td>
                                        <td>{{ request.created_at if request.created_at is defined else request.get('created_at', 'N/A') if request.get is defined else 'N/A' }}</td>
                                        <td>{{ request.phone if request.phone is defined else request.get('phone', 'N/A') if request.get is defined else 'N/A' }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-success" onclick="updateRequestStatus('{{ request.id if request.id is defined else request.get('id', loop.index) if request.get is defined else loop.index }}', 'confirmed')">
                                                <i class="fas fa-check me-1"></i>Confirm
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="viewRequestDetails('{{ request.id if request.id is defined else request.get('id', loop.index) if request.get is defined else loop.index }}')">
                                                <i class="fas fa-eye me-1"></i>View
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <h6>No Pending Requests</h6>
                            <p>All service requests have been processed.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.location.href='/admin/project-tracking'">
                    <i class="fas fa-tasks me-1"></i>Manage All Requests
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Details Modal -->
<div class="modal fade" id="appointmentDetailsModal" tabindex="-1" aria-labelledby="appointmentDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="appointmentDetailsModalLabel">
                    <i class="fas fa-calendar-check me-2"></i>Appointment Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><strong>Client Name:</strong></label>
                            <p id="detailClientName" class="mb-1">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Service:</strong></label>
                            <p id="detailService" class="mb-1">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Date & Time:</strong></label>
                            <p id="detailDateTime" class="mb-1">-</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><strong>Estimated Amount:</strong></label>
                            <p id="detailAmount" class="mb-1">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Status:</strong></label>
                            <p id="detailStatus" class="mb-1">-</p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label"><strong>Appointment ID:</strong></label>
                            <p id="detailId" class="mb-1">-</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="editAppointment()">
                    <i class="fas fa-edit me-1"></i>Edit Appointment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Payment Tracking Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark Invoice as Paid</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label class="form-label">Invoice ID:</label>
                        <input type="text" class="form-control" id="paymentInvoiceId" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Amount:</label>
                        <input type="number" class="form-control" id="paymentAmount" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Method:</label>
                        <select class="form-select" id="paymentMethod" required>
                            <option value="">Select Method</option>
                            <option value="cash">Cash</option>
                            <option value="check">Check</option>
                            <option value="venmo">Venmo</option>
                            <option value="zelle">Zelle</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="credit_card">Credit Card</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes (Optional):</label>
                        <textarea class="form-control" id="paymentNotes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitPayment()">Mark as Paid</button>
            </div>
        </div>
    </div>
</div>

<!-- Staff Management Modal -->
<div class="modal fade" id="staffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Enhanced Staff Management</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="staffSummary">
                    <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading staff data...</p>
                </div>
                
                <hr>
                
                <h6>Add New Staff Member</h6>
                <form id="staffForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name:</label>
                            <input type="text" class="form-control" id="staffName" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Role:</label>
                            <select class="form-select" id="staffRole" required>
                                <option value="">Select Role</option>
                                <option value="admin">Admin</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="crew_member">Crew Member</option>
                                <option value="specialist">Specialist</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Phone:</label>
                            <input type="tel" class="form-control" id="staffPhone">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Hourly Rate:</label>
                            <input type="number" class="form-control" id="staffRate" step="0.01" value="25.00">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="addStaffMember()">Add Staff</button>
            </div>
        </div>
    </div>
</div>

<script>
// Side Menu Functionality
function toggleSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    if (sideMenu.classList.contains('active')) {
        closeSideMenu();
    } else {
        openSideMenu();
    }
}

function openSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    sideMenu.classList.add('active');
    overlay.style.display = 'block';
    toggleBtn.classList.add('active');
    
    // Change icon to close
    const icon = toggleBtn.querySelector('i');
    icon.className = 'fas fa-times';
    
    // Prevent body scroll when menu is open
    document.body.style.overflow = 'hidden';
}

function closeSideMenu() {
    const sideMenu = document.getElementById('sideMenu');
    const overlay = document.getElementById('sideMenuOverlay');
    const toggleBtn = document.getElementById('quickActionsToggle');
    
    sideMenu.classList.remove('active');
    overlay.style.display = 'none';
    toggleBtn.classList.remove('active');
    
    // Change icon back to bolt
    const icon = toggleBtn.querySelector('i');
    icon.className = 'fas fa-bolt';
    
    // Restore body scroll
    document.body.style.overflow = '';
}

// Close menu when pressing Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSideMenu();
    }
});

// Close menu when clicking on menu items (for better UX)
document.addEventListener('DOMContentLoaded', function() {
    const menuItems = document.querySelectorAll('.menu-item');
    menuItems.forEach(item => {
        item.addEventListener('click', function() {
            // Small delay to allow the navigation to start
            setTimeout(closeSideMenu, 100);
        });
    });
});

// Add CSS for time slot schedule
const timeSlotStyles = `
<style>
.time-slot-schedule {
    display: grid;
    grid-template-rows: auto repeat(11, 1fr);
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
    background: white;
}

.schedule-header {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.time-column-header {
    padding: 12px 8px;
    font-weight: bold;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
}

.day-column-header {
    padding: 12px 8px;
    border-left: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60px;
}

.schedule-row {
    display: grid;
    grid-template-columns: 100px repeat(7, 1fr);
    border-bottom: 1px solid #dee2e6;
    min-height: 50px;
}

.time-column {
    padding: 8px;
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
}

.time-label {
    font-size: 0.8rem;
    font-weight: 500;
    color: #495057;
}

.appointment-slot {
    padding: 4px;
    border-left: 1px solid #dee2e6;
    position: relative;
    cursor: pointer;
    transition: background-color 0.2s;
    min-height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.appointment-slot:hover {
    background-color: #f8f9fa;
}

.appointment-block {
    width: 100%;
    max-width: 100%;
    margin: 0;
    font-size: 0.75rem;
    line-height: 1.2;
    padding: 4px 6px !important;
}

.empty-slot {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.3;
    transition: opacity 0.2s;
}

.appointment-slot:hover .empty-slot {
    opacity: 0.8;
}

.empty-slot i {
    font-size: 1.2rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .schedule-header,
    .schedule-row {
        grid-template-columns: 80px repeat(7, 1fr);
    }
    
    .time-column-header,
    .time-column {
        padding: 8px 4px;
    }
    
    .time-label {
        font-size: 0.7rem;
    }
    
    .day-column-header {
        padding: 8px 4px;
        font-size: 0.8rem;
    }
    
    .appointment-block {
        font-size: 0.65rem;
        padding: 2px 4px !important;
    }
}
</style>
`;

document.head.insertAdjacentHTML('beforeend', timeSlotStyles);

// Schedule view switching functionality
function switchView(viewType) {
    const weekBtn = document.getElementById('weekView');
    const monthBtn = document.getElementById('monthView');
    const weeklyView = document.getElementById('weeklyView');
    const extendedView = document.getElementById('extendedView');
    const scheduleTitle = document.getElementById('scheduleTitle');
    const dateRange = document.getElementById('dateRange');
    
    if (viewType === 'week') {
        // Switch to weekly view
        weekBtn.classList.add('active');
        monthBtn.classList.remove('active');
        weeklyView.classList.remove('d-none');
        extendedView.classList.add('d-none');
        scheduleTitle.textContent = 'Weekly Schedule';
        
        // Update date range for weekly view
        {% if week_dates %}
        dateRange.innerHTML = '{{ week_dates[0].strftime("%B %d") }} - {{ week_dates[6].strftime("%B %d, %Y") }}';
        {% endif %}
    } else if (viewType === 'month') {
        // Switch to extended view
        weekBtn.classList.remove('active');
        monthBtn.classList.add('active');
        weeklyView.classList.add('d-none');
        extendedView.classList.remove('d-none');
        scheduleTitle.textContent = 'Extended Schedule (4 Weeks)';
        
        // Update date range for extended view
        {% if all_weeks and all_weeks|length > 0 %}
        dateRange.innerHTML = '{{ all_weeks[0]["dates"][0].strftime("%B %d") }} - {{ all_weeks[-1]["dates"][6].strftime("%B %d, %Y") }}';
        {% endif %}
    }
}

// Week navigation functionality
let currentWeekOffset = 0; // 0 = current week, -1 = last week, 1 = next week

function changeWeek(direction) {
    currentWeekOffset += direction;
    
    // Update the URL with week parameter and reload
    const url = new URL(window.location);
    url.searchParams.set('week_offset', currentWeekOffset);
    window.location.href = url.toString();
}

function goToToday() {
    currentWeekOffset = 0;
    
    // Remove week_offset parameter and reload
    const url = new URL(window.location);
    url.searchParams.delete('week_offset');
    window.location.href = url.toString();
}

// Initialize current week offset from URL parameter
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const weekOffset = urlParams.get('week_offset');
    if (weekOffset) {
        currentWeekOffset = parseInt(weekOffset);
    }
    
    // Update button states based on current week
    updateNavigationButtons();
    
    // Test if appointment modal function is accessible
    console.log('Testing appointment modal function:', typeof openNewAppointmentModal);
    window.openNewAppointmentModal = openNewAppointmentModal;
    
    // Add click listeners for navigation buttons
    const prevWeekBtn = document.getElementById('prevWeek');
    const nextWeekBtn = document.getElementById('nextWeek');
    
    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Previous week clicked');
            changeWeek(-1);
        });
    }
    
    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Next week clicked');
            changeWeek(1);
        });
    }
    
    // Add click listeners for empty appointment slots
    document.querySelectorAll('.empty-slot').forEach(slot => {
        slot.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            const time = this.getAttribute('data-time');
            console.log('Empty slot clicked:', date, time);
            openNewAppointmentModal(date, time);
        });
    });
});

// Week navigation function
function changeWeek(direction) {
    console.log('changeWeek called with direction:', direction);
    currentWeekOffset += direction;
    
    // Reload page with new week offset
    const url = new URL(window.location);
    url.searchParams.set('week_offset', currentWeekOffset);
    console.log('Navigating to:', url.toString());
    window.location.href = url.toString();
}

// Show appointment details function
function showAppointmentDetails(id, clientName, service, amount, status, time, date) {
    console.log('Showing appointment details:', {id, clientName, service, amount, status, time, date});
    
    // Populate modal fields
    document.getElementById('detailId').textContent = id || 'N/A';
    document.getElementById('detailClientName').textContent = clientName || 'Unknown Client';
    document.getElementById('detailService').textContent = service || 'No service specified';
    document.getElementById('detailAmount').textContent = amount && amount !== 'TBD' ? `$${amount}` : 'To be determined';
    document.getElementById('detailStatus').textContent = status || 'Scheduled';
    
    // Format date and time
    const formattedDate = new Date(date).toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    const formattedTime = time.includes(':') ? 
        new Date(`2000-01-01T${time}`).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        }) : time;
    
    document.getElementById('detailDateTime').textContent = `${formattedDate} at ${formattedTime}`;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('appointmentDetailsModal'));
    modal.show();
}

// Edit appointment function placeholder
function editAppointment() {
    console.log('Edit appointment functionality not implemented yet');
    // Close details modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('appointmentDetailsModal'));
    if (modal) {
        modal.hide();
    }
    // Could open edit form or navigate to edit page
}

function updateNavigationButtons() {
    const todayBtn = document.getElementById('todayBtn');
    
    // Highlight "Today" button if we're viewing current week
    if (currentWeekOffset === 0) {
        todayBtn.classList.add('btn-light');
        todayBtn.classList.remove('btn-outline-light');
    } else {
        todayBtn.classList.remove('btn-light');
        todayBtn.classList.add('btn-outline-light');
    }
}

// Appointment modal functions
function openNewAppointmentModal(date, time) {
    console.log('openNewAppointmentModal called with:', date, time);
    
    // Set the date and time in the modal
    document.getElementById('appointmentDate').value = date;
    document.getElementById('appointmentTime').value = time;
    
    // Convert time to display format for the time selector
    const timeOptions = {
        '7:00': '7:00', '8:00': '8:00', '9:00': '9:00', '10:00': '10:00',
        '11:00': '11:00', '12:00': '12:00', '13:00': '13:00', '14:00': '14:00',
        '15:00': '15:00', '16:00': '16:00', '17:00': '17:00'
    };
    
    if (timeOptions[time]) {
        document.getElementById('appointmentTime').value = time;
    }
    
    // Clear any previous form data
    document.getElementById('newAppointmentForm').reset();
    document.getElementById('appointmentDate').value = date;
    document.getElementById('appointmentTime').value = time;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('newAppointmentModal'));
    modal.show();
}

function createAppointment() {
    const form = document.getElementById('newAppointmentForm');
    
    // Validate form
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Collect form data
    const appointmentData = {
        date: document.getElementById('appointmentDate').value,
        time: document.getElementById('appointmentTime').value,
        client_name: document.getElementById('clientName').value,
        client_phone: document.getElementById('clientPhone').value,
        service_type: document.getElementById('serviceType').value,
        service_description: document.getElementById('serviceDescription').value,
        estimated_duration: document.getElementById('estimatedDuration').value
    };
    
    // Create appointment via API
    fetch('/api/appointments/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(appointmentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newAppointmentModal'));
            modal.hide();
            
            // Show success message
            alert('Appointment created successfully!');
            
            // Reload the page to show the new appointment
            window.location.reload();
        } else {
            alert('Error creating appointment: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating appointment. Please try again.');
    });
}

// Show pending details modal
function showPendingDetails() {
    console.log('Showing pending details modal');
    const modal = new bootstrap.Modal(document.getElementById('pendingDetailsModal'));
    modal.show();
}

// Update request status
function updateRequestStatus(requestId, status) {
    console.log('Updating request status:', requestId, status);
    
    fetch(`/admin/update-booking/${requestId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${status}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(`Request ${status} successfully!`);
            
            // Reload the page to reflect changes
            window.location.reload();
        } else {
            alert('Error updating request: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating request. Please try again.');
    });
}

// View request details
function viewRequestDetails(requestId) {
    console.log('Viewing request details:', requestId);
    
    // Close pending modal
    const pendingModal = bootstrap.Modal.getInstance(document.getElementById('pendingDetailsModal'));
    if (pendingModal) {
        pendingModal.hide();
    }
    
    // Navigate to project tracking for detailed view
    window.location.href = `/admin/project-tracking#request-${requestId}`;
}

// ========== ADVANCED DRAG & DROP FUNCTIONALITY ==========

let draggedAppointment = null;
let draggedElement = null;

// Drag and Drop Event Handlers
function allowDrop(event) {
    event.preventDefault();
    const dropZone = event.currentTarget;
    if (!dropZone.classList.contains('drag-over')) {
        dropZone.classList.add('drag-over');
    }
}

function dragEnter(event) {
    event.preventDefault();
    const dropZone = event.currentTarget;
    dropZone.classList.add('drag-enter');
}

function dragLeave(event) {
    event.preventDefault();
    const dropZone = event.currentTarget;
    dropZone.classList.remove('drag-enter', 'drag-over');
}

function dropAppointment(event) {
    event.preventDefault();
    
    const dropZone = event.currentTarget;
    dropZone.classList.remove('drag-enter', 'drag-over');
    
    if (!draggedAppointment) {
        console.log('No appointment being dragged');
        return;
    }
    
    const newDate = dropZone.dataset.date;
    const appointmentId = draggedAppointment.id;
    const originalDate = draggedAppointment.date;
    
    if (newDate === originalDate) {
        console.log('Dropped on same date, no change needed');
        return;
    }
    
    console.log(`Moving appointment ${appointmentId} from ${originalDate} to ${newDate}`);
    
    // Call API to reschedule appointment
    rescheduleAppointment(appointmentId, newDate, draggedAppointment.time);
    
    // Reset drag state
    draggedAppointment = null;
    if (draggedElement) {
        draggedElement.classList.remove('dragging');
        draggedElement = null;
    }
}

// Initialize drag events for appointment blocks
document.addEventListener('DOMContentLoaded', function() {
    initializeDragAndDrop();
    initializeAdvancedFeatures();
});

function initializeDragAndDrop() {
    document.querySelectorAll('.draggable-appointment').forEach(appointment => {
        appointment.addEventListener('dragstart', function(e) {
            console.log('Drag started for appointment:', this.dataset.appointmentId);
            
            draggedAppointment = {
                id: this.dataset.appointmentId,
                date: this.dataset.appointmentDate,
                time: this.dataset.appointmentTime,
                clientName: this.dataset.clientName,
                service: this.dataset.service
            };
            
            draggedElement = this;
            this.classList.add('dragging');
            
            // Set drag data
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedAppointment));
            e.dataTransfer.effectAllowed = 'move';
        });
        
        appointment.addEventListener('dragend', function() {
            console.log('Drag ended');
            this.classList.remove('dragging');
            
            // Clear all drag states
            document.querySelectorAll('.drop-zone').forEach(zone => {
                zone.classList.remove('drag-enter', 'drag-over');
            });
        });
    });
}

// API call to reschedule appointment
function rescheduleAppointment(appointmentId, newDate, time) {
    showToast('Rescheduling appointment...', 'info');
    
    fetch('/api/unified/reschedule', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            appointment_id: appointmentId,
            new_date: newDate,
            time: time
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Appointment rescheduled successfully!', 'success');
            // Reload page to show updated schedule
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('Failed to reschedule appointment: ' + (data.error || 'Unknown error'), 'error');
        }
    })
    .catch(error => {
        console.error('Error rescheduling appointment:', error);
        showToast('Error rescheduling appointment. Please try again.', 'error');
    });
}

// ========== ADVANCED CALENDAR FEATURES ==========

function initializeAdvancedFeatures() {
    // Enhanced appointment creation
    initializeQuickBooking();
    
    // Calendar view switching
    initializeViewSwitching();
    
    // Auto-refresh functionality
    initializeAutoRefresh();
    
    // Keyboard shortcuts
    initializeKeyboardShortcuts();
    
    // Enhanced tooltips
    initializeEnhancedTooltips();
}

// Quick booking functionality
function initializeQuickBooking() {
    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dblclick', function() {
            const date = this.dataset.date;
            openQuickBookingModal(date);
        });
    });
}

function openQuickBookingModal(date) {
    // Populate date in new appointment modal
    const dateInput = document.querySelector('#newAppointmentModal input[type="date"]');
    if (dateInput) {
        dateInput.value = date;
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('newAppointmentModal'));
    modal.show();
    
    showToast(`Quick booking for ${new Date(date).toLocaleDateString()}`, 'info');
}

// Enhanced view switching
function initializeViewSwitching() {
    // Add view toggle buttons to the interface
    const scheduleTitle = document.querySelector('.schedule-title');
    if (scheduleTitle && !document.querySelector('.view-toggle-buttons')) {
        const viewToggle = document.createElement('div');
        viewToggle.className = 'view-toggle-buttons ms-auto';
        viewToggle.innerHTML = `
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary btn-sm active" onclick="switchToCalendarView()">
                    <i class="fas fa-calendar-alt me-1"></i>Calendar
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchToTimelineView()">
                    <i class="fas fa-clock me-1"></i>Timeline
                </button>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="switchToListView()">
                    <i class="fas fa-list me-1"></i>List
                </button>
            </div>
        `;
        scheduleTitle.appendChild(viewToggle);
    }
}

function switchToCalendarView() {
    document.querySelectorAll('.view-toggle-buttons .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.view-toggle-buttons .btn:first-child').classList.add('active');
    showToast('Switched to Calendar view', 'info');
}

function switchToTimelineView() {
    document.querySelectorAll('.view-toggle-buttons .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.view-toggle-buttons .btn:nth-child(2)').classList.add('active');
    showToast('Timeline view coming soon!', 'info');
}

function switchToListView() {
    document.querySelectorAll('.view-toggle-buttons .btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.view-toggle-buttons .btn:last-child').classList.add('active');
    window.location.href = '/admin/scheduler/unified';
}

// Auto-refresh functionality
function initializeAutoRefresh() {
    // Auto-refresh every 2 minutes to show new appointments
    setInterval(() => {
        refreshCalendarData();
    }, 120000);
}

function refreshCalendarData() {
    // Subtle refresh without full page reload
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Extract and update only the calendar portion
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newCalendar = doc.querySelector('.calendar-day-card');
        
        if (newCalendar) {
            console.log('Calendar data refreshed');
            // Reinitialize drag and drop after refresh
            setTimeout(() => {
                initializeDragAndDrop();
            }, 500);
        }
    })
    .catch(error => {
        console.log('Auto-refresh failed:', error);
    });
}

// Keyboard shortcuts
function initializeKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Only trigger shortcuts when not in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            return;
        }
        
        // Ctrl+N: New appointment
        if (e.ctrlKey && e.key === 'n') {
            e.preventDefault();
            const modal = new bootstrap.Modal(document.getElementById('newAppointmentModal'));
            modal.show();
        }
        
        // Ctrl+R: Refresh calendar
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            refreshCalendarData();
            showToast('Calendar refreshed', 'info');
        }
        
        // Arrow keys: Navigate weeks
        if (e.key === 'ArrowLeft' && e.ctrlKey) {
            e.preventDefault();
            changeWeek(-1);
        }
        if (e.key === 'ArrowRight' && e.ctrlKey) {
            e.preventDefault();
            changeWeek(1);
        }
    });
}

// Enhanced tooltips for appointments
function initializeEnhancedTooltips() {
    document.querySelectorAll('.draggable-appointment').forEach(appointment => {
        const clientName = appointment.dataset.clientName;
        const service = appointment.dataset.service;
        const time = appointment.dataset.appointmentTime;
        const date = appointment.dataset.appointmentDate;
        
        appointment.title = `${clientName}\n${service}\n${time} on ${new Date(date).toLocaleDateString()}`;
        
        // Add hover effects
        appointment.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px) scale(1.02)';
            this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
        
        appointment.addEventListener('mouseleave', function() {
            if (!this.classList.contains('dragging')) {
                this.style.transform = '';
                this.style.boxShadow = '';
            }
        });
    });
}

// ========== RECURRING APPOINTMENTS ==========

function createRecurringAppointment() {
    showToast('Recurring appointments feature coming soon!', 'info');
    // This would integrate with the recurring appointment modal from advanced scheduler
}

// ========== CONFLICT DETECTION ==========

function checkSchedulingConflicts(date, time) {
    // Check for scheduling conflicts before creating appointments
    return fetch('/api/unified/check-conflicts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            date: date,
            time: time
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.conflicts && data.conflicts.length > 0) {
            showToast(`Scheduling conflict detected at ${time}`, 'warning');
            return false;
        }
        return true;
    })
    .catch(error => {
        console.error('Error checking conflicts:', error);
        return true; // Allow scheduling if check fails
    });
}

// ========== ENHANCED APPOINTMENT MODAL ==========

function showEnhancedAppointmentDetails(appointment) {
    // Enhanced version of the appointment details modal
    const modal = document.getElementById('appointmentDetailsModal');
    if (!modal) return;
    
    // Populate enhanced details
    document.getElementById('detailId').textContent = appointment.id;
    document.getElementById('detailClientName').textContent = appointment.clientName;
    document.getElementById('detailService').textContent = appointment.service;
    document.getElementById('detailAmount').textContent = appointment.amount || 'TBD';
    document.getElementById('detailStatus').textContent = appointment.status;
    
    // Add enhanced action buttons if not already present
    const modalFooter = modal.querySelector('.modal-footer');
    if (modalFooter && !modalFooter.querySelector('.enhanced-actions')) {
        const enhancedActions = document.createElement('div');
        enhancedActions.className = 'enhanced-actions';
        enhancedActions.innerHTML = `
            <button type="button" class="btn btn-warning btn-sm" onclick="rescheduleAppointmentModal('${appointment.id}')">
                <i class="fas fa-calendar-alt me-1"></i>Reschedule
            </button>
            <button type="button" class="btn btn-info btn-sm" onclick="duplicateAppointment('${appointment.id}')">
                <i class="fas fa-copy me-1"></i>Duplicate
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="markCompleted('${appointment.id}')">
                <i class="fas fa-check me-1"></i>Complete
            </button>
        `;
        modalFooter.insertBefore(enhancedActions, modalFooter.querySelector('.btn-secondary'));
    }
    
    new bootstrap.Modal(modal).show();
}

function rescheduleAppointmentModal(appointmentId) {
    showToast('Opening reschedule dialog...', 'info');
    // This would open a dedicated reschedule modal
}

function duplicateAppointment(appointmentId) {
    showToast('Duplicating appointment...', 'info');
    // This would create a copy of the appointment
}

function markCompleted(appointmentId) {
    showToast('Marking appointment as completed...', 'success');
    // This would update the appointment status
}

console.log('✅ Advanced scheduling features initialized');
</script>
{% endblock %}