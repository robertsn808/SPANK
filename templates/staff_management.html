{% extends "admin_base.html" %}

{% block title %}Staff Management - SPANKKS Construction{% endblock %}

{% block extra_head %}
<style>
.staff-container {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: calc(100vh - 80px); /* Account for admin header */
    padding: 2rem 0;
    margin-top: 0; /* Ensure it doesn't overlap admin header */
}

.staff-header {
    background: linear-gradient(45deg, #2c3e50, #34495e);
    color: white;
    padding: 1.5rem;
    border-radius: 15px 15px 0 0;
    text-align: center;
}

.staff-card {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    margin-bottom: 2rem;
}

.staff-member-card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 5px solid #3498db;
    transition: transform 0.2s ease;
}

.staff-member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.staff-active {
    border-left-color: #27ae60;
}

.staff-part-time {
    border-left-color: #f39c12;
}

.staff-inactive {
    border-left-color: #e74c3c;
    opacity: 0.7;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-part-time {
    background: #fff3cd;
    color: #856404;
}

.status-inactive {
    background: #f8d7da;
    color: #721c24;
}

.skill-tag {
    display: inline-block;
    background: #e9ecef;
    color: #495057;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin: 0.2rem;
}

.availability-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.5rem;
    margin-top: 1rem;
}

.day-available {
    background: #d4edda;
    color: #155724;
    padding: 0.3rem;
    text-align: center;
    border-radius: 4px;
    font-size: 0.75rem;
}

.day-unavailable {
    background: #f8d7da;
    color: #721c24;
    padding: 0.3rem;
    text-align: center;
    border-radius: 4px;
    font-size: 0.75rem;
}

.staff-stats {
    background: white;
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-item {
    text-align: center;
    padding: 1rem;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #2c3e50;
    display: block;
}

.stat-label {
    color: #7f8c8d;
    font-size: 0.9rem;
    text-transform: uppercase;
}

.job-assignment {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.assigned-job {
    background: #e8f4f8;
    border-radius: 6px;
    padding: 0.5rem;
    margin: 0.3rem 0;
    font-size: 0.9rem;
}

.quick-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.action-btn {
    border-radius: 20px;
    padding: 0.4rem 1rem;
    font-size: 0.85rem;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

@media (max-width: 768px) {
    .staff-container {
        padding: 1rem;
    }
    
    .availability-grid {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .quick-actions {
        flex-direction: column;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Quick Actions Navigation -->
    {% include 'quick_actions_nav.html' %}
</div>

<div class="staff-container">
    <div class="container-fluid">
        
        <!-- Header -->
        <div class="staff-card">
            <div class="staff-header">
                <h1><i class="fas fa-users"></i> Staff Management</h1>
                <p class="mb-0">Manage team members, assignments, and availability</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="staff-stats">
            <div class="row">
                <div class="col-md-3">
                    <div class="stat-item">
                        <span class="stat-number">{{ staff|selectattr('status', 'equalto', 'active')|list|length }}</span>
                        <span class="stat-label">Active Staff</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <span class="stat-number">{{ staff|selectattr('status', 'equalto', 'part_time')|list|length }}</span>
                        <span class="stat-label">Part-Time</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <span class="stat-number">{{ jobs|length }}</span>
                        <span class="stat-label">Active Jobs</span>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-item">
                        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addStaffModal">
                            <i class="fas fa-plus"></i> Add Staff Member
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Staff Members -->
        <div class="row">
            {% for member in staff %}
            <div class="col-lg-6">
                <div class="staff-member-card staff-{{ member.status }}">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="mb-1">{{ member.name }}</h5>
                                <span class="status-badge status-{{ member.status }}">{{ member.status|replace('_', ' ')|title }}</span>
                            </div>
                            
                            <p class="text-muted mb-2">
                                <i class="fas fa-briefcase"></i> {{ member.role }}
                                <span class="ms-3"><i class="fas fa-phone"></i> {{ member.phone }}</span>
                            </p>
                            
                            <p class="mb-2">
                                <strong>Rate:</strong> ${{ "%.2f"|format(member.hourly_rate) }}/hr
                                <span class="ms-3"><strong>Hired:</strong> {{ member.hire_date }}</span>
                            </p>

                            <!-- Skills -->
                            <div class="mb-3">
                                <strong>Skills:</strong><br>
                                {% for skill in member.skills %}
                                <span class="skill-tag">{{ skill.strip() }}</span>
                                {% endfor %}
                            </div>

                            <!-- Weekly Availability -->
                            <div class="mb-3">
                                <strong>Availability:</strong>
                                <div class="availability-grid">
                                    {% set days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'] %}
                                    {% for day in days %}
                                    <div class="{% if member.availability[day] %}day-available{% else %}day-unavailable{% endif %}">
                                        {{ day[:3]|title }}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Job Assignments -->
                            {% if member.assigned_jobs %}
                            <div class="job-assignment">
                                <strong>Current Assignments ({{ member.assigned_jobs|length }}):</strong>
                                {% for job_id in member.assigned_jobs %}
                                <div class="assigned-job">
                                    <i class="fas fa-wrench"></i> Job: {{ job_id }}
                                    <a href="{{ url_for('job_detail', job_id=job_id) }}" class="btn btn-sm btn-outline-primary ms-2">View</a>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            <!-- Quick Actions -->
                            <div class="quick-actions">
                                <button class="action-btn btn btn-primary" onclick="showAssignJobModal('{{ member.staff_id }}', '{{ member.name }}')">
                                    <i class="fas fa-calendar-plus"></i> Assign Job
                                </button>
                                <a href="{{ url_for('staff_member_portal', staff_id=member.staff_id) }}" class="action-btn btn btn-info">
                                    <i class="fas fa-user-circle"></i> View Portal
                                </a>
                                <button class="action-btn btn btn-warning" onclick="editStaff('{{ member.staff_id }}')">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-md-4 text-center">
                            <div class="p-3">
                                <i class="fas fa-user-circle fa-4x text-muted mb-3"></i>
                                <p class="mb-1"><strong>ID:</strong> {{ member.staff_id }}</p>
                                <p class="mb-1"><strong>Email:</strong></p>
                                <small class="text-muted">{{ member.email }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

    </div>
</div>

<!-- Add Staff Modal -->
<div class="modal fade" id="addStaffModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Staff Member</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('add_staff_member') }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Role/Position</label>
                                <select class="form-select" name="role" required>
                                    <option value="">Select Role</option>
                                    <option value="Lead Carpenter">Lead Carpenter</option>
                                    <option value="Flooring Specialist">Flooring Specialist</option>
                                    <option value="Electrical Technician">Electrical Technician</option>
                                    <option value="Plumbing Specialist">Plumbing Specialist</option>
                                    <option value="General Helper">General Helper</option>
                                    <option value="Project Manager">Project Manager</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" name="phone" placeholder="(808) 555-0000" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email Address</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Staff PIN (for portal access)</label>
                                <input type="text" class="form-control" name="pin" placeholder="Unique4DigitPIN" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Hourly Rate ($)</label>
                                <input type="number" class="form-control" name="hourly_rate" step="0.01" min="15" max="100" value="20" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Skills (comma-separated)</label>
                                <input type="text" class="form-control" name="skills" placeholder="Carpentry, Drywall, Painting" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Weekly Availability</label>
                                <div class="row">
                                    {% set days = [('monday', 'Monday'), ('tuesday', 'Tuesday'), ('wednesday', 'Wednesday'), ('thursday', 'Thursday'), ('friday', 'Friday'), ('saturday', 'Saturday'), ('sunday', 'Sunday')] %}
                                    {% for day_key, day_name in days %}
                                    <div class="col-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="{{ day_key }}" id="{{ day_key }}" {% if day_key in ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'] %}checked{% endif %}>
                                            <label class="form-check-label" for="{{ day_key }}">
                                                {{ day_name }}
                                            </label>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Staff Member</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Assign Job Modal -->
<div class="modal fade" id="assignJobModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assign Job to <span id="staffMemberName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="assignJobForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Select Job</label>
                        <select class="form-select" name="job_id" required>
                            <option value="">Choose a job...</option>
                            {% for job in jobs %}
                            <option value="{{ job.job_id }}">
                                {{ job.job_id }} - {{ job.get('service_type', 'General Service') }}
                                {% if job.get('contact_name') %} ({{ job.contact_name }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> This will assign the staff member to the selected job and add them to the job's crew.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign Job</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showAssignJobModal(staffId, staffName) {
    document.getElementById('staffMemberName').textContent = staffName;
    document.getElementById('assignJobForm').action = `/admin/staff/${staffId}/assign`;
    new bootstrap.Modal(document.getElementById('assignJobModal')).show();
}

function editStaff(staffId) {
    // Future enhancement: Edit staff modal
    alert('Edit staff functionality coming soon!');
}

// Auto-format phone number
document.querySelector('[name="phone"]').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 6) {
        value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6,10)}`;
    } else if (value.length >= 3) {
        value = `(${value.slice(0,3)}) ${value.slice(3)}`;
    }
    e.target.value = value;
});
</script>
{% endblock %}