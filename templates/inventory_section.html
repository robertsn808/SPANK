<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-boxes me-2"></i>Inventory Management
        </h3>
        <div class="btn-group">
            <button class="btn btn-spankks btn-sm" onclick="showAddInventoryModal()">
                <i class="fas fa-plus me-1"></i>Add Item
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="exportInventoryReport()">
                <i class="fas fa-download me-1"></i>Export Report
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Inventory Overview Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalItems">0</div>
                    <div class="stat-label">Total Items</div>
                    <div class="stat-change">
                        <i class="fas fa-boxes me-1"></i>In Stock
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="lowStockItems">0</div>
                    <div class="stat-label">Low Stock</div>
                    <div class="stat-change negative">
                        <i class="fas fa-exclamation-triangle me-1"></i>Need Reorder
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="inventoryValue">$0</div>
                    <div class="stat-label">Total Value</div>
                    <div class="stat-change positive">
                        <i class="fas fa-dollar-sign me-1"></i>Current
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="lastUpdated">Today</div>
                    <div class="stat-label">Last Updated</div>
                    <div class="stat-change">
                        <i class="fas fa-clock me-1"></i>Tracking
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventory Filters -->
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" class="form-control" placeholder="Search inventory..." id="inventorySearch">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="drywall">Drywall Materials</option>
                    <option value="flooring">Flooring Supplies</option>
                    <option value="fence">Fence Materials</option>
                    <option value="tools">Tools & Equipment</option>
                    <option value="hardware">Hardware & Fasteners</option>
                    <option value="paint">Paint & Finishes</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="stockFilter">
                    <option value="">All Stock Levels</option>
                    <option value="in_stock">In Stock</option>
                    <option value="low_stock">Low Stock</option>
                    <option value="out_of_stock">Out of Stock</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-outline-success" onclick="refreshInventory()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
        
        <!-- Inventory Table -->
        <div class="table-responsive">
            <table class="table data-table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>Item Name</th>
                        <th>Category</th>
                        <th>Current Stock</th>
                        <th>Reorder Level</th>
                        <th>Unit Cost</th>
                        <th>Total Value</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="loading-spinner me-2"></div>
                            Loading inventory...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Inventory Item Modal -->
<div class="modal fade" id="addInventoryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>Add Inventory Item
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addInventoryForm">
                    <div class="mb-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-control" name="item_name" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" name="category" required>
                                    <option value="">Select Category</option>
                                    <option value="drywall">Drywall Materials</option>
                                    <option value="flooring">Flooring Supplies</option>
                                    <option value="fence">Fence Materials</option>
                                    <option value="tools">Tools & Equipment</option>
                                    <option value="hardware">Hardware & Fasteners</option>
                                    <option value="paint">Paint & Finishes</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Unit</label>
                                <select class="form-select" name="unit">
                                    <option value="each">Each</option>
                                    <option value="box">Box</option>
                                    <option value="bag">Bag</option>
                                    <option value="roll">Roll</option>
                                    <option value="sheet">Sheet</option>
                                    <option value="gallon">Gallon</option>
                                    <option value="linear_ft">Linear Ft</option>
                                    <option value="sq_ft">Sq Ft</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Current Stock</label>
                                <input type="number" class="form-control" name="current_stock" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" name="reorder_level" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Unit Cost</label>
                                <input type="number" class="form-control" name="unit_cost" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Supplier</label>
                        <input type="text" class="form-control" name="supplier" placeholder="Primary supplier name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Additional notes about this item"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="saveInventoryItem()">
                    <i class="fas fa-save me-1"></i>Add Item
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function loadInventoryData() {
    // Load authentic inventory data from API
    fetch('/api/inventory')
        .then(response => response.json())
        .then(inventory => {
            displayInventoryData(inventory);
        })
        .catch(error => {
            console.error('Error loading inventory:', error);
            displayInventoryData([]);
        });
}

function displayInventoryData(inventory) {
    const tbody = document.getElementById('inventoryTableBody');
    
    if (inventory.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <div>No inventory items found. Add your first item to get started.</div>
                </td>
            </tr>
        `;
        return;
    }
    
    let totalItems = 0;
    let lowStockCount = 0;
    let totalValue = 0;
    
    tbody.innerHTML = inventory.map(item => {
        const totalItemValue = item.current_stock * item.unit_cost;
        const isLowStock = item.current_stock <= item.reorder_level;
        const stockStatus = item.current_stock === 0 ? 'out_of_stock' : 
                           isLowStock ? 'low_stock' : 'in_stock';
        
        totalItems += item.current_stock;
        totalValue += totalItemValue;
        if (isLowStock) lowStockCount++;
        
        return `
            <tr>
                <td>
                    <strong>${item.item_name}</strong>
                    <div class="text-muted small">ID: ${item.id}</div>
                </td>
                <td>
                    <span class="badge bg-info">${getCategoryDisplay(item.category)}</span>
                </td>
                <td>
                    <strong>${item.current_stock}</strong> ${item.unit}
                </td>
                <td>${item.reorder_level} ${item.unit}</td>
                <td>$${item.unit_cost.toFixed(2)}</td>
                <td>
                    <strong>$${totalItemValue.toFixed(2)}</strong>
                </td>
                <td>
                    <span class="badge bg-${stockStatus === 'in_stock' ? 'success' : stockStatus === 'low_stock' ? 'warning' : 'danger'}">
                        ${getStatusDisplay(stockStatus)}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="editInventoryItem('${item.id}')" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="adjustStock('${item.id}')" title="Adjust Stock">
                            <i class="fas fa-plus-minus"></i>
                        </button>
                        <button class="btn btn-outline-warning" onclick="reorderItem('${item.id}')" title="Reorder">
                            <i class="fas fa-shopping-cart"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
    
    // Update overview cards
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('lowStockItems').textContent = lowStockCount;
    document.getElementById('inventoryValue').textContent = `$${totalValue.toFixed(0)}`;
    document.getElementById('lastUpdated').textContent = 'Today';
}

function getCategoryDisplay(category) {
    const categories = {
        'drywall': 'Drywall',
        'flooring': 'Flooring',
        'fence': 'Fence',
        'tools': 'Tools',
        'hardware': 'Hardware',
        'paint': 'Paint'
    };
    return categories[category] || category;
}

function getStatusDisplay(status) {
    const statuses = {
        'in_stock': 'In Stock',
        'low_stock': 'Low Stock',
        'out_of_stock': 'Out of Stock'
    };
    return statuses[status] || status;
}

function showAddInventoryModal() {
    const modal = new bootstrap.Modal(document.getElementById('addInventoryModal'));
    modal.show();
}

function saveInventoryItem() {
    const form = document.getElementById('addInventoryForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Add default fields
    data.id = `INV${String(sampleInventory.length + 1).padStart(3, '0')}`;
    data.last_updated = new Date().toISOString().split('T')[0];
    
    // Save to authentic inventory database via API
    fetch('/api/inventory/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadInventoryData(); // Reload from database
        } else {
            showToast('Error adding inventory item: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error adding inventory item:', error);
        showToast('Error adding inventory item', 'error');
    });
    
    bootstrap.Modal.getInstance(document.getElementById('addInventoryModal')).hide();
    form.reset();
    loadInventoryData();
    showToast('Inventory item added successfully!', 'success');
}

function editInventoryItem(itemId) {
    showToast(`Edit inventory item ${itemId} feature coming soon`, 'info');
}

function adjustStock(itemId) {
    const newStock = prompt('Enter new stock quantity:');
    if (newStock !== null && !isNaN(newStock)) {
        fetch('/api/inventory/adjust-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                item_id: itemId,
                new_stock: parseInt(newStock)
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadInventoryData();
                showToast('Stock updated successfully', 'success');
            } else {
                showToast('Error updating stock: ' + result.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error updating stock:', error);
            showToast('Error updating stock', 'error');
        });
    }
}

function reorderItem(itemId) {
    const item = sampleInventory.find(i => i.id === itemId);
    if (item) {
        showToast(`Reorder alert sent for ${item.item_name} to ${item.supplier}`, 'info');
    }
}

function refreshInventory() {
    loadInventoryData();
}

function exportInventoryReport() {
    showToast('Exporting inventory report...', 'info');
    // Implementation for inventory report export
}

// Load inventory data when section is shown
if (typeof loadInventoryData === 'function') {
    loadInventoryData();
}
</script>