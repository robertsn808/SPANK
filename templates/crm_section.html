<!-- Working CRM Section -->
<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-address-book me-2"></i>Customer CRM
        </h3>
        <div class="btn-group">
            <button class="btn btn-spankks btn-sm" onclick="addContact()">
                <i class="fas fa-user-plus me-1"></i>Add Contact
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="refreshTable()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Service</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="crmTableBody">
                    <tr><td colspan="7" class="text-center">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Immediate execution
console.log('Loading CRM data...');

fetch('/api/contacts')
.then(r => r.json())
.then(data => {
    console.log('Got', data.length, 'contacts');
    const tbody = document.getElementById('crmTableBody');
    tbody.innerHTML = data.map(c => `
        <tr>
            <td><strong>${c.name}</strong><br><small>${c.source}</small></td>
            <td><a href="tel:${c.phone}">${c.phone}</a></td>
            <td><a href="mailto:${c.email}">${c.email}</a></td>
            <td><span class="badge bg-secondary">${c.service_type}</span></td>
            <td><span class="badge bg-success">${c.status}</span></td>
            <td><small>${c.created_date || 'N/A'}</small></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewContact('${c.id}')">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="createQuote('${c.id}')">
                    <i class="fas fa-file-invoice-dollar"></i>
                </button>
            </td>
        </tr>
    `).join('');
})
.catch(e => {
    console.error('Error:', e);
    document.getElementById('crmTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading contacts</td></tr>';
});

function viewContact(id) { alert('View: ' + id); }
function createQuote(id) { window.open('/admin/quote-invoice-form?contactId=' + id, '_blank'); }
function addContact() { alert('Add contact modal - Coming soon'); }
function refreshTable() { location.reload(); }
</script>