<div class="row">
    <!-- Financial Overview Cards -->
    <div class="col-12 mb-4">
        <div class="row">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="monthlyRevenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up me-1"></i>This Month
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="pendingInvoices">0</div>
                    <div class="stat-label">Pending Invoices</div>
                    <div class="stat-change">
                        <i class="fas fa-clock me-1"></i>Awaiting Payment
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="overdueAmount">$0</div>
                    <div class="stat-label">Overdue Amount</div>
                    <div class="stat-change negative">
                        <i class="fas fa-exclamation-triangle me-1"></i>Past Due
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="profitMargin">0%</div>
                    <div class="stat-label">Profit Margin</div>
                    <div class="stat-change positive">
                        <i class="fas fa-chart-line me-1"></i>Current
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Financial Reports Tabs -->
    <div class="col-12">
        <div class="content-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>Financial Reports & P&L
                </h3>
                <div class="btn-group">
                    <button class="btn btn-spankks btn-sm" onclick="generatePLReport()">
                        <i class="fas fa-file-excel me-1"></i>Generate P&L
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="exportFinancialData()">
                        <i class="fas fa-download me-1"></i>Export Data
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Report Tabs -->
                <ul class="nav nav-tabs mb-4" id="financialTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab">
                            <i class="fas fa-file-invoice me-1"></i>Invoices
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                            <i class="fas fa-dollar-sign me-1"></i>Payments
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="expenses-tab" data-bs-toggle="tab" data-bs-target="#expenses" type="button" role="tab">
                            <i class="fas fa-receipt me-1"></i>Expenses
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="taxes-tab" data-bs-toggle="tab" data-bs-target="#taxes" type="button" role="tab">
                            <i class="fas fa-calculator me-1"></i>Hawaii Taxes
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="financialTabContent">
                    <!-- Invoices Tab -->
                    <div class="tab-pane fade show active" id="invoices" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" class="form-control" placeholder="Search invoices..." id="invoiceSearch">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="invoiceStatusFilter">
                                    <option value="">All Status</option>
                                    <option value="paid">Paid</option>
                                    <option value="unpaid">Unpaid</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="month" class="form-control" id="invoiceMonthFilter">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-outline-success" onclick="refreshInvoices()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table data-table" id="invoicesTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Client</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Due Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="loading-spinner me-2"></div>
                                            Loading invoices...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Payments Tab -->
                    <div class="tab-pane fade" id="payments" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-spankks" onclick="showPaymentModal()">
                                    <i class="fas fa-plus me-1"></i>Record Payment
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Amount</th>
                                        <th>Method</th>
                                        <th>Reference</th>
                                    </tr>
                                </thead>
                                <tbody id="paymentsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="loading-spinner me-2"></div>
                                            Loading payments...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Expenses Tab -->
                    <div class="tab-pane fade" id="expenses" role="tabpanel">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-spankks" onclick="showExpenseModal()">
                                    <i class="fas fa-plus me-1"></i>Add Expense
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table data-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expensesTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">
                                            <i class="fas fa-receipt fa-2x mb-2"></i>
                                            <div>No expenses recorded yet.</div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Hawaii Taxes Tab -->
                    <div class="tab-pane fade" id="taxes" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card border-success">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Hawaii GET Tax Summary</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Current Rate (O'ahu):</span>
                                            <span class="fw-bold">4.712%</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>This Month Collected:</span>
                                            <span id="monthlyTaxCollected">$0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Quarter to Date:</span>
                                            <span id="quarterlyTaxCollected">$0.00</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Annual Total:</span>
                                            <span id="annualTaxCollected">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Federal Tax Estimates</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Estimated Federal (22%):</span>
                                            <span id="federalTaxEstimate">$0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Estimated State (8.5%):</span>
                                            <span id="stateTaxEstimate">$0.00</span>
                                        </div>
                                        <hr>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total Tax Liability:</span>
                                            <span id="totalTaxLiability">$0.00</span>
                                        </div>
                                        <small class="text-muted">Estimates based on current revenue</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Record Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-dollar-sign me-2"></i>Record Payment
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paymentForm">
                    <div class="mb-3">
                        <label class="form-label">Invoice</label>
                        <select class="form-select" name="invoice_id" required>
                            <option value="">Select Invoice</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" name="amount" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" name="payment_method" required>
                                    <option value="">Select Method</option>
                                    <option value="cash">Cash</option>
                                    <option value="check">Check</option>
                                    <option value="venmo">Venmo</option>
                                    <option value="zelle">Zelle</option>
                                    <option value="bank_transfer">Bank Transfer</option>
                                    <option value="credit_card">Credit Card</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference/Note</label>
                        <input type="text" class="form-control" name="reference" placeholder="Check number, transaction ID, etc.">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="recordPayment()">
                    <i class="fas fa-save me-1"></i>Record Payment
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function loadFinancialData() {
    // Load invoices data
    fetch('/api/invoices')
        .then(response => response.json())
        .then(invoices => {
            const tbody = document.getElementById('invoicesTableBody');
            if (invoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-file-invoice fa-2x mb-2"></i>
                            <div>No invoices found.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let monthlyRevenue = 0;
            let pendingCount = 0;
            let overdueAmount = 0;
            
            tbody.innerHTML = invoices.map(invoice => {
                const amount = parseFloat(invoice.total_amount || 0);
                const dueDate = new Date(invoice.due_date || '2025-12-31');
                const isOverdue = dueDate < new Date() && invoice.status === 'unpaid';
                
                if (invoice.status === 'paid') {
                    monthlyRevenue += amount;
                } else if (invoice.status === 'unpaid') {
                    pendingCount++;
                    if (isOverdue) {
                        overdueAmount += amount;
                    }
                }
                
                return `
                    <tr>
                        <td>
                            <strong>${invoice.invoice_number}</strong>
                            <div class="text-muted small">${invoice.date_created || 'N/A'}</div>
                        </td>
                        <td>${invoice.client_name}</td>
                        <td>
                            <strong>$${amount.toFixed(2)}</strong>
                            ${invoice.hawaii_tax ? `<div class="text-muted small">+$${parseFloat(invoice.hawaii_tax).toFixed(2)} GET</div>` : ''}
                        </td>
                        <td>
                            <span class="badge bg-${invoice.status === 'paid' ? 'success' : isOverdue ? 'danger' : 'warning'}">
                                ${isOverdue ? 'Overdue' : invoice.status || 'unpaid'}
                            </span>
                        </td>
                        <td>${invoice.due_date || 'N/A'}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="viewInvoice('${invoice.invoice_number}')" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${invoice.status === 'unpaid' ? `
                                <button class="btn btn-outline-success" onclick="markAsPaid('${invoice.invoice_number}')" title="Mark Paid">
                                    <i class="fas fa-check"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update financial overview
            document.getElementById('monthlyRevenue').textContent = `$${monthlyRevenue.toFixed(0)}`;
            document.getElementById('pendingInvoices').textContent = pendingCount;
            document.getElementById('overdueAmount').textContent = `$${overdueAmount.toFixed(0)}`;
            
            // Calculate profit margin (simplified)
            const profitMargin = monthlyRevenue > 0 ? ((monthlyRevenue * 0.3) / monthlyRevenue * 100) : 0;
            document.getElementById('profitMargin').textContent = `${profitMargin.toFixed(1)}%`;
            
            // Update tax calculations
            const hawaiiTax = monthlyRevenue * 0.04712;
            const federalTax = monthlyRevenue * 0.22;
            const stateTax = monthlyRevenue * 0.085;
            
            document.getElementById('monthlyTaxCollected').textContent = `$${hawaiiTax.toFixed(2)}`;
            document.getElementById('quarterlyTaxCollected').textContent = `$${(hawaiiTax * 3).toFixed(2)}`;
            document.getElementById('annualTaxCollected').textContent = `$${(hawaiiTax * 12).toFixed(2)}`;
            document.getElementById('federalTaxEstimate').textContent = `$${federalTax.toFixed(2)}`;
            document.getElementById('stateTaxEstimate').textContent = `$${stateTax.toFixed(2)}`;
            document.getElementById('totalTaxLiability').textContent = `$${(federalTax + stateTax + hawaiiTax).toFixed(2)}`;
        })
        .catch(error => {
            console.error('Error loading financial data:', error);
        });
}

function showPaymentModal() {
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
}

function showExpenseModal() {
    showToast('Expense tracking feature coming soon', 'info');
}

function recordPayment() {
    const form = document.getElementById('paymentForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Implementation for recording payment
    showToast('Payment recorded successfully!', 'success');
    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
    form.reset();
    loadFinancialData();
}

function markAsPaid(invoiceNumber) {
    if (confirm(`Mark invoice ${invoiceNumber} as paid?`)) {
        // Implementation for marking invoice as paid
        showToast(`Invoice ${invoiceNumber} marked as paid`, 'success');
        loadFinancialData();
    }
}

function viewInvoice(invoiceNumber) {
    window.open(`/api/download-invoice/${invoiceNumber}`, '_blank');
}

function generatePLReport() {
    showToast('Generating P&L report...', 'info');
    // Implementation for P&L report generation
}

function exportFinancialData() {
    showToast('Exporting financial data...', 'info');
    // Implementation for data export
}

function refreshInvoices() {
    loadFinancialData();
}

// Load financial data when section is shown
if (typeof loadFinancialData === 'function') {
    loadFinancialData();
}
</script>