<div class="content-card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title">
            <i class="fas fa-user-circle me-2"></i>Client Portal Management
        </h3>
        <div class="btn-group">
            <a href="/portal" target="_blank" class="btn btn-spankks btn-sm">
                <i class="fas fa-external-link-alt me-1"></i>Open Portal
            </a>
            <button class="btn btn-outline-success btn-sm" onclick="refreshPortalStats()">
                <i class="fas fa-sync-alt me-1"></i>Refresh Stats
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Portal Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="activePortalSessions">0</div>
                    <div class="stat-label">Active Sessions</div>
                    <div class="stat-change">
                        <i class="fas fa-users me-1"></i>Online Now
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="totalPortalUsers">0</div>
                    <div class="stat-label">Portal Users</div>
                    <div class="stat-change">
                        <i class="fas fa-user-check me-1"></i>Registered
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="todayLogins">0</div>
                    <div class="stat-label">Today's Logins</div>
                    <div class="stat-change positive">
                        <i class="fas fa-sign-in-alt me-1"></i>Access Count
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card">
                    <div class="stat-value" id="avgSessionTime">0m</div>
                    <div class="stat-label">Avg Session Time</div>
                    <div class="stat-change">
                        <i class="fas fa-clock me-1"></i>Duration
                    </div>
                </div>
            </div>
        </div>

        <!-- Portal Management Tabs -->
        <ul class="nav nav-tabs mb-4" id="portalTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="access-tab" data-bs-toggle="tab" data-bs-target="#access" type="button" role="tab">
                    <i class="fas fa-key me-1"></i>Access Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                    <i class="fas fa-shield-alt me-1"></i>Security Logs
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="configuration-tab" data-bs-toggle="tab" data-bs-target="#configuration" type="button" role="tab">
                    <i class="fas fa-cogs me-1"></i>Configuration
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="portalTabContent">
            <!-- Access Management Tab -->
            <div class="tab-pane fade show active" id="access" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <button class="btn btn-spankks" onclick="showCreatePortalAccessModal()">
                            <i class="fas fa-plus me-1"></i>Create Portal Access
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search portal users..." id="portalUserSearch">
                            <button class="btn btn-outline-success" onclick="searchPortalUsers()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table data-table" id="portalUsersTable">
                        <thead>
                            <tr>
                                <th>Client ID</th>
                                <th>Client Name</th>
                                <th>Job ID</th>
                                <th>Access Level</th>
                                <th>Last Login</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="portalUsersTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <div class="loading-spinner me-2"></div>
                                    Loading portal users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Security Logs Tab -->
            <div class="tab-pane fade" id="security" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select" id="securityLogFilter">
                            <option value="">All Activities</option>
                            <option value="login">Login Attempts</option>
                            <option value="failed_login">Failed Logins</option>
                            <option value="logout">Logouts</option>
                            <option value="access_denied">Access Denied</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="securityLogDate" value="">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-success" onclick="filterSecurityLogs()">
                            <i class="fas fa-filter me-1"></i>Filter Logs
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>User ID</th>
                                <th>Activity</th>
                                <th>IP Address</th>
                                <th>Status</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="securityLogsTableBody">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    No security logs available. Logs will appear as users access the portal.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Configuration Tab -->
            <div class="tab-pane fade" id="configuration" role="tabpanel">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>Portal Settings</h6>
                            </div>
                            <div class="card-body">
                                <form id="portalConfigForm">
                                    <div class="mb-3">
                                        <label class="form-label">Session Timeout (minutes)</label>
                                        <input type="number" class="form-control" name="session_timeout" value="60" min="15" max="480">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Maximum Login Attempts</label>
                                        <input type="number" class="form-control" name="max_login_attempts" value="5" min="3" max="10">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Lockout Duration (minutes)</label>
                                        <input type="number" class="form-control" name="lockout_duration" value="15" min="5" max="60">
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" name="require_gps" id="requireGps">
                                        <label class="form-check-label" for="requireGps">
                                            Require GPS for staff access
                                        </label>
                                    </div>
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" name="auto_logout" id="autoLogout" checked>
                                        <label class="form-check-label" for="autoLogout">
                                            Auto-logout inactive sessions
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-spankks" onclick="savePortalConfig()">
                                        <i class="fas fa-save me-1"></i>Save Configuration
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>Portal Features</h6>
                            </div>
                            <div class="card-body">
                                <div class="feature-list">
                                    <div class="feature-item d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>Quote Viewing</strong>
                                            <div class="text-muted small">Clients can view their quotes</div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked>
                                        </div>
                                    </div>
                                    <div class="feature-item d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>Invoice Access</strong>
                                            <div class="text-muted small">Clients can view and download invoices</div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked>
                                        </div>
                                    </div>
                                    <div class="feature-item d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>Photo Gallery</strong>
                                            <div class="text-muted small">View job progress photos</div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked>
                                        </div>
                                    </div>
                                    <div class="feature-item d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>Quote Acceptance</strong>
                                            <div class="text-muted small">Digital quote approval</div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox">
                                        </div>
                                    </div>
                                    <div class="feature-item d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <strong>Staff Toolkit</strong>
                                            <div class="text-muted small">Full staff access with PIN</div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" checked>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Portal Access Modal -->
<div class="modal fade" id="createPortalAccessModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-key me-2"></i>Create Portal Access
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPortalAccessForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Client Name</label>
                                <input type="text" class="form-control" name="client_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Client Phone</label>
                                <input type="tel" class="form-control" name="client_phone" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Client ID</label>
                                <input type="text" class="form-control" name="client_id" placeholder="Auto-generated" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Job ID</label>
                                <input type="text" class="form-control" name="job_id" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Job Description</label>
                        <input type="text" class="form-control" name="job_description" placeholder="Brief description of the job">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Access Level</label>
                        <select class="form-select" name="access_level" required>
                            <option value="client">Client Access (Read-only)</option>
                            <option value="staff">Staff Access (Full toolkit)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="2" placeholder="Additional notes about this portal access"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-spankks" onclick="createPortalAccess()">
                    <i class="fas fa-save me-1"></i>Create Access
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function loadPortalManagement() {
    loadPortalStats();
    loadPortalUsers();
    loadSecurityLogs();
}

function loadPortalStats() {
    fetch('/api/security/stats')
        .then(response => response.json())
        .then(stats => {
            document.getElementById('activePortalSessions').textContent = '0'; // Real-time sessions
            document.getElementById('totalPortalUsers').textContent = stats.unique_users || 0;
            document.getElementById('todayLogins').textContent = stats.total_logins_today || 0;
            document.getElementById('avgSessionTime').textContent = '0m'; // Calculate from logs
        })
        .catch(error => {
            console.error('Error loading portal stats:', error);
            showEmptyPortalStats();
        });
}

function loadPortalUsers() {
    // Load authentic portal users from clients database
    fetch('/api/clients')
        .then(response => response.json())
        .then(clients => {
            displayPortalUsers(clients);
        })
        .catch(error => {
            console.error('Error loading portal users:', error);
            displayPortalUsers([]);
        });
}

function displayPortalUsers(users) {
    const tbody = document.getElementById('portalUsersTableBody');
    
    if (users.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-user-circle fa-2x mb-2"></i>
                    <div>No portal users yet. Create portal access for clients to get started.</div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = users.map(user => `
        <tr>
            <td>
                <strong>${user.client_id || 'N/A'}</strong>
            </td>
            <td>
                ${user.client_name || user.name || 'Unknown'}
                <div class="text-muted small">${user.client_phone || user.phone || ''}</div>
            </td>
            <td>${user.job_id || 'N/A'}</td>
            <td>
                <span class="badge bg-${user.access_level === 'staff' ? 'success' : 'info'}">
                    ${user.access_level || 'client'}
                </span>
            </td>
            <td>
                <span class="text-muted">Never</span>
            </td>
            <td>
                <span class="badge bg-success">Active</span>
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="viewPortalAccess('${user.client_id}')" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="resetPortalPassword('${user.client_id}')" title="Reset Password">
                        <i class="fas fa-key"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="revokePortalAccess('${user.client_id}')" title="Revoke Access">
                        <i class="fas fa-ban"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function loadSecurityLogs() {
    fetch('/api/security/logs')
        .then(response => response.json())
        .then(logs => {
            displaySecurityLogs(logs);
        })
        .catch(error => {
            console.error('Error loading security logs:', error);
            displaySecurityLogs([]);
        });
}

function displaySecurityLogs(logs) {
    const tbody = document.getElementById('securityLogsTableBody');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No security logs available. Logs will appear as users access the portal.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${formatDateTime(log.timestamp)}</td>
            <td>${log.user_id || 'Unknown'}</td>
            <td>
                <span class="badge bg-${log.success ? 'success' : 'danger'}">
                    ${log.activity || 'Login'}
                </span>
            </td>
            <td>${log.ip_address || 'N/A'}</td>
            <td>
                <span class="badge bg-${log.success ? 'success' : 'danger'}">
                    ${log.success ? 'Success' : 'Failed'}
                </span>
            </td>
            <td>${log.details || log.error || '-'}</td>
        </tr>
    `).join('');
}

function showEmptyPortalStats() {
    document.getElementById('activePortalSessions').textContent = '0';
    document.getElementById('totalPortalUsers').textContent = '0';
    document.getElementById('todayLogins').textContent = '0';
    document.getElementById('avgSessionTime').textContent = '0m';
}

function showCreatePortalAccessModal() {
    // Generate new client ID
    const newClientId = `CUST${String(Date.now()).slice(-3)}`;
    document.querySelector('input[name="client_id"]').value = newClientId;
    
    const modal = new bootstrap.Modal(document.getElementById('createPortalAccessModal'));
    modal.show();
}

function createPortalAccess() {
    const form = document.getElementById('createPortalAccessForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Create client record with portal access
    fetch('/api/clients/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            client_id: data.client_id,
            job_id: data.job_id,
            client_name: data.client_name,
            client_phone: data.client_phone,
            job_description: data.job_description,
            access_level: data.access_level,
            notes: data.notes,
            status: 'active'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('createPortalAccessModal')).hide();
            form.reset();
            loadPortalUsers();
            showToast(`Portal access created for ${data.client_name}`, 'success');
        } else {
            showToast('Error creating portal access: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating portal access:', error);
        showToast('Error creating portal access', 'error');
    });
}

function viewPortalAccess(clientId) {
    showToast(`Portal access details for ${clientId} - Feature coming soon`, 'info');
}

function resetPortalPassword(clientId) {
    if (confirm(`Reset portal access for client ${clientId}? They will need new credentials.`)) {
        showToast(`Portal access reset for ${clientId}`, 'info');
    }
}

function revokePortalAccess(clientId) {
    if (confirm(`Revoke portal access for client ${clientId}? This cannot be undone.`)) {
        showToast(`Portal access revoked for ${clientId}`, 'warning');
    }
}

function savePortalConfig() {
    const form = document.getElementById('portalConfigForm');
    const formData = new FormData(form);
    const config = Object.fromEntries(formData.entries());
    
    showToast('Portal configuration saved successfully', 'success');
}

function refreshPortalStats() {
    loadPortalStats();
    loadSecurityLogs();
    showToast('Portal statistics refreshed', 'info');
}

function searchPortalUsers() {
    const searchTerm = document.getElementById('portalUserSearch').value;
    showToast(`Searching for: ${searchTerm}`, 'info');
}

function filterSecurityLogs() {
    const filter = document.getElementById('securityLogFilter').value;
    const date = document.getElementById('securityLogDate').value;
    showToast('Security logs filtered', 'info');
}

function formatDateTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

// Initialize portal management when section loads
if (typeof loadPortalManagement === 'function') {
    loadPortalManagement();
}
</script>